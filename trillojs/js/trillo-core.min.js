/*!
 * TrilloJS v0.5.0 (https://github.com/trillo/trillojs#readme)
 * Copyright 2016 Collager Inc.
 * Licensed under the MIT license
 */
Trillo={appLocation:"",OBJ_LOCKED:3,TrilloApp:{},appNamespace:null,isTouchSurface:!1},Trillo.AppInitializer=Class.extend({WIDTH_A:800,WIDTH_B:720,WIDTH_C:640,WIDTH_D:480,WIDTH_E:320,initialize:function(){},initApp:function(a){this.cb=a,this.createAlertComponent(),this.createLogComponent(),this.createSearchHandler(),this.createBuilder(),this.createViewManager(),this.createChartManager(),this.createModelFactory(),this.createObserverFactory(),this.createPage(),this.createRouter(),this.createTitleBarManager(),this.createContextMenuManager(),this.doCallback()},doCallback:function(){this.cb()},createAlertComponent:function(){Trillo.Alert&&(Trillo.alert=new Trillo.Alert)},createLogComponent:function(){Trillo.Log&&(Trillo.log=new Trillo.Log)},createSearchHandler:function(){Trillo.SearchHandler&&(Trillo.searchHandler=new Trillo.SearchHandler)},createViewManager:function(){Trillo.ViewManager&&(Trillo.viewManager=new Trillo.ViewManager)},createChartManager:function(){Trillo.ChartManager&&(Trillo.chartManager=new Trillo.ChartManager)},createBuilder:function(){Trillo.Builder&&(Trillo.builder=new Trillo.Builder)},createModelFactory:function(){Trillo.ModelFactory&&(Trillo.modelFactory=new Trillo.ModelFactory)},createObserverFactory:function(){Trillo.ObserverFactory&&(Trillo.observerFactory=new Trillo.ObserverFactory)},createPage:function(){Trillo.Page&&(Trillo.page=new Trillo.Page)},createRouter:function(){Trillo.Router&&(Trillo.router=new Trillo.Router)},createTitleBarManager:function(){Trillo.TitleBarManager&&(Trillo.titleBarManager=new Trillo.TitleBarManager)},createContextMenuManager:function(){Trillo.ContextMenuManager&&(Trillo.contextMenuManager=new Trillo.ContextMenuManager)}}),Trillo.Options={V_MARGIN_TOP_ROW:10,V_MARGIN:20,H_MARGIN:20,BOTTOM_SPACE_FOR_INF_SCROLL:60,OPEN_ALL:"openAll",CLOSE_ALL:"closeAll",SCROLL_ON_HOVER:"scrollOnHover",AUTO_SCROLL:"autoScroll",SMOOTH_SCROLL:"smoothScroll",NO_SCROLL:"noScroll"},Trillo.Config={viewFileExtension:"",viewPath:null,basePath:null},Trillo.HtmlTemplates={titleBarTitlePrefix:'<li nm="{{viewName}}-title-prefix">{{titlePrefix}}</li>',titleBarTitle:'<li nm="{{viewName}}-title">{{title}}</li>',dropdownListItem:'<li><a class="js-list-item" nm="{{uid}}" href="#">{{name}}</a></li>'},Trillo.CSS={alertDanger:"alert-danger",alertSuccess:"alert-success",pointed:"trillo-pointed",hasErrorCss:"trillo-has-error",hasMessageCss:"trillo-has-message",positionOutside:"trillo-position-outside",selected:"trillo-selected",appRready:"trillo-app-ready",tabActive:"active",treeItemTn:"trillo-tree-item-tn",tnLabel:"trillo-tn-label",treeNode:"tree-node",treeNodeLevelPrefix:"lvl",treeItem:"trillo-tree-item",itemClose:"trillo-item-close",itemOpen:"trillo-item-open",containerPreviewMode:"trillo-container-preview-mode",containerMark:"trillo-container-mark",buttonGroup:"btn-group",dropdown:"dropdown",buttonGroupOpen:"open",dropdownOpen:"open",fieldMsg:"trillo-field-msg"},Trillo.getAllClasses=function(a,b){var c=a.attr("class");return c?b&&(c=c.replace(b,"")):c="",c},Trillo.getRefByQualifiedName=function(a){for(var b=a.split("."),c=b.length,d=0,e=window;e&&c>d;)e=e[b[d++]];return e},Trillo.KeyValue=Class.extend({initialize:function(){this.l=[]},add:function(a,b){this.l.push({k:a,v:b})},getValue:function(a){for(var b=this.l,c=0;c<b.length;c++)if(b[c].k===a)return b[c].v;return null}}),Trillo.uidToClass=function(a){var b,c=null;return a&&(b=a.indexOf("."),b>0&&(c=a.substring(0,b))),c},Trillo.uidToId=function(a){var b,c=null;return a&&(b=a.indexOf("."),b>0&&(c=a.substring(b+1))),c},Trillo.isUid=function(a){if(a){var b=a.indexOf(".");return b>0}return!1},Trillo.offsetByFixedAbsolute=function(a){var b,c=0;a.prevAll().each(function(){b=$(this).css("position"),("fixed"===b||"absolute"===b)&&(c+=$(this).outerHeight())}),a.css("margin-top",c)},Trillo.showBusy=function(){$(".js-busy-indicator").show().css("visibility","visible")},Trillo.hideBusy=function(){$(".js-busy-indicator").css("visibility","hidden")},Trillo.elemId=0,Trillo.getUniqueElemId=function(){return this.elemId++,"_trillo_e_"+this.elemId},Trillo.getObjectValue=function(a,b){if(b&&0!==b.length)for(var c=b.split("."),d=0;d<c.length&&(a=a[c[d]],a);d++);return void 0===a||null===a?null:a},Trillo.setObjectValue=function(a,b,c){for(var d=b.split("."),e=a,f=0;f<d.length-1;f++)e=a[d[f]],e||(e={},a[d[f]]=e),a=e;b=d[d.length-1],a[b]=c},Trillo.mergeObject=function(a,b,c){for(var d=b.split("."),e=a,f=0;f<d.length-1;f++)""!==d[f]&&(e=a[d[f]],e||(e={},a[d[f]]=e),a=e);b=d[d.length-1],""===b?$.extend(a,c):a[b]=c},Trillo.formatValue=function(a,b,c){if(!b||""===b)return c?"":"&nbsp;";var d=a.attr("display-type");if(d){if("date"===d)return this.formatDate(a,b);if("enum"===d||"css-class"===d)return this.getEnumName(a,b)}return b},Trillo.formatDate=function(a,b){var c=a.attr("format")||"M/D/YY hh:mm:ss A";return moment(b).format(c)},Trillo.getEnumName=function(a,b){var c=a.attr("enum-name");return Trillo.enumCatalog.getName(c,b)},Trillo.setCookieValue=function(a,b,c){var d=new Date;d.setDate(d.getDate()+c);var e=escape(b)+";expires="+d.toGMTString(),f=this.getCookieDomain();f&&(e+=";domain="+f),document.cookie=a+"="+e},Trillo.getCookieValue=function(a){a+="=";var b=document.cookie.indexOf(a);if(b>=0){var c=document.cookie.substring(b+a.length);return b=c.indexOf(";"),0>b&&(b=c.length),c=c.substring(0,b),unescape(c)}return""},Trillo.deleteCookie=function(a){""!==Trillo.getCookieValue(a)&&(document.cookie=a+"=;expires=Thu, 01-Jan-1970 00:00:01 GMT")},Trillo.getCookieDomain=function(){var a=document.domain;if(!a||""===a)return null;var b=null,c=a.lastIndexOf(".");if(c>0){var d=a.substring(0,c),e=a.substring(c);c=d.lastIndexOf("."),c>=0?(d=d.substring(c),b=d+e):b="."+d+e}return b},Trillo.matches=function(a,b,c){var d;for(d in a)if("undefined"==typeof b[d])return!1;for(d in a)if(a[d])switch(typeof a[d]){case"object":if(c){if(!Trillo.matches(a[d],b[d]))return!1}else if(a[d]!==b[d])return!1;break;case"function":break;default:if(a[d]!==b[d])return!1}else if(b[d])return!1;for(d in b)if("undefined"==typeof a[d])return!1;return!0},Trillo.isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},Trillo.replacer=function(a,b){return 0===a.indexOf("_trillo_")?void 0:b},Trillo.stringify=function(a){return JSON.stringify(a,Trillo.replacer)},Trillo.getSpecObject=function(a,b){var c=a.find(b);if(0===c.length)return null;var d={};return c.each(function(){var a=$(this),b=a.html();if(b&&b.length)try{$.extend(d,$.parseJSON(b))}catch(c){Trillo.log.error("Failed to parse view spec JSON: "+c.message+"<br/>"+b)}}),c.remove(),d},Trillo.getNearestInDOMTree=function(a,b){for(var c=a.find(b);0===c.length&&a.length&&"html"!==(a.prop("nodeName")||"").toLowerCase();)a=a.parent(),c=a.find(b);return c},Trillo.EnumCatalog=Class.extend({initialize:function(){this.table={}},register:function(a,b){this.table[a]=b},getEnum:function(a){return this.table[a]},getName:function(a,b){if(!a)return b;var c=this.table[a];if(!c)return b;for(var d=0;d<c.length;d++)if(c[d].v===b)return c[d].n;return b},getValue:function(a,b){var c=this.table[a];if(!c)return null;for(var d=0;d<c.length;d++)if(c[d].n===b)return c[d].v;return null},registerAll:function(a){var b=this;$.each(a,function(a,c){b.register(a,c)})}}),Trillo.enumCatalog=new Trillo.EnumCatalog,$(function(){$.ajaxSetup({cache:!1}),$(document).ajaxStart(function(){Trillo.alert.clear(),Trillo.showBusy()}).ajaxSend(function(a,b,c){}).ajaxError(function(a,b,c){try{var d=$.parseJSON(b.responseText);if(d.redirectUrl)return void("/login"===d.redirectUrl?window.location.reload(!0):window.location.href=d.redirectUrl);if(c.error)return;var e=d.message||d.detail;e&&Trillo.log.error(e)}catch(f){if(c.error)return;Trillo.log.error(f.message)}}).ajaxSuccess(function(a,b,c){}).ajaxComplete(function(a,b,c){}).ajaxStop(function(){Trillo.hideBusy()})}),Trillo.Log=Class.extend({initialize:function(){},error:function(a){Trillo.alert.showError("Error",a)},warning:function(a){Trillo.alert.showError("Warning",a)},info:function(a){Trillo.alert.show("Info",a)}}),Trillo.Alert=Class.extend({initialize:function(){this.$e=$(".js-alert"),this.$t=this.$e.find(".js-title"),this.$m=this.$e.find(".js-message"),this.fo=$.proxy(this.fadeOut,this),this.$e.find('[nm="close"]').on("click",$.proxy(this.doAction,this))},show:function(a,b,c,d){this.$e.removeClass(Trillo.CSS.alertDanger).addClass(Trillo.CSS.alertSuccess),this._show(a,b,c,d)},showError:function(a,b,c,d){this.$e.removeClass(Trillo.CSS.alertSuccess).addClass(Trillo.CSS.alertDanger),this._show(a,b,c,d)},_show:function(a,b,c,d){this.$e.finish(),d?this.$e.css("left",d.offset().left+Math.floor(d.width()/2)):this.$e.css("left",0),this.$t.html(a),b=b.replace(/(?:\r\n|\r|\n)/g,"<br />"),this.$m.html(b),this.$e.hide(),this.$e.fadeIn(1e3,c?this.fo:null)},fadeOut:function(a){this.$e.fadeOut(8e3)},doAction:function(a){if(a){a.stopPropagation();var b=$(a.target).attr("nm");"close"===b&&this.clear()}},clear:function(a){this.$e.finish(),this.$e.hide()},notYetImplemented:function(a){this.showError("Not Implemented","Action '"+a+"' is not yet implemented",!0)}}),Trillo.Modal=Class.extend({initialize:function(a){var b=this.$e=$(".js-modal");this.$t=b.find('[nm="modalTitle"]'),this.$m=b.find('[nm="modalMessage"]'),this.$close=b.find('[nm="modalClose"]'),this.$ok=b.find('[nm="modalOK"]'),this.$no=b.find('[nm="modalNo"]'),this.$yes=b.find('[nm="modalYes"]'),b.find("button").on("click",$.proxy(this.doAction,this))},doAction:function(a){var b=$(a.target),c=b.attr("nm"),d=this.options;switch(c){case"modalOK":this.hide(),d.ok&&d.ok(d)}},show:function(a,b,c){c=c||{},this.options=c,this.$t.html(a),this.$m.html(b),c.ok?this.$ok.show():this.$ok.hide(),c.yes?this.$yes.show():this.$yes.hide(),c.no?this.$no.show():this.$no.hide(),this.$e.modal("show")},hide:function(){this.$e.modal("hide")}}),Trillo.showModal=function(a,b,c){Trillo._modal||(Trillo._modal=new Trillo.Modal),Trillo._modal.show(a,b,c)},Trillo.hideModal=function(a,b,c){Trillo._modal&&Trillo._modal.hide()},Trillo.Router=Class.extend({initialize:function(){this.handler=$.proxy(this.historyChanged,this),this.busyProcessing=!1,this.viewsMarkedForClearing=[],this.isHistoryOn=!1,this.initialRoute=null,this.defaultRoute=null},start:function(){var a=(location.pathname||"")+(location.search||"");this.initialRoute=a,this.routeTo(a)},setHistoryOn:function(){$.history.on("load change",this.handler).listen()},historyChanged:function(a,b,c){b&&!this.busyProcessing&&(b===this.initialRoute&&(b=this.defaultRoute),this.routeTo(b))},routeTo:function(a,b){if(!this.busyProcessing){this.busyProcessing=!0;var c=this;a=this.normalizeRoute(a);var d=Trillo.page.show(a);d.done(function(a){if(a&&a.length>0){var d=a[a.length-1].controller().getRouteUpTo();c.isHistoryOn?b&&$.history.push(d):c.defaultRoute!=d&&(c.defaultRoute=d,window.history.replaceState({},null,d))}c.clearMarkedForClearing(),c.isHistoryOn||(c.isHistoryOn=!0,c.setHistoryOn()),c.busyProcessing=!1}),d.fail(function(a){c.clearMarkedForClearing(),c.busyProcessing=!1})}},markForClearing:function(a){this.viewsMarkedForClearing.push(a)},clearMarkedForClearing:function(a){var b=this.viewsMarkedForClearing;if(b.length>0){for(var c=b.length-1;c>=0;c--)b[c].clear();b.length=0,Trillo.page.windowResized()}},showingView:function(a){for(var b=this.viewsMarkedForClearing,c=0;c<b.length;c++)if(a.viewSpec.container&&b[c].viewSpec.container===a.viewSpec.container)return b[c].clear(),void b.splice(c,1)},normalizeRoute:function(a){if(!a)return a;var b=Trillo.Config.basePath;return 0===a.indexOf(b)&&(a=a.substring(b.length)),0===a.indexOf("/")&&(a=a.substring(1)),a}}),Trillo.ModelFactory=Class.extend({initialize:function(a){},createModel:function(a,b){a=$.extend({},a);var c;if(c=this.createModelForName(a,b),!c){var d=Trillo.appNamespace;c=this.createModelForNS(d,a,b),c||(c=this.createModelForNS(window.Shared,a,b)),c||(a.impl&&Trillo.log.warning("Model class '"+a.impl+"' not found, using default Model."),c=new Trillo.Model(a,b))}return c},createModelForName:function(a,b){var c=a.impl;if(c){var d=Trillo.getRefByQualifiedName(c);if(d)return new d(a,b)}return null},createModelForNS:function(a,b,c){var d=b.impl;if(d){if(a&&a[d])return new a[d](b,c);var e=Trillo.getRefByQualifiedName(d);if(e)return new e(b,c)}return null}}),Trillo.Model=Class.extend({initialize:function(a,b){this.modelSpec=a,this._view=b,this._controller=b.controller(),this.observer=null,this.table={},this.data=a._newData||a.data,this.newItemsAtEnd=a.newItemsAtEnd,this.parentData=a.parentData,this.dataPath=a.dataPath||"",this.listners=[],a.observeChanges&&this.addListener(b)},view:function(){return this._view},controller:function(){return this._controller},clear:function(){this.clearObserver(),this.table={}},isModelChanged:function(a){return!Trillo.matches(a,this.modelSpec)||a.data&&a.data!==this.data||a._newData},setValue:function(a,b){Trillo.setObjectValue(this.data,a,b),this.triggerChanged(this.data)},getValue:function(a){return Trillo.getObjectValue(this.data,a)},getObj:function(a){if(this.data)if(this.data instanceof Array){for(var b=this.data,c=0;c<b.lenngth;c++)if(b[c].uid===a)return b[c]}else if(this.data.uid===a)return this.data;return null},loadData:function(){var a=$.Deferred();return this.data?(a.resolve(this),a.promise()):(this.parentData?this.data=Trillo.getObjectValue(this.parentData,this.dataPath):this.data||(this.data={}),a.resolve(this),a.promise())},loadTestData:function(a){var b=$.Deferred(),c=this;return a?$.ajax({url:"/model/loadTestData?viewName="+a+"&appName="+Trillo.appName,type:"get"}).done($.proxy(this.dataLoaded,this,b)):(this.data={},b.resolve(c)),b.promise()},loadChartTestData:function(a){var b=$.Deferred(),c=this;return a?$.ajax({url:"/model/loadChartTestData?chartName="+a+"&appName="+Trillo.appName,type:"get"}).done($.proxy(this.dataLoaded,this,b)):(this.data={},b.resolve(c)),b.promise()},dataLoaded:function(a,b){this.data=b,this.controller().modelLoaded(this),a.resolve(this)},addListener:function(a){this.hasListener(a)||this.listners.push(a)},removeListener:function(a){for(var b=this.listners,c=b.length,d=0;c>d;d++)if(b[d]===a)return this.listners.splice(d,1),!0;return!1},hasListener:function(a){for(var b=this.listners,c=b.length,d=0;c>d;d++)if(b[d]===a)return!0;return!1},triggerAdded:function(a){for(var b=this.listners,c=b.length,d=0;c>d;d++)b[d].objAdded&&b[d].objAdded(a,this.newItemsAtEnd)},triggerChanged:function(a){for(var b=this.listners,c=b.length,d=0;c>d;d++)b[d].objChanged&&b[d].objChanged(a)},triggerDeleted:function(a){for(var b=this.listners,c=b.length,d=0;c>d;d++)b[d].objDeleted&&b[d].objDeleted(a)},processObjAdded:function(a){},processObjDeleted:function(a){},createObserver:function(){if(this.listners.length>0&&!this.observer){var a=this.getObserverOptions();null!==a&&(a.cb=$.proxy(this.receivedNotifications,this),this.observer=Trillo.observerFactory.createObserver(a))}},getObserverOptions:function(){return null},clearObserver:function(){this.observer&&(this.observer.clear(),this.observer=null),this.table={}},receivedNotifications:function(a){var b,c=this.table;b=c[a.uid],a._deleted_?b&&(this.processObjDeleted(b),this.triggerDeleted(b)):b?($.extend(b,a),this.triggerChanged(b)):(this.processObjAdded(a),this.triggerAdded(a))},doSort:function(a,b){function c(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}debug.debug("Sort by: "+a),this.data instanceof Array&&("asc"===b?this.data.sort(function(a,b){return c(a,b)}):this.data.reverse(function(a,b){return c(a,b)}))}}),Trillo.ObserverFactory=Class.extend({initialize:function(a){this.observerClass=Trillo.Observer},createObserver:function(a){return new this.observerClass(a)}}),Trillo.BaseObserver=Class.extend({initialize:function(a){this.options=a},clear:function(){},receivedNotifications:function(a){this.options.cb(a)}}),Trillo.Observer=Trillo.BaseObserver.extend({initialize:function(a){this._super(a),this.start()},start:function(){if(Trillo.appContext.webSocketEndPoint&&Trillo.appContext.webSocketDestination){var a=this;if(!a.subscribed){var b=this.options;$.ajax({url:"/subscribe?"+(b.uid?"uid="+b.uid:"cls="+b.cls),type:"get"}).done(function(){a.subscribed=!0,!Trillo.webSocket&&Trillo.WebSocket&&Trillo.appContext.loggedIn&&(Trillo.webSocket=new Trillo.WebSocket),Trillo.webSocket.addObserver(a)})}}},clear:function(){var a=this;if(Trillo.webSocket&&Trillo.webSocket.removeObserver(a),a.subscribed){a.subscribed=!1;var b=this.options;$.ajax({url:"/unsubscribe?"+(b.uid?"uid="+b.uid:"cls="+b.cls),type:"get"}).done(function(){})}}}),Trillo.WebSocket=Class.extend({initialize:function(a){if(this.observers=[],"undefined"!=typeof SockJS&&"undefined"!=typeof Stomp&&Trillo.appContext.webSocketEndPoint&&Trillo.appContext.webSocketDestination)try{var b=new SockJS(Trillo.appContext.webSocketEndPoint);this.stompClient=Stomp.over(b),this.stompClient.debug=null,this.connect()}catch(c){}},connect:function(){if(this.stompClient){var a=this;this.stompClient.connect({},function(b){a.stompClient.subscribe(Trillo.appContext.webSocketDestination,$.proxy(a.received,a))})}},disconnect:function(){this.stompClient&&this.stompClient.disconnect()},received:function(a){var b=JSON.parse(a.body),c=this.observers,d=c.length,e=b.uid;if(e){var f=e.indexOf("."),g="";f>0&&(g=e.substring(0,f));for(var h=0;d>h;h++)(c[h].options.cls===g||c[h].options.uid===e)&&c[h].receivedNotifications(b)}},ping:function(){if(this.stompClient){var a={};a.className="test",this.stompClient.send("/app/pingWS",{},Trillo.stringify(a))}},addObserver:function(a){this.hasObserver(a)||this.observers.push(a)},removeObserver:function(a){for(var b=this.observers,c=b.length,d=0;c>d;d++)if(b[d]===a)return this.observers.splice(d,1),!0;return!1},hasObserver:function(a){for(var b=this.observers,c=b.length,d=0;c>d;d++)if(b[d]===a)return!0;return!1}}),Trillo.ViewType={Tree:"tree",Collection:"collection",Table:"table",Grid:"grid",EditableTable:"editableTable",Selector:"selector",Form:"form",Detail:"detail",Chart:"chart",Custom:"custom",Content:"content",Tab:"tab",Dropdown:"dropdown",Nav:"nav",Default:"default",Toc:"toc"},Trillo.ImplClassByViewType={"default":"Trillo.View",tree:"Trillo.TreeView",nav:"Trillo.NavView",collection:"Trillo.CollectionView",table:"Trillo.CollectionView",grid:"Trillo.CollectionView",selector:"Trillo.SelectorView",form:"Trillo.FormView",detail:"Trillo.DetailView",chart:"Trillo.ChartView",tab:"Trillo.TabView",dropdown:"Trillo.DropdownView",editableTable:"Trillo.EditableTableView",toc:"Trillo.TocView",content:"Trillo.ContentView"},Trillo.isValidViewType=function(a){for(var b in Trillo.ViewType)if(a===Trillo.ViewType[b])return!0;return!1},Trillo.isCollectionView=function(a){return a===Trillo.ViewType.Collection||a===Trillo.ViewType.Table||a===Trillo.ViewType.Grid},Trillo.isTreeView=function(a){return a===Trillo.ViewType.Tree},Trillo.isDetailView=function(a){return a===Trillo.ViewType.Detail},Trillo.isFormView=function(a){return a===Trillo.ViewType.Form},Trillo.findAndSelf=function(a,b){var c=a.is(b);return c?a:a.find(b)},Trillo.convertToPage=function(a){if(a=a||[],a.items&&"undefined"!=typeof a.items.length)return a;"undefined"==typeof a.length&&(a=[a]);var b={};return b.items=a,b.pageSize=a.length,b.numberOfPages=1,b.totalNumberOfItems=b.pageSize,b.pageNumber=1,b},Trillo.listFromPage=function(a){return a=a||[],a.items&&"undefined"!=typeof a.items.length?a.items:("undefined"==typeof a.length&&(a=[a]),a)},Trillo.setFieldsValue=function(a,b){a.find(".js-field-value").each(function(a){var c,d,e;d=$(this),c=d.attr("nm"),c&&(e=Trillo.getObjectValue(b,c),Trillo.setFieldValue(d,e,!1))})},Trillo.setFieldValue=function(a,b,c){var d,e,f,g;g=a.prop("tagName").toLowerCase(),d=a.attr("nm"),e=a.attr("type"),"radio"===e||"checkbox"===e?(a.prop("checked",b),c&&a.attr("disabled","true")):"input"===g||"textarea"===g||"select"===g?(a.val(b),a.parent().find(".js-readonly-value").remove(),c?(a.hide(),"select"===g&&(b=a.find("option:selected").text()),a.after('<span class="js-readonly-value">'+b+"</span>")):a.show()):"img"===g?a.attr("src",b):(b=Trillo.formatValue(a,b),f=a.attr("display-type"),"css-class"===f?a.addClass(b):a.html("undefined"==typeof b?"":""+b))},Trillo.resizeAllTextArea=function(a){var b=a.find("textarea");b.length&&autosize.update(b)},Trillo.timeTickFormat={format:function(a){return moment(a).format("M/D H:m")},fit:!0,culling:{max:2}},Trillo.setSelectOptions=function(a,b,c,d,e){var f,g,h="",i=0;d?$.each(b,function(){g=this[d],f=c?this[c]:this.toString(),null===e&&(e=g),h+='<option value="'+g+'">'+f+"</option>"}):$.each(b,function(){f=c?this[c]:this.toString(),null===e&&(e=i),h+='<option value="'+i+'">'+f+"</option>",i++}),a.html(h),a.val(e)},Trillo.isCheckxoxOrRadio=function(a){return a.is(":checkbox")||a.is(":radio")},Trillo.isButton=function(a){return a.is(":button")||a.is(":reset")||a.is(":reset")},Trillo.getInputs=function(a){return a.find("input, textarea, select").not(":input[type=button], :input[type=submit], :input[type=reset]")},Trillo.getFieldValue=function(a){switch(a.attr("type")){case"radio":case"checkbox":return a.prop("checked")?!0:!1;default:return a.val()}},Trillo.ViewManager=Class.extend({viewTable:{},initialize:function(a){},loadView:function(a){var b=$.Deferred(),c=this.viewTable[a];return c?this.processView(b,c.html,c.hasTemplateTag):$.ajax({url:Trillo.Config.viewPath+a+Trillo.Config.viewFileExtension,type:"get",datatype:Trillo.appContext.isTrilloServer?"application/json":"text/plain"}).done($.proxy(this.viewLoaded,this,b,a)),b.promise()},viewLoaded:function(a,b,c){var d,e,f;if(Trillo.appContext.isTrilloServer){if("failed"===c.status)return Trillo.log.error(c.message||c.status),void a.reject({errorMsg:c.message||c.status,viewName:b});d=c.message||""}else d=c;e=d.indexOf("{{")>=0,f=this.viewTable[b]={html:d,hasTemplateTag:e},this.processView(a,f.html,f.hasTemplateTag)},processView:function(a,b,c){var d=$("<div></div>");d.html(b);var e=Trillo.getSpecObject(d,"script[spec='view']"),f=$(d.children()[0]);f.detach(),a.resolve({$e:f,viewSpecs:e,hasTemplateTag:c})}}),Trillo.ChartManager=Class.extend({chartTable:{},initialize:function(a){},getChartList:function(a){for(var b,c,d=$.Deferred(),e="",f=[],g=0;g<a.length;g++)c=a[g],b=this.chartTable[c],b?f.push(b):e+=(""===e?"":",")+c;return f.length===a.length?d.resolve(f):$.ajax({url:"/model/chartList/?chartNames="+e+"&appName="+Trillo.appName,type:"get",datatype:"application/json"}).done($.proxy(this.chartsLoaded,this,d,a)),d.promise()},chartsLoaded:function(a,b,c){var d;for(d=0;d<c.length;d++)this.chartTable[c[d].name]=$.parseJSON(c[d].content);var e,f,g=[];for(d=0;d<b.length;d++)f=b[d],e=this.chartTable[f],e&&g.push(e);a.resolve(g)}}),Trillo.Builder=Class.extend({initialize:function(a){this.options=a,this.navHistory={},this.paramsHistory={}},buildAppView:function(){var a=$("body"),b=$(".js-application");0===b.length&&(b=a);var c=this.udpdateViewSpecs(a,Trillo.appName,null,a.html().indexOf("{{")>0);c?Trillo.appName&&""!==Trillo.appName||(Trillo.appName=c.name,Trillo.appNamespace||(Trillo.appNamespace=window[Trillo.appName])):c={},c=$.extend({},c),c.isAppView=!0,c.modelSpec||(c.modelSpec={}),c.modelSpec.data=Trillo.appContext;var d=$.Deferred(),e=this;if(c){var f=this.initMvc(b,c);f.done(function(a){e.processEmbeddedViews([a],d)}),f.fail(function(a){d.reject(a)})}else d.reject();return d.promise()},build:function(a,b){var c=this.getRouteSpecsFromRoute(a),d=$.Deferred();return this._build(0,c,b,d,[],""),d.promise()},_build:function(a,b,c,d,e,f){if(a>=b.length)return void d.resolve(e);var g=c?c.nextView():null,h=b[a];g&&g.name!==h.name&&(g.markForClearing(),g=null);var i;if(g?(g.internalRoute="",i=g.viewSpec):(i=c.getNextViewSpec(h.name),i||(i={name:h.name})),$.isEmptyObject(h.params)){var j=this.paramsHistory[f+"/"+h.name];j&&(h.params=j)}this.navHistory[f]=h,this.paramsHistory[f+"/"+h.name]=h.params,i.params=h.params;var k=this.init(i,g,c),l=this;k.done(function(c){g=c;var i,j;e.push(c);var k=c.doInternalRouting(b,a+1);if(k>0){var m=a+1+k;if(m>b.length&&(m=b.length),m>a+1){for(j=a+1;m>j;j++)f=f+"/"+b[j].name;a=m-1}}if(a+1<b.length&&c.viewSpec.type===Trillo.ViewType.Tree&&(i=c.getNextViewName(),i&&(i=i.split("/")[0],b[a+1].name!==i&&(b.length=a+1))),a+1===b.length&&!Trillo.isPreview){var n=l.navHistory[f+"/"+h.name];if(i=c.getNextViewName(n)){var o=i.split("/");for(j=0;j<o.length;j++)b.push({name:o[j],params:{}})}}a+1<b.length?(c.routingToNextView(b,a+1),l._build(a+1,b,g,d,e,f+"/"+h.name)):(g.nextView()&&g.nextView().markForClearing(),l.processEmbeddedViews(e,d))}),k.fail(function(a){d.reject(a)})},processEmbeddedViews:function(a,b){for(var c,d,e=a,f=[],g=0,h=e.length;h>g;g++)if(c=e[g],d=c.viewSpec.embeddedSpecs,d&&d.length)for(var i=0;i<d.length;i++)f.push({parentView:c,viewSpec:d[i]});this.buildEmbeddedViews(f,0,a,b).done(function(){b.resolve(a)})},buildEmbeddedViews:function(a,b,c,d){var e=$.Deferred();if(b>=a.length)return e.resolve(),e.promise();var f=a[b],g=f.viewSpec;g.prevView=f.parentView;var h=this.init(g,g.view,f.parentView),i=this;return h.done(function(f){var g=f.viewSpec.embeddedSpecs;if(g&&g.length)for(var j=0;j<g.length;j++)a.push({parentView:f,viewSpec:g[j]});h=i.buildEmbeddedViews(a,b+1,c,d),h.done(function(){e.resolve()})}),h.fail(function(a){d.reject(a)}),e.promise()},init:function(a,b,c){var d,e;if(!b)if(a.viewHtml)e=$("<div></div>"),e.html(a.viewHtml),d=$(e.children()[0]),d.detach(),b=this.createView(d,a,c);else{if(!a.elementSelector)return this.loadTemplateThenInit(a,c);d=$(a.elementSelector),b=this.createView(d,a,c)}return this.initM(b)},loadTemplateThenInit:function(a,b){var c=$.Deferred(),d=this,e=Trillo.viewManager.loadView(a.viewFileName||a.name);return e.done(function(e){var f=e.$e,g=d._udpdateViewSpecs(e.viewSpecs,a.name,a,e.hasTemplateTag);g&&(a=$.extend({},g,a));var h=d.initMvc(f,a,b);h.done(function(a){c.resolve(a)}),h.fail(function(a){c.reject(a)})}),e.fail(function(a){c.reject(a)}),c.promise()},initMvc:function(a,b,c){var d=this.createView(a,b,c);return this.initM(d)},createView:function(a,b,c){var d=this.createController(b);d.updateViewSpec(b);var e=b.impl||Trillo.ImplClassByViewType[b.type];e||(e="Trillo.View"),console.debug("Creating view: "+b.name+", "+e);var f=Trillo.getRefByQualifiedName(e);f||(Trillo.log.error("Could not find impl class = "+e+", type = "+b.type+", defaulting to Trillo.View class"),f=Trillo.View),b.prevView=c;var g=new f(a,d,b);return b.view=g,d.setView(g),g.init2(),g},refresh:function(a,b){var c,d=this,e=$.Deferred();return c=b?this.initM(a,!0):a.modelChanged(),c.done(function(){a.nextView()?d.refresh(a.nextView(),b).done(function(){d.refreshEmbeddedViews(a,e,0,b)}):d.refreshEmbeddedViews(a,e,0,b)}),e.promise()},refreshEmbeddedViews:function(a,b,c,d){var e=a.embeddedViews(),f=this;c<e.length?this.refresh(e[c],!0).done(function(){f.refreshEmbeddedViews(a,b,c+1,d)}):b.resolve(a)},initM:function(a,b){var c=a.viewSpec,d=c.modelSpec;return d=$.extend({type:"local"},d),c.modelSpec=d,a.controller().updatModelWithParms(d,c.params),a.show(d,b)},createController:function(a){var b=this.createControllerForName(a),c=Trillo.appNamespace;return b||(b=this.createControllerForNS(c,a),b||(b=this.createControllerForNS(window.Shared,a)),b||(a.controller&&Trillo.log.warning("Controller class '"+a.controller+"' not found, using default controller."),b=new Trillo.Controller(a))),a.actionH&&(this.setActionHandlerForNS(c,a,b)||this.setActionHandlerForNS(window.Shared,a,b)),b},createControllerForName:function(a){var b=a.controller;if(b){var c=Trillo.getRefByQualifiedName(b);if(c)return new c(a)}return null},createControllerForNS:function(a,b){var c=b.controller||b.name+"C";if(a&&a[c])return new a[c](b);var d=Trillo.getRefByQualifiedName(c);return d?new d(b):null},setActionHandlerForNS:function(a,b,c){return a&&a[b.actionH]?(c.setActionHandler(new a[b.actionH]({controller:c})),!0):!1},udpdateViewSpecs:function(a,b,c,d){var e=Trillo.getSpecObject(a,"script[spec='view']");return this._udpdateViewSpecs(e,b,c,d)},_udpdateViewSpecs:function(a,b,c,d){if(!a)return null;var e,f=null,g=[];return b||(b=""),$.each(a,function(a,c){e=a,c.name=e,c.hasTemplateTag=d,e===b||""===b?(b=e,f=c):(c.embedded=!0,g.push(c))}),f&&g.length&&(f.embeddedSpecs=g),f},getRouteSpecsFromRoute:function(a){var b=[];if(!a||0===a.length)return b;for(var c,d=a.split("/"),e=0;e<d.length;e++)c=d[e],b.push({name:this.getName(c),params:this.getParams(c)});return b},getName:function(a){var b=a.indexOf("?");return b>=0?$.trim(a.substring(0,b)):a},getParams:function(a){return $.url(a).param()},getSubrouteAsStr:function(a){var b=a.name;if(0===b.length)return"";var c="";return $.each(a.params,function(a,b){c=(c.length?"&":"")+(a+"="+b)}),b+=c.length?"?"+c:""}}),Trillo.BaseController=Class.extend({initialize:function(a){this.viewSpec=a,this.name=a.name,this._view=null},setView:function(a){this._view=a},view:function(){return this._view},setActionHandler:function(a){this.actionH=a},$elem:function(){return this._view.$elem()},$container:function(){return this._view.$container()},modelLoaded:function(a){},model:function(){return this._view.model()},modelData:function(){return this._view.modelData()},parentController:function(){var a=this._view.parentView();return a?a.controller():null},clear:function(){},actionPerformed:function(a,b,c){if(b){var d=b.attr("action-func");if(d&&this[d])return this[d](c),!0}return this._actionPerformed(a,c||this.getSelectedObj(),this._view)?!0:(Trillo.alert.notYetImplemented(a),!1)},_actionPerformed:function(a,b,c){var d=!1;return this.handleAction(a,b,c)?d=!0:this.delegateActionToParent(a,b,c)&&(d=!0),d},handleAction:function(a,b,c){return!1},delegateActionToParent:function(a,b,c){return this.parentController()?this.parentController()._actionPerformed(a,b,c):!1},dblClicked:function(a,b){this.actionPerformed("detail",a,b,this._view)},actionDone:function(a){this.viewSpec.postRenderer&&this.viewSpec.postRenderer(a.obj._trillo_infoBlock),this.getSelectedObj()===a.obj&&this._view.setTbState()},selectedObjChanged:function(a){},getSelectedObj:function(){return this._view?this._view.selectedObj:null},getClosestSelectedObj:function(){var a=this._view?this._view.selectedObj:null;if(!a){var b=this.parentController();a=b?b.getClosestSelectedObj():null}return a},updateViewSpec:function(a){},viewSelected:function(a){this.updateRoute(a)},setParam:function(a,b){this.viewSpec.params[a]=b,this.updateRoute()},getParam:function(a){return this.viewSpec.params[a]},getRouteUpTo:function(){if(!this.viewSpec.isAppView){var a=this.parentController(),b=a?a.getRouteUpTo():"",c=this.getMySubrouteAsStr();return b=b+(c.length>0&&b.length>1?"/":"")+c}return Trillo.Config.basePath},getMySubrouteAsStr:function(){var a=this.viewSpec;if(!a)return"";var b=a.name+(this._view.internalRoute.length?"/"+this._view.internalRoute:"");if(0===b.length)return"";var c="";return $.each(a.params,function(a,b){c+=(c.length?"&":"")+(a+"="+b)}),b+=c.length?"?"+c:""},setRoute:function(a){Trillo.router.routeTo(a,!0)},selectAndRoute:function(a){return this._view.selectAndRoute(a)},updateRoute:function(a){var b=this.getRouteUpTo();a&&(b+=(b.length?"/":"")+a),Trillo.router.routeTo(b,!0)},getMySelection:function(){return this.getParam("sel")},getSelectionUidOrContextUid:function(){var a=this.getParam("sel");if(a&&Trillo.isUid(a)||(a=this.getParam("ctx")),!a){var b=this.parentController();a=b?b.getSelectionUidOrContextUid():null}return a},getContextUid:function(){var a=this.getParam("ctx");if(!a){var b=this.parentController();a=b?b.getSelectionUidOrContextUid():null}return a},updatModelWithParms:function(a,b){},showView:function(a){a.params=a.params||{},a.embedded=!0,Trillo.builder.init(a,null,this._view).done(function(a){a.postSetup()})},showViewByName:function(a,b){var c={name:a};b&&(c.modelSpec={data:b}),this.showView(c)},postViewShown:function(a){var b=this.parentController();b&&b.postViewShown(a)},postSetup:function(){},viewByName:function(a){return this._view?this._view.viewByName(a):null},controllerByName:function(a){var b=this.viewByName(a);return b?b.controller():null},objChanged:function(a){},
objAdded:function(a,b){},objDeleted:function(a){},fieldChanged:function(a,b,c,d,e){var f=this.parentController();f&&f.fieldChanged(a,b,c,d,e)},refreshView:function(a){return Trillo.builder.refresh(this._view,a)},showResult:function(a){"failed"===a.status?Trillo.alert.showError("Error",a.message||a.status):Trillo.alert.show("Success",a.message||a.status)},showNamedMessagesAsError:function(a){this._view.showNamedMessagesAsError(a)}}),Trillo.Page=Class.extend({initialize:function(a){this.options=a,this._view=null,this.resizeTimer=null,window.onresize=function(){},$(window).resize($.proxy(this.windowResized,this));try{$(window).bind("orientationchange",$.proxy(this.windowResized,this))}catch(b){}this._view=null},show:function(a){var b=$.Deferred();if(this._view)this.showViewsForRoute(a,b);else{var c=this,d=Trillo.builder.buildAppView();if(!d)return b.promise(),b.promise();d.done(function(d){$("body").addClass(Trillo.CSS.appRready),c._view=d[0],c.showViewsForRoute(a,b)}),d.fail(function(a){b.reject(a)})}return b.promise()},showViewsForRoute:function(a,b){if(!a||0===a.length){if(Trillo.isPreview)return b.resolve(),void this._view.addContainerMarks();if(a=this.getNextViewName(),!a||0===a.length)return void b.resolve()}var c=Trillo.builder.build(a,this._view);c.done(function(a){a.length>0&&(a[0].postSetup(),b.resolve(a))}),c.fail(function(a){b.reject(a)})},getNextViewName:function(){var a=this._view;return a?a.viewSpec.nextView?a.viewSpec.nextView:a.getNextViewName():null},windowResized:function(){this.clearResizeTimer(),this._view&&(this.resizeTimer=setTimeout($.proxy(this._windowResized,this),100))},_windowResized:function(){this.clearResizeTimer(),this._view&&this._view.windowResized()},clearResizeTimer:function(){this.resizeTimer&&(clearTimeout(this.resizeTimer),this.resizeTimer=null)},fileUploadSuccessful:function(a){var b=this._view.viewByName(a.targetViewName);b&&b.controller().fileUploadSuccessful(a)},fileUploadFailed:function(a){var b=this._view.viewByName(a.targetViewName);b&&b.controller().fileUploadFailed(a)}}),Trillo.ContextMenuManager=Class.extend({initialize:function(a){this.options=a,this.$currentContextMenu=null,this.hideM=$.proxy(this.hideCurrentContextMenu,this)},showContextMenu:function(a,b,c){a!==this.$currentContextMenu&&this.$currentContextMenu&&this.hideCurrentContextMenu(),this.$currentContextMenu=a,$("body").append(a),a.show();var d=this.getPosition(a,b,c);a.css({left:d.x,top:d.y}),$(document).on("click",this.hideM)},hideCurrentContextMenu:function(){this.$currentContextMenu&&(this.$currentContextMenu.hide(),this.$currentContextMenu=null,$(document).off("click",this.hideM))},getPosition:function(a,b,c){var d=a.width(),e=a.height(),f=$(window),g=f.width(),h=f.height();c+e-f.scrollTop()>h&&(c-=e);var i=b+d-f.scrollLeft();return i>g&&(b-=i-g),{x:b,y:c}}}),Trillo.CatalogsLoader=Class.extend({loadCatalogs:function(){var a=$.Deferred();return Trillo.appContext.isTrilloServer?$.ajax({url:"/model/loadCatalogs?appName="+Trillo.appName,type:"get",datatype:"application/json"}).done($.proxy(this.catalogsLoaded,this,a)):a.resolve(),a.promise()},catalogsLoaded:function(a,b){var c=b.enums;c&&$.each(c,function(a,b){Trillo.enumCatalog.registerAll(b)}),Trillo.appStrs=b.strings,a.resolve()}}),Trillo.Main=Class.extend({initialize:function(){Trillo.hideBusy(),this.setupContextAndConfig();var a=Trillo.appContext.app.appInitClass||"Trillo.AppInitializer",b=Trillo.getRefByQualifiedName(a),c=b?new b:new Trillo.AppInitializer,d=function(){(new Trillo.CatalogsLoader).loadCatalogs().done(function(){Trillo.router.start()})};c.initApp(d)},setupContextAndConfig:function(){Trillo.appContext||(Trillo.appContext={user:{},loggedIn:!1}),Trillo.appContext.app||(Trillo.appContext.app={name:"",appInitClass:"Trillo.AppInitializer"}),Trillo.appName=Trillo.appContext.app.name,Trillo.appNamespace=window[Trillo.appName],Trillo.isPreview=!!$.url(location.href).param("preview"),Trillo.Config.basePath||(Trillo.Config.basePath=Trillo.appContext.basePath?"/"+Trillo.appContext.basePath:"/"),Trillo.Config.viewPath||(Trillo.Config.viewPath=Trillo.appContext.isTrilloServer?"/view/"+Trillo.appName+"/":"/"===Trillo.Config.basePath?"/view/":Trillo.Config.basePath+"/view/"),Trillo.appContext.isTrilloServer||Trillo.Config.viewFileExtension&&""!==Trillo.Config.viewFileExtension||(Trillo.Config.viewFileExtension=".html")}}),Trillo.startApp=function(){new Trillo.Main},$(document).ready(function(){Trillo.startApp()});