/*!
 * TrilloJS v0.5.0 (https://github.com/trillo/trillojs#readme)
 * Copyright 2016 Collager Inc.
 * Licensed under the MIT license
 */
Trillo.Tools=Class.extend({initialize:function(a){this.$toolsE=a.$toolsE,this.$toolsContainer=a.$toolsContainer,this.toolSelectedMethod=$.proxy(this.toolSelected,this)},activate:function(a){this.actionHandler=a,this.$toolsContainer&&this.$toolsContainer.append(this.$toolsE),this.$toolsE.show(),this.$toolsE.off("click",this.toolSelectedMethod),this.$toolsE.on("click",this.toolSelectedMethod)},clear:function(a){this.actionHandler=null,this.$toolsE.off("click",this.toolSelectedMethod),this.$toolsE.hide(),this.$toolsContainer&&this.$toolsE.remove()},toolSelected:function(a){Trillo.contextMenuManager.hideCurrentContextMenu();var b=$(a.target),c=b.prop("tagName").toLowerCase();if("a"!==c&&"button"!==c){var d=b.find("button");if(0===d.length&&(d=b.find("a")),0===d.length&&(d=b.parent(),c=d.prop("tagName").toLowerCase(),"a"!==c&&"button"!==c))return;b=d}b.hasClass("dropdown-toggle")||(a&&(a.stopPropagation(),a.preventDefault()),b.closest("."+Trillo.CSS.buttonGroup+"."+Trillo.CSS.buttonGroupOpen).removeClass(Trillo.CSS.buttonGroupOpen),b.closest("."+Trillo.CSS.dropdown+"."+Trillo.CSS.dropdownOpen).removeClass(Trillo.CSS.dropdownOpen),this.actionHandler.actionPerformed(b.attr("nm"),b))},setDisabled:function(a){a?(this.$toolsE.find("button").attr("disabled",!0),this.$toolsE.find("a").attr("disabled",!0)):(this.$toolsE.find("button").removeAttr("disabled"),this.$toolsE.find("a").removeAttr("disabled"))}}),Trillo.ToolManager=Class.extend({initialize:function(a){this._view=a,this._controller=a.controller(),this.$toolbarTools=null,this.$hoverTools=null,this.$contextTools=null,this.tools=[];var b,c,d=a.$elem();if(a.$container()){var e=a.getToolBar$Elem();e.length>0&&(b=d.find(".js-toolbar-tools"),this.belongsToView(b)&&(b.attr("for-view",a.name),b.remove(),this.$toolbarTools=b,c=new Trillo.Tools({$toolsE:b,$toolsContainer:e}),this.tools.push(c)))}b=d.find(".js-tool"),this.belongsToView(b)&&(b.attr("for-view",a.name),c=new Trillo.Tools({$toolsE:b}),this.tools.push(c)),b=d.find(".js-hover-tools"),this.belongsToView(b)&&(b.attr("for-view",a.name),b.remove(),this.$hoverTools=b,c=new Trillo.Tools({$toolsE:b}),this.tools.push(c)),b=d.find(".js-context-menu"),this.belongsToView(b)&&(b.attr("for-view",a.name),b.remove(),this.$contextTools=b,c=new Trillo.Tools({$toolsE:b}),this.tools.push(c))},belongsToView:function(a){if(0===a.length)return!1;var b=a.attr("for-view");return!b||b===this._view.name},activate:function(){for(var a=this.tools,b=0;b<a.length;b++)a[b].activate(this);this.setTbState(null),this._controller.postToolsActivate()},clear:function(a){for(var b=this.tools,c=0;c<b.length;c++)b[c].clear(this)},actionPerformed:function(a,b){return this._controller.actionPerformed(a,b)},setTbState:function(a){var b,c=this.tools,d=a&&a.availabilityState===Trillo.OBJ_LOCKED;for(b=0;b<c.length;b++)Trillo.findAndSelf(c[b].$toolsE,"[data-for-class]").hide(),c[b].setDisabled(d);if(a){var e=Trillo.uidToClass(a.uid);if(e)for(b=0;b<c.length;b++)Trillo.findAndSelf(c[b].$toolsE,'[data-for-class="'+e+'"]').show();for(b=0;b<c.length;b++)c[b].$toolsE.is(":not([data-for-class])")&&!c[b].$toolsE.is(".js-context-menu")&&c[b].$toolsE.show()}this._controller.updateTbState(a)},showContextMenu:function(a,b){return this.$contextTools?(Trillo.contextMenuManager.showContextMenu(this.$contextTools,a,b),!0):!1},setToolVisible:function(a,b){var c='[nm="'+a+'"]';this.setToolVisibleBySelector(c,b)},setToolVisibleBySelector:function(a,b){var c,d=this.tools;if(b)for(c=0;c<d.length;c++)d[c].$toolsE.find(a).show();else for(c=0;c<d.length;c++)d[c].$toolsE.find(a).hide()},removeToolsWithInElement:function(){for(var a=this.tools,b=[],c=0;c<a.length;c++)a[c].$toolsE.hasClass(".js-tool")?a[c].clear(this):b.push(a[c]);this.tools=b},addToolsWithInElement:function(a){var b=a.find(".js-tool");if(this.belongsToView(b)){var c=new Trillo.Tools({$toolsE:b});return this.tools.push(c),c}return null}}),Trillo.InfoElementRepo=Class.extend({initialize:function(){this.table={},this.tableOfList={}},addTemplate:function(a,b,c){a.show(),this.table[b]=new Trillo.InfoElement(b,a,!0,c)},getE:function(a,b){var c=this.tableOfList[a];if(c&&c.length>0)return c.pop();var d=this.table[a];return d?d.copyIt(b):null},releaseE:function(a){if(!a.useTemplate){var b=this.tableOfList[a.elemKey];b||(this.tableOfList[a.elemKey]=b=[]),b.push(a),a.clear()}},makeInfoBlockList:function(a,b,c){var d=this.table[a];return d?d.requiresPositioning?this.makePositionedInfoBlockList(d,a,b,c):this.makeAutoInfoBlockList(d,a,b,c):null},makePositionedInfoBlockList:function(a,b,c,d){var e,f=[];a.$rootE.addClass(Trillo.CSS.positionOutside),document.body.appendChild(a.e);var g,h,i=0;for(h=0;h<c.length;h++)c[h]._trillo_infoBlock||(e=new Trillo.InfoBlock(b,c[h],d),a.show(c[h]),g=e.h=a.$rootE.outerHeight(),g>i&&(i=g),e.w=a.$rootE.outerWidth(),f.push(e),c[h]._trillo_infoBlock=e,a.clear());if(d.areAllSameSize)for(h=0;h<f.length;h++)f[h].h=i;return a.$rootE.removeClass(Trillo.CSS.positionOutside),a.clear(),document.body.removeChild(a.e),f},makeAutoInfoBlockList:function(a,b,c,d){for(var e,f=[],g=0;g<c.length;g++)c[g]._trillo_infoBlock||(e=new Trillo.InfoBlock(b,c[g],d),f.push(e),c[g]._trillo_infoBlock=e);return f},requiresLayout:function(a){var b=this.table[a];return b&&b.requiresPositioning}}),Trillo.InfoElement=Class.extend({initialize:function(a,b,c,d){if(this.$rootE=b,this.elemKey=a,this.e=b[0],this.elements=[],this.elClasses=[],this.hasTemplateTokens=!1,this.requiresPositioning=!0,this.requiresClickEvent=!0,c){if(d){debug.debug("Trillo.InfoElement - parsing using Mustache");var e=b[0].outerHTML,f=Mustache.parse(e);f.length>1?(debug.debug("Trillo.InfoElement - requires template processing while doing copyIt"),this.templateHtml=e,this.useTemplate=!0):debug.debug("Trillo.InfoElement - no template processing needed")}else debug.debug("Trillo.InfoElement - no template parsing done");b.hide(),document.body.appendChild(b[0]);var g=b.css("position");document.body.removeChild(b[0]),b.show(),this.requiresPositioning=g&&"absolute"===g.toLowerCase(),g=b.prop("tagName"),"a"===g.toLowerCase()&&(g=b.prop("href"),this.requiresClickEvent=!g||""===g||"#"===g)}for(var h,i=this.e.getElementsByTagName("*"),j=0;j<i.length;j++)h=i[j],h.getAttribute("nm")&&this.elements.push(h);this.$inputs=Trillo.getInputs(b)},show:function(a){for(var b,c,d=this.elements,e=d.length,f=0;e>f;f++)b=$(d[f]),c=b.attr("nm"),Trillo.setFieldValue(b,a[c],!1)},clear:function(){for(var a,b=this.elements,c=b.length,d=0;c>d;d++)a=b[d],this.elClasses[d]?($(a).removeClass(this.elClasses[d]),this.elClasses[d]=null):a.innerHTML=""},copyIt:function(a){var b;if(this.useTemplate){var c=Mustache.render(this.templateHtml,a);b=$("<div/>").html(c).contents()}else b=this.$rootE.clone();var d=new Trillo.InfoElement(this.elemKey,b,!1);return d.useTemplate=this.useTemplate,d.requiresPositioning=this.requiresPositioning,d.requiresClickEvent=this.requiresClickEvent,d}}),Trillo.InfoBlock=Class.extend({initialize:function(a,b,c){this.elemKey=a,this.obj=b,this.canvas=c,this.x=0,this.y=0,this.h=-1,this.w=-1,this.infoE=null,this.clickHandler=$.proxy(this.clicked,this),this.dblClickHandler=$.proxy(this.dblClicked,this),this.contextMenuHandler=$.proxy(this.onContextMenu,this),c.supportsHoverTools&&(this.mouseOverHandler=$.proxy(this.mouseOver,this),this.mouseLeaveHandler=$.proxy(this.mouseLeave,this)),this.changeHandler=$.proxy(this.fieldChanged,this)},show:function(){var a=this.infoE;a||(this.infoE=a=Trillo.infoElementRepo.getE(this.elemKey,this.obj),a.requiresPositioning&&this.infoE.$rootE.css("min-height",this.h+"px"),a.show(this.obj)),a.requiresPositioning&&a.$rootE.css({left:this.x,top:this.y}),this.canvas.canvasE.appendChild(a.e),a.requiresClickEvent&&(a.$rootE.off("click",this.clickHandler),a.$rootE.on("click",this.clickHandler),a.$rootE.off("dblclick",this.dblClickHandler),a.$rootE.on("dblclick",this.dblClickHandler)),a.$rootE.off("contextmenu",this.contextMenuHandler),a.$rootE.on("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.$rootE.off("mouseover",this.mouseOverHandler),a.$rootE.on("mouseover",this.mouseOverHandler)),a.$inputs.length>0&&(a.$inputs.off("change",this.changeHandler),a.$inputs.on("change",this.changeHandler)),this.canvas.postRenderer&&this.canvas.postRenderer(this)},refresh:function(){this.infoE&&(this.infoE.show(this.obj),this.canvas.postRenderer&&this.canvas.postRenderer(this))},hide:function(){var a=this.infoE;a&&(a.requiresClickEvent&&(a.$rootE.off("click",this.clickHandler),a.$rootE.off("dblclick",this.dblClickHandler)),a.$rootE.off("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.$rootE.off("mouseover",this.mouseOverHandler),a.$rootE.off("mouseleave",this.mouseLeaveHandler)),Trillo.infoElementRepo.releaseE(a),this.canvas.selected===this&&this.canvas.unselectInfoItem(this),a.$inputs.length>0&&a.$inputs.off("change",this.changeHandler),this.infoE=null)},setPosition:function(a,b){this.x=a,this.y=b},move:function(a,b){this.x+=a,this.y+=b},clicked:function(a){Trillo.contextMenuManager.hideCurrentContextMenu(),a&&!$(a.target).is(":input")&&a.stopPropagation(),this.canvas.clicked(this)},dblClicked:function(a){Trillo.contextMenuManager.hideCurrentContextMenu(),a&&!$(a.target).is(":input")&&a.stopPropagation(),this.canvas.dblClicked(this)},onContextMenu:function(a){a.stopPropagation(),a.preventDefault(),this.canvas.doContextMenu(this,a.pageX,a.pageY)},select:function(){this.infoE&&this.infoE.$rootE.addClass(Trillo.CSS.selected)},unselect:function(){this.infoE&&this.infoE.$rootE.removeClass(Trillo.CSS.selected)},mouseOver:function(a){var b=this.infoE;return b.$rootE.off("mouseover",this.mouseOverHandler),b.$rootE.on("mouseleave",this.mouseLeaveHandler),this.canvas.setHoverInfoItem(this),!0},mouseLeave:function(a,b){var c=this.infoE;c.$rootE.on("mouseover",this.mouseOverHandler),c.$rootE.off("mouseleave",this.mouseLeaveHandler),this.canvas.setHoverInfoItem(null)},fieldChanged:function(a){var b=$(a.target),c=b.attr("nm"),d=Trillo.getFieldValue(b);this.canvas.fieldChanged(c,d,this.obj)}}),Trillo.infoElementRepo=new Trillo.InfoElementRepo,Trillo.Canvas=Class.extend({initialize:function(a,b){if(this.areAllSameSize=!0,this.parent=a,this.$c=a.$container(),this.$canvasE=a.$e.hasClass("js-grid")?a.$e:a.$e.find(".js-grid"),this.canvasE=this.$canvasE[0],this.virtual=b.virtual,this.elemKey=b.elemKey,this.isListViewMode=b.isListViewMode,this.$headerRow=b.$headerRow,this.isDialog=b.isDialog,this.postRenderer=b.postRenderer,this.loadingData=!0,this.scrollListener=$.proxy(this.doScrolling,this,!1),this.actualScrollHandler=$.proxy(this._doScrolling,this),this.showListHandler=$.proxy(this.doShowList,this),this.scrollTimer=null,this.actualScrollTimer=null,this.showTimer=null,this.isScrollListenerAdded=!1,Trillo.isTouchSurface&&document.addEventListener("touchstart",$.proxy(this.scrollListener,this)),this.$pagination=$(".js-pagination"),this.selected=null,this.supportsHoverTools=!1,b.canvasToolsSelector){var c=$(b.canvasToolsSelector);c.length>0&&(this.canvasTools=new Trillo.Tools({$toolsE:c}),this.canvasTools.actionHandler=this,this.supportsHoverTools=!0)}this.sortM=$.proxy(this.doSort,this)},windowResized:function(){this.layout(),this.showChildren(),this.updatePagination()},clear:function(){this.$canvasE.empty(),this.$headerRow&&this.$headerRow.find("[sortable]").off("click",this.sortM),this.page&&this.page.items&&$.each(this.page.items,function(){this._trillo_infoBlock=void 0}),this.page=null,this.infoBlocks=null,this.clearShowTimer(),this.clearScrollTimer(),this.clearActualScrollTimer(),this.$pagination.hide(),this.removeScrollListener(),$(window).scrollTop(0)},objAdded:function(a,b){var c=Trillo.infoElementRepo.makeInfoBlockList(this.elemKey,[a],this);if(this.infoBlocks)if(b)this.infoBlocks=this.infoBlocks.concat(c);else for(var d=c.length-1;d>=0;d--)this.infoBlocks.unshift(c[d]);else this.infoBlocks=c;if(this.refreshAll(),b){var e=this.$canvasE.parent();e.scrollTop(e.prop("scrollHeight"))}},objChanged:function(a){a._trillo_infoBlock&&a._trillo_infoBlock.refresh()},setContent:function(a){this.addScrollListener(),this.loadingData=!1;var b=Trillo.infoElementRepo.makeInfoBlockList(this.elemKey,a.items,this);this.infoBlocks?this.infoBlocks=this.infoBlocks.concat(b):this.infoBlocks=b||[],this.page=a,this.refreshAll()},refreshAll:function(a){this.$canvasE.empty(),this.showHeader(),this.layout(),this.showChildren(),this.updatePagination()},showHeader:function(){var a=this.$headerRow;return a&&a.length>0?(this.canvasE.appendChild(a[0]),a.find("[sortable]").off("click",this.sortM),a.find("[sortable]").on("click",this.sortM),a.outerHeight()):0},layout:function(){Trillo.infoElementRepo.requiresLayout(this.elemKey)&&this._layout()},_layout:function(){var a,b,c,d,e,f=this.infoBlocks,g=f.length,h=0,i=0;this.$headerRow&&this.$headerRow.css("top",this.$canvasE.offset().top),this.isListViewMode?(e=1,d=$(this.$canvasE).width()):(d=(g>0?f[0].w:0)+Trillo.Options.H_MARGIN,e=Math.floor(($(this.$canvasE).width()-Trillo.Options.H_MARGIN)/d),0>=e&&(e=1));var j=this.showHeader();0===j&&(j=this.isListViewMode?0:Trillo.Options.V_MARGIN_TOP_ROW);var k,l=[];for(k=0;e>k;k++)l[k]=j;var m,n=0,o=null,p=null;for(k=0;g>k;k++){p=o,o=f[k],n=0,m=l[0];for(var q=1;q<l.length;q++)l[q]<m&&(0===l[q]||m-l[q]>50)&&(m=l[q],n=q);c=l[n],b=d*n,o.setPosition(b,c),a=b+d,a>h&&(h=a),a=c+o.h+(this.isListViewMode?0:Trillo.Options.V_MARGIN),l[n]=a,a>i&&(i=a)}if(0===i&&(i=j),this.contentW=this.$canvasE.outerWidth(),this.contentH=i+(this.page.pageNumber<this.page.numberOfPages?Trillo.Options.BOTTOM_SPACE_FOR_INF_SCROLL:0),this.$canvasE.css({height:this.contentH}),!this.isListViewMode){var r=Math.floor((this.contentW-h)/2);if(h/4>r)for(k=0;g>k;k++)o=f[k],o.move(r,0)}!this.isDialog&&this.$headerRow&&this.$headerRow.css({width:this.contentW}),this.updateContainerGeom()},showChildren:function(){this.virtual&&Trillo.infoElementRepo.requiresLayout(this.elemKey)?this.showSomeChildren():this.showAllChildren()},showSomeChildren:function(){if(!this.loadingData){this.clearShowTimer(),this.showList=[];var a,b,c,d,e,f=$(window).height()-this.$canvasE.offset().top;a=c=$(document).scrollTop(),b=d=a+f,a-=5*f,0>a&&(a=0),b+=5*f,b>a+this.contentH&&(b=a+this.contentH);var g,h=this.infoBlocks,i=h.length;for(g=0;i>g;g++){var j=h[g];if(j.y>b)j.hide(!0);else{var k=j.y+j.h;a>=k?j.hide(!0):(e=k>=c&&j.y<=d,e?j.show():j.shown||this.showList.push(j))}}$(".js-load-indicator-top").hide(),$(".js-load-indicator-bottom").hide(),d>=this.contentH&&(this.loadingData=this.loadNextPage(),this.loadingData?$(".js-load-indicator-bottom").show():this.noMoreItems=!0),this.showList.length>0&&(this.showTimer=setTimeout(this.showListHandler,200))}},showAllChildren:function(){if(!this.loadingData){this.clearShowTimer();for(var a=this.infoBlocks,b=a.length,c=0;b>c;c++){var d=a[c];d.show()}}},doShowList:function(){for(var a=this.showList,b=a.length,c=0;b>c;c++)a[c].show()},clearShowTimer:function(){this.showTimer&&(clearTimeout(this.showTimer),this.showTimer=null)},loadNextPage:function(){return this.page.pageNumber<this.page.numberOfPages?(this.parent.loadPage(this.page.pageNumber+1),!0):!1},addScrollListener:function(){this.virtual&&(this.isScrollListenerAdded||(this.isScrollListenerAdded=!0,$(window).bind("scroll",this.scrollListener)))},removeScrollListener:function(){this.isScrollListenerAdded&&(this.isScrollListenerAdded=!1,$(window).unbind("scroll",this.scrollListener))},doScrolling:function(a){if(this.clearScrollTimer(),this.updatePagination(),this.loadingData)return void(this.scrollTimer=setTimeout(this.scrollListener,200));this.clearActualScrollTimer(),this.clearShowTimer();var b=$(document).scrollTop(),c=b+$(window).height()-this.$canvasE.offset().top;Trillo.isTouchSurface&&c<this.contentH?this.actualScrollTimer=setTimeout(this.actualScrollHandler,100):this._doScrolling()},updatePagination:function(){if(this.virtual){for(var a,b,c=$(document).scrollTop(),d=c+$(window).height()-this.$canvasE.offset().top,e=this.infoBlocks,f=e.length,g=-1,h=-1,i=0,j=0;f>j;j++)a=e[j],i++,b=a.y+a.h,b>=c&&a.y<=d-20&&(-1===g&&(g=i),h=i);this.$pagination.show(),this.$pagination.html(g+"-"+h)}else this.$pagination.hide()},_doScrolling:function(){this.showChildren()},clearScrollTimer:function(){this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null)},clearActualScrollTimer:function(){this.actualScrollTimer&&(clearTimeout(this.actualScrollTimer),this.actualScrollTimer=null)},clicked:function(a){this.selectInfoItem(a)},dblClicked:function(a){this.parent.infoItemDblClicked(a)||this.selectInfoItem(a)},doContextMenu:function(a,b,c){this.selected!==a&&this.selectInfoItem(a),this.parent.showContextMenu(b,c)},actionPerformed:function(a,b){if(this.hoverInfoItem){var c=this.hoverInfoItem;this.selected!==c&&(this.selected&&this.selected.unselect(),this.selected=c,c.select(),this.parent.selectInfoItem(c)),this.parent.controller().actionPerformed(a,b)}},setHoverInfoItem:function(a){if(this.hoverInfoItem=a,a){if(a.obj.availabilityState===Trillo.OBJ_LOCKED)return;a.infoE.$rootE.append(this.canvasTools.$toolsE),this.canvasTools.activate(null,this)}else this.canvasTools.clear()},selectInfoItem:function(a){return this.selected===a?void this.unselectInfoItem(a):(this.selected&&this.selected.unselect(),this.selected=a,a.select(),void this.parent.selectInfoItem(a))},unselectInfoItem:function(a){this.selected===a&&(this.parent.unselectInfoItem(a),a.unselect(),this.selected=null)},updateContainerGeom:function(){if("absolute"===this.$c.css("position")){if(this.$c.is(this.$canvasE.parent()))return;var a=0;this.$c.children().each(function(){a+=$(this).outerHeight()}),a-=this.$canvasE.parent().outerHeight(),a=this.$c.height()-a,10>a&&(a=10),this.$canvasE.parent().height(a)}},doSort:function(a){a.stopPropagation(),a.preventDefault(),this.parent.doSort(a)},fieldChanged:function(a,b,c){this.parent.fieldChanged(a,b,c)}}),Trillo.Tree=Class.extend({initialize:function(a){this.name="TrilloTree",this.parent=a.parent,this.alwaysOpen=a.alwaysOpen,this.scrollPolicy=a.scrollPolicy||Trillo.Options.NO_SCROLL,this.openOnFirstClick=a.openOnFirstClick,this.closeOthers=a.closeOthers,this.toc=a.toc,this.timer=null,this.$e=a.$e,this.$treeE=this.$e.find(".js-tree"),this.lookupTable={},this.clickHandler=$.proxy(this.linkClicked,this),this.contextMenuHandler=$.proxy(this.onContextMenu,this),this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER&&(this.mouseOverHandler=$.proxy(this.onMouseOver,this),this.mouseOutHandler=$.proxy(this.onMouseOut,this),this.delayedOnMouseOut=$.proxy(this._onMouseOut,this))},clear:function(){this.clearTimeout(),this.removeEventHandlers()},removeEventHandlers:function(){var a=this.$e;a.off("click",this.clickHandler),a.off("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.off("mouseover",this.mouseOverHandler),a.off("mouseout",this.mouseOutHandler))},addHandlers:function(){var a=this.$e;this.removeEventHandlers(),this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER&&(a.on("mouseover",this.mouseOverHandler),a.on("mouseout",this.mouseOutHandler)),a.on("click",this.clickHandler),a.on("contextmenu",this.contextMenuHandler)},getSelectedItem:function(){return this.selectedItem},getSelectedItemUid:function(){return this.selectedItem?this.selectedItem.uid:null},setTreeData:function(a,b){this.addHandlers(),this.lookupTable={},this.updateTree(a,0,null,this.lookupTable),this.unselectCurrent(),this.list=a,this.selectedItem=null,this.$treeE.empty(),this.resetElements(a),this.renderList(null,a,this.$treeE),this.alwaysOpen||b===Trillo.Options.OPEN_ALL?this.openAll():b===Trillo.Options.CLOSE_ALL&&this.closeAll()},renderList:function(a,b,c,d){c.empty(),d&&c.append(d);for(var e=0;e<b.length;e++){var f=b[e],g=f[this.name];g?(g.e.attr("data-uid",f.uid),"undefined"!=typeof f.hideNode&&f.hideNode&&g.e.hide()):f[this.name]=g=this.renderElement(f),c.append(g.e)}},renderElement:function(a){var b,c=a._lvl,d=$("<div></div>"),e=Trillo.CSS.treeNode+" "+Trillo.CSS.treeNodeLevelPrefix+c+(a.className?" "+a.className:""),f=$("<div></div>"),g=null,h=a.displayName||a.name;return d.attr("data-uid",a.uid),this.canShowTn&&a.tnImage?(a.isTn=!0,b=$("<img/>"),b.attr("src",a.tnImage),f.addClass(Trillo.CSS.treeItemTn),g=$("<div></div>"),g.addClass(Trillo.CSS.tnLabel),g.html(h),e+=" no-border"):(b=$("<span></span>"),b.html(h),f.addClass(Trillo.CSS.treeItem+(this.canExpand(a,this)?" "+Trillo.CSS.itemClose:""))),d.addClass(e),f.append(b),g&&f.append(g),a.userE&&b.append(a.userE),d.append(f),a.hideNode&&d.hide(),{e:d,e2:f,e3:b,lvl:c}},refresh:function(){this._refresh(this.list)},_refresh:function(a){if(a)for(var b=0;b<a.length;b++){var c=a[b],d=c[this.name];if(d){var e=c.displayName||c.name;d.e4?d.e4.html(e):d.e3.html(e),this._refresh(c.children)}}},resetElements:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b[this.name]=null,b.children&&this.resetElements(b.children)},linkClicked:function(a,b){b||Trillo.contextMenuManager.hideCurrentContextMenu();var c=$(a.target).closest("."+Trillo.CSS.treeNode).attr("data-uid");if(c){var d=this.lookupTable[c];if(b){if(d===this.selectedItem)return}else a.stopPropagation();if(d._isAction&&!b)return void this.parent.treeAction(d.uid,d[this.name].e,d);var e=d[this.name],f=!0;if(!this.alwaysOpen&&this.canExpand(d,this)){var g=d===this.selectedItem||e.e2[0]===a.target,h=this.openOnFirstClick||g;e.open?g&&(this.closeItem(d),f=!1):h&&this.openItem(d)}d!==this.selectedItem&&this.selectItem(d,f,!b),this.parent.treeItemSelected(d)}},onContextMenu:function(a){a.stopPropagation();var b=$(a.target).closest("."+Trillo.CSS.treeNode).attr("data-uid");if(b){var c=this.lookupTable[b],d=c[this.name],e=d.e.offset();this.linkClicked(a,!0),d=c[this.name];var f=d.e.offset();this.parent.showContextMenu(a.pageX+f.left-e.left,a.pageY+f.top-e.top)&&a.preventDefault()}},openItem:function(a){if(this.canExpand(a,this)){var b=a[this.name];b&&b.open||(b||(a[this.name]=b=this.renderElement(a)),b.open=!0,this.renderList(a,a.children,b.e,b.e2),b.e2.removeClass(Trillo.CSS.itemClose).addClass(Trillo.CSS.itemOpen))}},closeItem:function(a){var b=a[this.name];b&&(b.open=!1,b.e.empty(),this.canExpand(a,this)&&b.e2.removeClass(Trillo.CSS.itemOpen).addClass(Trillo.CSS.itemClose),b.e.append(b.e2))},openItem2:function(a){for(var b=[],c=a;c&&-1!==c._lvl;)b.push(c),c=c.parent;for(var d=b.length-1;d>=0;d--){c=b[d];var e=c[this.name];e||(c[this.name]=e=this.renderElement(c)),this.openItem(c)}},selectItem:function(a,b,c){if(a!==this.selectedItem){var d,e=this.unselectCurrent();if(a&&(b&&this.openItem2(a),this.selectedItem=a,d=a[this.name],d.e2.addClass(Trillo.CSS.selected),c&&this.scrollSelectedInView()),this.closeOthers&&c&&e){var f=this.getCloseableParent(e),g=a?this.getCloseableParent(a):{};f!==g&&f!==g.parent&&(this.closeItem(f),a&&this.scrollSelectedInView(!0))}}},unselectCurrent:function(){var a,b=this.selectedItem;return b&&(a=b[this.name],a.e2.removeClass(Trillo.CSS.selected),this.selectedItem=null),b},selectItemByUid:function(a){if(!a||0===this.list.length)return!1;var b=this.lookupTable[a];return this.selectItem(b,!0,!0),b},getItemByUid:function(a){return this.lookupTable[a]},scrollSelectedInView:function(a){setTimeout($.proxy(this._scrollSelectedInView,this,a),100)},_scrollSelectedInView:function(a){if(this.selectedItem&&(a||this.scrollPolicy!==Trillo.Options.NO_SCROLL)){var b,c,d,e,f,g,h,i=this.selectedItem[this.name],j=i.e,k=this.$e,l=k.offset().top;if(d=j.offset().top,this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER||this.scrollPolicy===Trillo.Options.AUTO_SCROLL){if(f=k.outerHeight(),b=k.scrollTop(),c=b+f,g=d-l+b,h=g+j.outerHeight(),g>b&&c>h)return;e=k.css("overflow"),k.css("overflow","auto"),b=g-parseInt((f-i.e2.outerHeight())/2,10),k.scrollTop(b),"auto"!==e&&k.css("overflow","hidden")}else if(this.scrollPolicy===Trillo.Options.SMOOTH_SCROLL){b=document.viewport.getScrollOffsets().top,f=$(window).height()-l,c=b+f,g=d-l,h=g+j.outerHeight();var m=this.getTopParent(this.selectedItem);if(m!==this.selectedItem&&g>b&&c>h)return;var n=m[this.name].e,o=n.offset().top;if(b=d-o+i.e2.outerHeight()<f?o-l-b+parseInt(i.e.css("padding-top"),10):g-parseInt((f-i.e2.outerHeight())/2,10)-b,0===b)return;var p=0>b?1:2;b=Math.abs(b),this.smoothVScroll(b,p)}}},openAll:function(){this._openAll(this.list)},_openAll:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.children.length&&(this.closeItem(a[c]),this.openItem(a[c]),this._openAll(b.children))},closeAll:function(){this._closeAll(this.list)},_closeAll:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.children.length&&(this.closeItem(a[c]),this._closeAll(b.children))},clearTimeout:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},onMouseOver:function(){this.clearTimeout(),this.$e.css("overflow","auto")},onMouseOut:function(){this.clearTimeout(),this.timer=setTimeout(this.delayedOnMouseOut,1e3)},_onMouseOut:function(){this.clearTimeout(),this.$e.css("overflow","hidden")},getTopParent:function(a){if(!a)return null;for(;a.parent&&-1!==a.parent._lvl;)a=a.parent;return a},getCloseableParent:function(a){for(;a.parent&&!a.parent.closeOthers;)a=a.parent;return a},canExpand:function(a,b){return a?a.children&&a.children.length>0:!0},updateTree:function(a,b,c,d){var e=[];this._updateTree(a,b,c,d,e);for(var f=e.length?e[0]:null,g=1;g<e.length;g++)f._next=e[g],e[g]._prev=f,f=e[g]},_updateTree:function(a,b,c,d,e){for(var f,g=a.length,h=0;g>h;h++)f=a[h],"undefined"==typeof f.uid&&(f.uid=f.name),e.push(f),d[f.uid]=f,f._lvl=b,f.parent=c,f.children&&this._updateTree(f.children,b+1,f,d,e)},smoothVScroll:function(a,b){function c(){d=f>a?a:f,window.scrollBy(0,1===b?-d:d),a-=f,a>0&&setTimeout(c,g)}var d,e=100,f=10,g=30;a>e?(d=a-e,window.scrollBy(0,1===b?-d:d),a=e,setTimeout(c,g)):c()}}),Trillo.TitleBar=Class.extend({initialize:function(a){this.titleBar=a.titleBar,this.ownerView=a.ownerView,this.$titleBarE=$(a.titleBar)},setTitle:function(a,b,c){if(b=b||"",c=c||"",0===b.length)return void this.clearTitle(a);Trillo.HtmlTemplates.titleBarTitlePrefix&&!Trillo.HtmlTemplates.titleBarTemplates__parsed__&&(Mustache.parse(Trillo.HtmlTemplates.titleBarTitlePrefix),Mustache.parse(Trillo.HtmlTemplates.titleBarTitle),Trillo.HtmlTemplates.titleBarTemplates__parsed__=!0);var d;d=this.$titleBarE.find('[nm="'+a+'-title-prefix"]'),c.length?d.length?d.html(c):d=this.$titleBarE.append(Mustache.render(Trillo.HtmlTemplates.titleBarTitlePrefix,{viewName:a,titlePrefix:c})):d.length&&d.remove(),d=this.$titleBarE.find('[nm="'+a+'-title"]'),d.length?d.html(b):d=this.$titleBarE.append(Mustache.render(Trillo.HtmlTemplates.titleBarTitle,{viewName:a,title:b}))},clearTitle:function(a){this.$titleBarE.find('[nm="'+a+'-title-prefix"]').remove(),this.$titleBarE.find('[nm="'+a+'-title"]').remove()}}),Trillo.TitleBarManager=Class.extend({initialize:function(a){this.options=a,this.table={}},getTitleBar:function(a,b){return this.table[a]||(debug.debug("Adding titleBar: "+a),this.table[a]=new Trillo.TitleBar({titleBar:a,ownerView:b})),this.table[a]},viewCleared:function(a){var b=this,c=null;$.each(b.table,function(){return this.viewOwner===a?(c=this.titleBar,!1):void 0}),c&&(debug.debug("Removing titleBar: "+c),this.table[c].$titleBarE.html(""),this.table[c]=null)}}),Trillo.View=Class.extend({initialize:function(a,b,c){this.$e=a,this.viewSpec=c,c.params=c.params||{},this.name=c.name,this._controller=b,b.setView(this),this._embeddedViews=[],c.embedded?(this._parentView=c.prevView,this._parentView._embeddedViews.push(this)):(this._prevView=c.prevView,this._prevView&&(this._prevView._nextView=this));var d=0,e=null;if(Trillo.isPreview){var f=c.previewSpec;f?(c.container=f.container||c.container||"main-container",d=f.containerWidth):c.container=c.container||"main-container",e=c.container,this.$c=$("[nm='"+e+"']"),this.$c&&this.$c.css("width",0===d?"auto":d),c.type===Trillo.ViewType.Chart&&!c.charts&&c.params.charts&&(c.charts=c.params.charts.split(","))}else e=c.container,e?this.$c=$("[nm='"+e+"']"):this.$c=a.parent().length>0?a.parent():null;this.$c&&(c.isDialog=this.$c.hasClass("js-dialog-container")),this.createEmbeddedViews(),this.selected=null,this.cleared=!0,this.editable=!1,this.internalRoute="",this._textNodes=[],this._attrNodes=[]},createEmbeddedViews:function(){var a=this.viewSpec,b=a.embeddedSpecs;if(b&&b.length)for(var c=0;c<b.length;c++){var d=b[c];if(d.elementSelector){console.debug("Creating embedded view: "+d.name);var e=this.$e.find(d.elementSelector);e.attr("for-view",d.name),Trillo.builder.createView(e,d,this)}}},init2:function(){function a(d){var e,f,g;if(3===d.nodeType)e=d.nodeValue,e&&e.indexOf("{{")>=0&&b.push({textNode:d,text:e});else{if(!d.hasAttribute)return;var h=d.getAttribute("for-view");if(h&&h!==this.name)return;var i=d.attributes;if(i){var j;for(f=0,g=i.length;g>f;++f)j=i[f],e=j.nodeValue,e&&e.indexOf("{{")>=0&&c.push({attrNode:j,text:e})}var k=d.childNodes;for(f=0,g=k.length;g>f;++f)a(k[f])}}if(!this.viewSpec.hasTemplateTag)return void(this.toolsMgr=new Trillo.ToolManager(this));var b=this._textNodes,c=this._attrNodes;a(this.$e[0]),this.toolsMgr=new Trillo.ToolManager(this)},$elem:function(){return this.$e},$container:function(){return this.$c},embeddedViews:function(){return this._embeddedViews},show:function(a,b){var c=$.Deferred();if(b||!this._model||this._model.isModelChanged(a)){debug.debug("View.show() - creating new model for: "+this.viewSpec.name),this._model&&this._model.clear(),this._model=Trillo.modelFactory.createModel(a,this);var d;Trillo.isPreview?(d=this.viewSpec.type===Trillo.ViewType.Chart&&this.viewSpec.params.charts?this._model.loadChartTestData(this.viewSpec.charts[0]):this._model.loadTestData(this.viewSpec.name),d.done($.proxy(this.processTestData,this,c))):(d=this._model.loadData(),d.done($.proxy(this.showUsingModel,this,c))),d.fail(function(a){c.reject(a)})}else this.postShow(c),debug.debug("View.show() - no changes");return c.promise()},controller:function(){return this._controller},processTestData:function(a,b){if($.isEmptyObject(b.data)||b.data.isParameter){b.data.isParameter&&(b.modelSpec.params=b.data),b.data=null;var c=b.loadData();c.done($.proxy(this.showUsingModel,this,a))}else this.showUsingModel(a,b)},showUsingModel:function(a,b){return this._model=b,this.mapModelData(b),this.cleared?(Trillo.router.showingView(this),this.viewSpec.container&&!this.viewSpec.isAppView&&$("body").addClass(this.viewSpec.container+"-shown"),this.$c&&0===this.$e.parent().length&&(this.$c.empty(),this.$c.append(this.$e)),this.$e.show(),this.render(),this.toolsMgr.activate(),this.cleared=!1,void this.postShow(a)):(this.render(),void this.postShow(a))},mapModelData:function(a){},model:function(){return this._model},modelData:function(){return this._model.data},render:function(){if(this.viewSpec.hasTemplateTag){var a,b,c=this._textNodes,d=this._attrNodes;for(b=0;b<c.length;b++)a=c[b],a.textNode.nodeValue=Mustache.render(a.text,this.modelData());for(b=0;b<d.length;b++)a=d[b],a.attrNode.nodeValue=Mustache.render(a.text,this.modelData())}},renderData:function(a){},postShow:function(a){this._controller.postViewShown(this),a.resolve(this),this.viewSpec.isDialog&&this.centerIt()},postSetup:function(){this._nextView&&this._nextView.postSetup();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].postSetup();this._controller.postSetup()},markForClearing:function(){this.viewSpec.isAppView||(this.viewSpec.embedded||Trillo.router.markForClearing(this),this.ownsGlobalProgress&&this.hideGlobalProgress(),this._model&&this._model.clearObserver()),this._nextView&&this._nextView.markForClearing();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].markForClearing()},clear:function(){if(!this.cleared){for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].clear();this._embeddedViews=[],this._model&&(this._model.clear(),this._model=null),this.toolsMgr.clear(),Trillo.searchHandler&&Trillo.searchHandler.context===this&&Trillo.searchHandler.setContext(null),this.clearTitle(),Trillo.titleBarManager.viewCleared(this),this.viewSpec.container&&$("body").removeClass(this.viewSpec.container+"-shown"),
this.$e.remove(),this._prevView?this._prevView._nextView===this&&(this._prevView._nextView=null):this._parentView&&this._parentView.embeddedViews().splice(this._parentView.embeddedViews().indexOf(this),1),this.cleared=!0}},modelChanged:function(){var a=$.Deferred();return this.showUsingModel(a,this._model),a.promise()},showGlobalProgress:function(a,b){console.log("showing .... "+this.viewSpec.name),this.ownsGlobalProgress=!0;var c=$(".js-global-progress-bar");c.show();var d=c.find(".js-title");d.html(a),d=c.find(".js-message"),d.html(b),c.find(".js-progress-bar").css("width",(b||4)+"%")},hideGlobalProgress:function(){this.ownsGlobalProgress=!1,console.log("hiding .... "+this.viewSpec.name);var a=$(".js-global-progress-bar");a.hide()},updateProgress:function(a){this._updateProgress(a)},_updateProgress:function(a){var b=this.parentView();if(b&&b._updateProgress(a))return!0;var c=this._controller.getSelectionUidOrContextUid();return a&&(this.selectedObj&&this.selectedObj.uid===a.uid||c===a.uid)?(a.availabilityState===Trillo.OBJ_LOCKED&&"undefined"!=typeof a.percentComplete?this.showGlobalProgress(a.actionName,a.percentComplete):this.hideGlobalProgress(),!0):!1},parentView:function(){return this._parentView||this._prevView},nextView:function(){return this._nextView},getTitleBar:function(){if(this.viewSpec.titleBar)return Trillo.titleBarManager.getTitleBar(this.viewSpec.titleBar,this);var a=this.parentView();return a?a.getTitleBar():Trillo.titleBarManager.getTitleBar(".js-heading",this)},getToolBar$Elem:function(){if(this.viewSpec.toolBar)return this.$c.find(this.viewSpec.toolBar);var a=this.parentView();return a?a.getToolBar$Elem():$(".js-toolbar")},updateTitle:function(){var a,b="";if(this.viewSpec.type===Trillo.ViewType.Selector||this.viewSpec.type===Trillo.ViewType.List||this.viewSpec.type===Trillo.ViewType.Nav||this.viewSpec.embedded);else if(Trillo.isCollectionView(this.viewSpec.type)||this.viewSpec.type===Trillo.ViewType.Chart)a=this.viewSpec.displayName||"";else{this.viewSpec.type===Trillo.ViewType.Tree&&(b=this.viewSpec.displayName||"");var c=this.selectedObj;a=c?c.displayName||c.name||"":""}this.setTitle(a,b)},setTitle:function(a,b){if(this.title=a,this.titlePrefix=b,""!==b&&b||this.getPrevViewTitle()!==a){var c=this.getTitleBar();c&&c.setTitle(this.name,a,b)}},clearTitle:function(){this.title=null,this.titlePrefix=null;var a=this.getTitleBar();a&&a.clearTitle(this.name)},getPrevViewTitle:function(){return this._prevView?this._prevView.title:null},getSelectedObj:function(){return this.selectedObj},setSelectedObj:function(a){this.selectedObj=a,this._controller.selectedObjChanged(a),this.setTbState(),this._controller.updateTitle()},setTbState:function(){this.toolsMgr.setTbState(this.selectedObj)},searchPhraseAvailable:function(a,b,c,d){},windowResized:function(){if(!this.cleared){this.viewSpec.isDialog&&this.centerIt(),this._nextView&&this._nextView.windowResized();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].windowResized()}},showContextMenu:function(a,b){return this.toolsMgr.showContextMenu(a,b)},getNextViewName:function(a){if(this._nextView)return this._nextView.name;if(a){var b=this.viewSpec.type;if(b===Trillo.ViewType.Tab||b===Trillo.ViewType.Nav||Trillo.ViewType.Selector)return a.name}return this.viewSpec.nextView?this.viewSpec.nextView:this._getNextViewName(a)},_getNextViewName:function(a){var b=this.getNextViewSpecByContextUidClass();return b?b.name:null},getNextViewSpec:function(a){var b=this.viewSpec.nextViewSpecs;return b?b[a]:null},getNextViewSpecByContextUidClass:function(){var a=this._controller.getContextUid();return this.getNextViewSpecByUidClass(a)},getNextViewSpecByUidClass:function(a){var b=this.viewSpec.nextViewSpecs,c=null;if(b&&a){var d=Trillo.uidToClass(a);d&&$.each(b,function(a,b){return b.className===d?(c=b,!1):void 0})}return c},getNextViewSpecNameByUidClass:function(a){var b=this.getNextViewSpecByUidClass(a);return b?b.name:null},doInternalRouting:function(a,b){return 0},routingToNextView:function(a,b){for(var c=a.length,d="",e=b;c>e&&(d=d+(d.length>0?"/":"")+a[e].name,!this.synchWithRouteState(d));e++);},synchWithRouteState:function(a){return!0},viewByName:function(a){var b=this.findViewByNameNextDir(a);return b?b:this.findViewByNamePrevDir(a)},findViewByNameNextDir:function(a){if(this.name===a)return this;for(var b=0;b<this._embeddedViews.length;b++){var c=this._embeddedViews[b].findViewByNameNextDir(a);if(c)return c}return this._nextView?this._nextView.findViewByNameNextDir(a):void 0},findViewByNamePrevDir:function(a){return this.name===a?this:this._prevView?this._prevView.findViewByNamePrevDir(a):this._parentView?this._parentView.findViewByNamePrevDir(a):void 0},objChanged:function(a){this._controller.objChanged(a)},objAdded:function(a,b){this._controller.objAdded(a,b)},objDeleted:function(a){this._controller.objDeleted(a)},validate:function(){for(var a=!0,b=0;b<this._embeddedViews.length;b++)a=this._embeddedViews[b].validate()&&a;return a},viewSelected:function(a){Trillo.contextMenuManager.hideCurrentContextMenu(),a&&a.preventDefault();var b=$(a.target).closest(this.itemCss),c=b.attr("nm");this.updateItemSelection(c)&&this.postViewSelected(c)},updateItemSelection:function(a){var b=this.$e,c=b.find(this.itemCss+"[selected]");return c.attr("nm")!==a?(c.removeClass(Trillo.CSS.selected),c.removeAttr("selected"),c=b.find("[nm='"+a+"']"),c.addClass(Trillo.CSS.selected),c.attr("selected","selected"),!0):!1},postViewSelected:function(a){this._controller.viewSelected(a)},updateLabel:function(){},redraw:function(){if(this._nextView)return this._nextView.redraw();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].redraw()},setEditable:function(a){if(this._nextView)return this._nextView.setEditable(a);for(var b=0;b<this._embeddedViews.length;b++)this._embeddedViews[b].setEditable(a)},centerIt:function(){var a=$(window),b=this.$c;if(b){var c=a.width(),d=a.scrollTop(),e=b.width();b.css("top",d+100+"px"),b.css("left",parseInt(c/2-e/2,10)+"px")}},addContainerMarks:function(){var a,b,c=this.$e.find(".js-container");$.each(c,function(){b=$(this),b.empty(),b.addClass(Trillo.CSS.containerPreviewMode),a=$("<span></span>"),b.append(a),a.addClass(Trillo.CSS.containerMark),a.html(b.attr("nm")),$("body").addClass(b.attr("nm")+"-shown")})}}),Trillo.EditableView=Trillo.View.extend({messageHtml:'<span class="js-field-message '+Trillo.CSS.fieldMsg+' text-info"></span>',errorHtml:'<span class="js-field-error '+Trillo.CSS.fieldMsg+' text-danger"></span>',initialize:function(a,b,c){this._super(a,b,c),this.editable=c.editable!==!1},updateElements:function(a,b){$.each(a,function(){var a=$(this),c=a.attr("nm"),d=Trillo.getObjectValue(b,c);null===d&&(d=""),Trillo.setFieldValue(a,d)})},retrieveData:function(a){var b={};return $.each(a,function(){var a=$(this),c=a.attr("nm"),d=Trillo.getFieldValue(a);null!==d&&void 0!==d&&Trillo.setObjectValue(b,c,d)}),b},_validateOne:function(a){if(!a.is(":visible"))return!0;this.clearInlineError(a);var b=!0,c=Trillo.getFieldValue(a),d=""===c||void 0===c;return a.hasClass("js-required")&&d&&(this.inlineError(a,"Required"),b=!1),!a.hasClass("number")||d||Trillo.isNumeric(c)||(this.inlineError(a,"Numeric value required"),b=!1),b||a.parent().addClass(Trillo.CSS.hasErrorCss),b},validateOne:function(a){var b=$(a.target);return b.is(":visible")?this._validateOne(b):!0},_validate:function(a){for(var b=!0,c=0;c<a.length;c++){var d=$(a[c]);b=this._validateOne(d)&&b}return b},showNamedMessages:function(a){var b;if(a)for(var c=0;c<a.length;c++)b=a[c],this.inlineMessage(this.$e.find('[nm="'+b.name+'"]'),b.message)},showNamedMessagesAsError:function(a){var b;if(a)for(var c=0;c<a.length;c++)b=a[c],this.inlineError(this.$e.find('[nm="'+b.name+'"]'),b.message)},inlineMsg:function(a,b){var c=a.siblings(".js-field-message");return 0===c.length&&(a.after(this.messageHtml),c=a.siblings(".js-field-message")),c.html(b),c.parent().addClass(Trillo.CSS.hasMessageCss),c},inlineError:function(a,b){var c=a.siblings(".js-field-error");return 0===c.length&&(a.after(this.errorHtml),c=a.siblings(".js-field-error")),c.html(b),c.parent().addClass(Trillo.CSS.hasErrorCss),c},clearInlineMessage:function(a){var b=a.siblings(".js-field-message");b.length&&(b.html(""),b.parent().removeClass(Trillo.CSS.hasMessageCss))},clearInlineError:function(a){var b=a.siblings(".js-field-error");b.length&&(b.html(""),b.parent().removeClass(Trillo.CSS.hasErrorCss))},fieldChanged:function(a){var b=this.validateOne(a),c=$(a.target),d=c.attr("nm"),e=Trillo.getFieldValue(c);this.updateModelData(d,e);var f=this.getObjForField(c);return this.controller().fieldChanged(d,e,b,this,f),b},getFieldValue:function(a){var b=this.$e.find('[nm="'+a+'"]');return b.length?Trillo.getFieldValue(b):void 0},setFieldValue:function(a,b){var c=this.$e.find('[nm="'+a+'"]');c.length&&(Trillo.setFieldValue(c,b),this._validateOne(c)&&this.updateModelData(a,b))},getInputs:function(){return Trillo.getInputs(this.$e)},setEditable:function(a){a!==this.editable&&(this.editable=a,this.renderData(this.modelData())),this._super()},setFieldEditable:function(a,b){var c=this.$e.find('[nm="'+a+'"]');c.length&&Trillo.setFieldValue(c,Trillo.getFieldValue(c),!b)},postShow:function(a){var b=this.$e.find("textarea");b.length&&(autosize(b),autosize.update(b)),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find("textarea");a.length&&autosize.destroy(a)}this._super()}}),Trillo.ViewSelectionView=Trillo.View.extend({containerCss:null,itemCss:null,initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this)},postShow:function(a){var b=this.$e.find(this.itemCss);b.off("click",this.viewSelectedMethod),b.on("click",this.viewSelectedMethod),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find(this.itemCss);a.off("click",this.viewSelectedMethod)}this._super()},synchWithRouteState:function(a){var b=this.$e,c=b.find("[nm='"+a+"']");return c.length>0?(this.updateItemSelection(a),this.updateLabel(),this.controller().updateTitle(),!0):!1},_getNextViewName:function(a){var b=this.$e.find(this.itemCss+"[selected]");return b.length>0?b.attr("nm"):null}}),Trillo.TreeView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c);var d=this.$e.find(".js-scrollbar");this.tree=new Trillo.Tree({$e:d,parent:this,scrollPolicy:Trillo.isTouchSurface?Trillo.Options.AUTO_SCROLL:Trillo.Options.SCROLL_ON_HOVER,openOnFirstClick:!0,closeOthers:!0}),this.toggleDisplayHandler=$.proxy(this.toggleDisplay,this)},clear:function(){this.cleared||(this.removeEventHandlers(),this.renderData([]),this.tree.clear()),this._super()},mapModelData:function(a){a.data=a.data||{},a.data.children=a.data.children||[]},render:function(){this._super(),this.renderData(this.modelData().children)},renderData:function(a){this.addHandlers(),this.tree.setTreeData(a)},postShow:function(a){this.selectTreeItem(this.controller().getMySelection()),this._super(a)},selectTreeItem:function(a){var b=this.tree.selectItemByUid(a),c=this.modelData().children;!b&&c&&c.length>0&&(a=c[0].uid,this.controller().setParam("sel",a),this.tree.selectItemByUid(a)),this.setSelectedObj(this.tree.selectedItem)},selectAndRoute:function(a){var b=this.tree.selectItemByUid(a);return b?(this.treeItemSelected(this.tree.selectedItem),!0):!1},synchWithRouteState:function(a){var b=this.tree.getItemByUid(a);return b&&b!==this.selectedObj?(this.tree.selectItemByUid(a),this.setSelectedObj(this.tree.selectedItem),!0):!1},treeAction:function(a,b,c){this.controller().actionPerformed(a,b,c)},treeItemSelected:function(a){this.setSelectedObj(a),this.controller().setParam("sel",a.uid)},addHandlers:function(){this.viewSpec.viewToggle&&(this.removeEventHandlers(),$(this.viewSpec.viewToggle).on("click",this.toggleDisplayHandler))},removeEventHandlers:function(){this.viewSpec.viewToggle&&$(this.viewSpec.viewToggle).off("click",this.toggleDisplayHandler)},toggleDisplay:function(){var a=this.$container().offset().left<0;this.$container().css("left",a?"0px":"-1000px")},outOfView:function(){this.$container().css("left","-1000px")},withInView:function(){this.$container().css("left","0px")},getNextViewName:function(a){var b=this.selectedObj;return b?Trillo.isUid(b.uid)?this.getNextViewSpecNameByUidClass(b.uid):b.uid:null},objChanged:function(a){this.render(),this.selectTreeItem(this.controller().getMySelection())},redraw:function(){this.tree.refresh(),this._super()}}),Trillo.SelectorView=Trillo.ViewSelectionView.extend({labelSelector:".js-label",containerCss:".js-menu",itemCss:".js-menu-item",initialize:function(a,b,c){this._super(a,b,c)},updateLabel:function(){var a=this.$e,b=a.find(this.itemCss+"[selected]");a.find(this.labelSelector).html(b.html())}}),Trillo.TabView=Trillo.EditableView.extend({containerCss:".js-tab-list",itemCss:".js-tab",tabPanelCSS:".js-tab-panel",initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this),this.$inputs=Trillo.getInputs(a),this.changeHandler=$.proxy(this.fieldChanged,this)},getInputs:function(){return this.$inputs},mapModelData:function(a){a.data=a.data||{}},render:function(){this._super(),this.setSelectedObj(this.modelData()),this.updateProgress(this.modelData()),this.setChangeHandler(!0),this.renderData(this.modelData())},renderData:function(a){this.updateElements(this.getInputs(),a)},setChangeHandler:function(a){var b=this.getInputs();b.off("change",this.changeHandler),a&&b.on("change",this.changeHandler)},validate:function(){var a=this.getInputs(),b=this._validate(a);return b&=this._super()},postShow:function(a){var b=this.$e.find(this.itemCss+"[selected]");if(b.length>0){var c=b.attr("nm"),d=this.$e.find(this.tabPanelCSS+"[for='"+c+"']");d.length>0&&this.updateTabPanelVisibility(c)}var e=this.$e.find(this.itemCss);e.off("click",this.viewSelectedMethod),e.on("click",this.viewSelectedMethod),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find(this.itemCss);a.off("click",this.viewSelectedMethod),this.setChangeHandler(!1)}this._super()},updateLabel:function(){var a=this.$e,b=a.find(this.itemCss+"[selected]");a.find("."+Trillo.CSS.tabActive).removeClass(Trillo.CSS.tabActive),b.parent().addClass(Trillo.CSS.tabActive)},updateTabPanelVisibility:function(a){var b=this.$e;b.find(this.tabPanelCSS+"[for]").hide();var c=b.find(this.tabPanelCSS+"[for='"+a+"']");c.show(),Trillo.resizeAllTextArea(b),this.redraw()},postViewSelected:function(a){var b=this.$e.find(this.tabPanelCSS+"[for='"+a+"']");b.length>0?(this.updateTabPanelVisibility(a),this.updateLabel()):this._super(a)},_getNextViewName:function(a){var b=this.$e.find(this.itemCss+"[selected]");if(b.length>0){var c=b.attr("nm"),d=this.$e.find(this.tabPanelCSS+"[for='"+c+"']");return d.length>0?null:c}return null},objChanged:function(a){a===this.modelData()&&(Trillo.setFieldsValue(this.$e,a),this.updateProgress(a),this.setTbState()),this._super(a)},synchWithRouteState:function(a){var b=this.$e,c=b.find("[nm='"+a+"']");return c.length>0?(this.updateItemSelection(a),this.updateLabel(),this.controller().updateTitle(),!0):!1},updateModelData:function(a,b){this.model().setValue(a,b)},getObjForField:function(a){return this.modelData()}}),Trillo.NavView=Trillo.ViewSelectionView.extend({containerCss:".js-navigation",itemCss:".js-nav-item",initialize:function(a,b,c){this._super(a,b,c)}}),Trillo.sortDescTemplate='<span class="order"><span class="caret"></span></span>',Trillo.sortAscTemplate='<span class="order dropup"><span class="caret"></span></span>',Trillo.CollectionView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c),this.setupView(),this.sortSpec={}},setupView:function(){var a={},b=this.viewSpec,c=this.$e,d=c.find(".js-grid-cell");d.length>0?(a.elemKey=b.name+"-info-block",Trillo.infoElementRepo.addTemplate(d,a.elemKey,b.hasTemplateTag)):(d=c.find(".js-content-row"),d.length>0&&(a.elemKey=b.name+"-row",Trillo.infoElementRepo.addTemplate(d,a.elemKey,b.hasTemplateTag),a.isListViewMode=!0)),d=c.find(".js-heading-row"),d.length>0&&(d.show(),a.$headerRow=d),a.postRenderer=b.postRenderer,a.isDialog=b.isDialog,a.virtual=b.virtual||"undefined"==typeof b.virtual?!0:!1,this.$asc=$(Trillo.sortAscTemplate),this.$desc=$(Trillo.sortDescTemplate),this.canvas=new Trillo.Canvas(this,a)},mapModelData:function(a){a.data=a.data||[]},render:function(){var a=this.model().numberOfPages;(void 0===a||1===a)&&(this.viewSpec.virtual=!1,this.canvas.virtual=!1),this.controller().updateTitle(),this._super(),this.renderData(Trillo.convertToPage(this.modelData()))},renderData:function(a){this.canvas.clear(),this.canvas.setContent(a)},clear:function(){this.cleared||(this.unselectInfoItem(),this.canvas.clear()),this._super()},windowResized:function(){this.cleared||(this.canvas.windowResized(),this._super())},loadPage:function(a,b){$.when(this.model().loadData(a)).done($.proxy(this.pageLoaded,this,b))},pageLoaded:function(a,b){a&&this.canvas.clear(),this.canvas.setContent(Trillo.convertToPage(this.modelData()))},selectInfoItem:function(a){this.selectedInfoItem=a,this.setSelectedObj(a.obj)},unselectInfoItem:function(a){this.selectedInfoItem=null,this.setSelectedObj(null)},infoItemDblClicked:function(a){return this.controller().dblClicked(a?a.$rootE:null,a?a.obj:null,a)},objChanged:function(a){this.canvas.objChanged(a),this.selectedObj===a&&this.setTbState(),this._super(a)},objAdded:function(a,b){this.canvas.objAdded(a,b),this._super(a,b)},doSort:function(a){var b=$(a.target),c=b.attr("nm");if(!c)return void Trillo.alert.showError("Error","Missing 'name' attribute in the header, pl. specify in the HTML temlpate");var d=this.sortSpec[c];if(d="asc"===d?"desc":"asc",this.$asc.remove(),this.$desc.remove(),"asc"===d?b.append(this.$asc):b.append(this.$desc),this.sortSpec={},this.sortSpec[c]=d,this.model().setOrderBy){var e=c+" "+d;this.model().setOrderBy(e),this.canvas.loadingData=!0,this.loadPage(1,!0)}else this.model().doSort(c,d),this.canvas.clear(),this.canvas.setContent(Trillo.convertToPage(this.modelData()))},redraw:function(){this.canvas.refreshAll(),this._super()},fieldChanged:function(a,b,c){this.controller().fieldChanged(a,b,!0,this,c)}}),Trillo.DropdownView=Trillo.ViewSelectionView.extend({labelSelector:".js-label",initialize:function(a,b,c){this._super(a,b,c,".js-list",".js-list-item"),this.itemSelectedMethod=$.proxy(this.itemSelected,this)},mapModelData:function(a){a.data=a.data||[]},render:function(){this.controller().updateTitle(),this._super(),this.renderList()},renderList:function(){var a=this.$e.find(".js-list"),b=Trillo.listFromPage(this.modelData());Trillo.HtmlTemplates.dropdownListItem&&!Trillo.HtmlTemplates.dropdownListItem__parsed__&&(Mustache.parse(Trillo.HtmlTemplates.titleBarTitlePrefix),Mustache.parse(Trillo.HtmlTemplates.dropdownListItem),Trillo.HtmlTemplates.dropdownListItem__parsed__=!0);for(var c="",d=0;d<b.length;d++){var e=b[d];c+=Mustache.render(Trillo.HtmlTemplates.dropdownListItem,e)}a.html(c)},postShow:function(a){this.selectItem(),this._super(a)},selectItem:function(){var a=this.controller().getMySelection(),b=null;a&&(b=this.model().getObj(a));var c=Trillo.listFromPage(this.modelData());!b&&c.length>0&&(b=c[0],a=b.uid,this.controller().setParam("sel",a)),this.setSelectedObj(b)},synchWithRouteState:function(a){this._super(a);var b=this.model().getObj(a);b&&b!==this.selectedObj&&this.setSelectedObj(b)},setSelectedObj:function(a){this._super(a),this.updateLabel()},postViewSelected:function(a){var b=this.model().getObj(a);this.setSelectedObj(b);var c=b?b.uid:null;this.controller().setParam("sel",c)},updateLabel:function(){var a=this.selectedObj,b=a?a.name:"";this.$e.find(this.labelSelector).html(b)},_getNextViewName:function(a){var b=this.selectedObj;return b?Trillo.isUid(b.uid)?null:b.uid:void 0},objChanged:function(a){this.renderList(),this.selectedObj===a&&this.setTbState(),this._super(a)},objAdded:function(a,b){this.renderList(),this.selectedObj||this.selectItem(),this._super(a,b)}}),Trillo.DetailView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c)},mapModelData:function(a){a.data=a.data||{}},render:function(){this._super(),this.setSelectedObj(this.modelData()),Trillo.setFieldsValue(this.$e,this.modelData()),this.updateProgress(this.modelData())},objChanged:function(a){a===this.modelData()&&(Trillo.setFieldsValue(this.$e,a),this.updateProgress(a),this.setTbState()),this._super(a)}}),Trillo.FormView=Trillo.EditableView.extend({initialize:function(a,b,c){this._super(a,b,c),this.changeHandler=$.proxy(this.fieldChanged,this)},mapModelData:function(a){a.data=a.data||{}},render:function(){this._super(),this.setChangeHandler(!0),this.renderData(this.modelData())},renderData:function(a){this.updateElements(this.getInputs(),a)},setChangeHandler:function(a){var b=this.getInputs();b.off("change",this.changeHandler),a&&b.on("change",this.changeHandler)},validate:function(){var a=this.getInputs(),b=this._validate(a);return b&=this._super()},clear:function(){this.cleared||this.setChangeHandler(!1),this._super()},canSubmit:function(){return this.validate()},updateModelData:function(a,b){this.model().setValue(a,b)},getObjForField:function(a){return this.modelData()}}),Trillo.EditableTableView=Trillo.EditableView.extend({initialize:function(a,b,c){this._super(a,b,c),this.allowsNewRow="undefined"==typeof c.allowsNewRow||c.allowsNewRow,this.setupView()},setupView:function(){this.$templateE=this.$e.find(".js-content-row"),this.$templateE.remove(),this.changeHandler=$.proxy(this.rowFieldChanged,this),this.rowActionHandler=$.proxy(this.handleRowAction,this),this.isStringArray=!1},mapModelData:function(a){a.data=a.data||[]},render:function(){this._super(),this.$tableE=Trillo.findAndSelf(this.$e,"table");var a=this.modelData();if(a.length&&"string"==typeof a[0]){this.isStringArray=!0;var b=[];$.each(a,function(){b.push({name:this})}),a=b}this.renderData(a)},renderData:function(a){this.clearRows(),this.setRowsData(a),this.addLastEmptyRow()},clearRows:function(){this.$e.find(".js-content-row").remove()},setRowsData:function(a){for(var b=0;b<a.length;b++){var c=this.appendNewRow(b);c.data("_row_data_",a[b]),this.updateElements(Trillo.getInputs(c),a[b])}},appendNewRow:function(a){var b=this.$templateE.clone(!0);return b.attr("row",""+a),this.$tableE.append(b),this.addRowEventHandler(b),b},_viewToData:function(a,b){a.length=0;var c,d=this.$e.find(".js-content-row"),e=this;$.each(d,function(){c=$(this);var d=Trillo.getInputs(c);if(!e.isEmpty(d)||b){var f=e.retrieveData(d);e.isStringArray?a.push(f.name):(f=$.extend(c.data("_row_data_"),f),a.push(f))}})},addRowEventHandler:function(a){var b=Trillo.getInputs(a);b.on("change",this.changeHandler),b=a.find(".js-row-tool"),b.on("click",this.rowActionHandler)},validate:function(){var a,b=this.$e.find(".js-content-row"),c=!0,d=this;return $.each(b,function(){a=$(this);var b=Trillo.getInputs(a);d.isEmpty(b)||(c=d._validate(b)&&c)}),c&=this._super()},isEmpty:function(a){var b=!0,c=a.serializeArray();return $.each(c,function(){var a=(this.name,this.value);return a&&""!==$.trim(a)?(b=!1,!1):void 0}),b},rowFieldChanged:function(a){if(this.fieldChanged(a)){var b=$(a.target);this.isLastRow(b)&&this.addLastEmptyRow()}},isLastRow:function(a){var b=this.getNumberOfRows(),c=this.getRowIndex(a);return c===b-1},getNumberOfRows:function(){return this.$e.find(".js-content-row").length},handleRowAction:function(a){var b=$(a.target);switch(b.attr("nm")){case"up":this.moveRow(b,-1);break;case"down":this.moveRow(b,1);break;case"add":this.addRowBefore(b);break;case"delete":this.deleteRow(b)}},moveRow:function(a,b){var c=this.getRowIndex(a)+b;if(!(0>c)){var d=this.getNumberOfRows();c>=d||(0>b?this.$e.find('[row="'+c+'"]').before(a.closest("tr")):this.$e.find('[row="'+c+'"]').after(a.closest("tr")),this.reorder(),this._viewToData(this.modelData(),!1))}},addRowBefore:function(a){var b=this.$templateE.clone(!0);a.closest("tr").before(b),this.addRowEventHandler(b),this.reorder(),this._viewToData(this.modelData(),!1)},deleteRow:function(a){a.closest("tr").remove(),0===this.getNumberOfRows()?this.appendNewRow(0):this.reorder(),this._viewToData(this.modelData(),!1)},reorder:function(){var a=this.$e.find(".js-content-row"),b=0;$.each(a,function(){$(this).attr("row",b++)})},getRowIndex:function(a){return parseInt(a.closest("tr").attr("row"),10)},removeLastRowIfEmpty:function(){var a=this.$e.find(".js-content-row").last();this.isEmpty(a)&&a.remove()},addLastEmptyRow:function(){!this.editable||!this.allowsNewRow||0!==this.modelData().length&&this.isEmpty(Trillo.getInputs(this.$e.find(".js-content-row").last()))||this.appendNewRow(this.getNumberOfRows())},setAllowsNewRow:function(a){a!==this.allowsNewRow&&(this.allowsNewRow=a,a?this.addLastEmptyRow():this.removeLastRowIfEmpty())},updateModelData:function(a,b){this._viewToData(this.modelData(),!1)},getObjForField:function(a){var b=this.getRowIndex(a);return this.modelData()[b]}}),Trillo.ChartView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c),this.setupView(),this.charts=[],this.$chartContainers=[]},setupView:function(){this.$chartE=this.$e.find(".js-chart-cell"),this.$chartE.remove()},mapModelData:function(a){a.data=a.data||[]},render:function(){this.controller().updateTitle(),this._super(),this.renderCharts()},clear:function(){this._super(),this.chart=null},windowResized:function(){if(!this.cleared){this._super();for(var a=0;a<this.charts.length;a++)this.charts[a].resize()}},loadPage:function(a){$.when(this.model().loadData(a)).done($.proxy(this.pageLoaded,this))},pageLoaded:function(a){},renderCharts:function(){if(this.viewSpec.charts){var a=Trillo.chartManager.getChartList(this.viewSpec.charts);a.done($.proxy(this._renderCharts,this))}},_renderCharts:function(a){var b,c=this.$chartContainers;for(b=0;b<c.length;b++)c[b].remove();if(this.$chartContainers.length=0,this.charts.length=0,c=this.viewSpec.charts)for(b=0;b<a.length;b++)this.renderChart(a[b])},renderChart:function(a){debug.debug("Rendering chart: "+a.name),"pie"===a.type?this.renderPieChart(a):this.renderXYChart(a)},renderXYChart:function(a){var b,c,d,e,f=[],g=[],h=Trillo.listFromPage(this.modelData()),i=a.xAttr,j=a.yAttrs;for(f.push(i),e=0;e<h.length;e++)h[e][i]&&f.push(h[e][i]);for(g.push(f),e=0;e<j.length;e++){c=j[e],d=c,b=[],b.push(d);for(var k=0;k<h.length;k++)"undefined"!=typeof h[k][c]&&b.push(h[k][c]);g.push(b)}var l={x:i,columns:g,type:a.type},m=c3.generate({bindto:"#"+this.viewSpec.elemId+" .chart",data:l,axis:a.axis,legend:{show:!0},transition:{duration:0}});this.setChartElement(a,m)},renderPieChart:function(a){var b,c,d,e,f,g=[],h=Trillo.listFromPage(this.modelData()),i=a.xAttr,j=a.yAttrs;if(j&&0!==j.length){if(i){var k=j[0];for(e=0;e<h.length;e++)f=[],f.push(h[e][i]),f.push(h[e][k]),g.push(f)}else for(d=0;d<j.length;d++){for(b=j[d],c=b,f=[],f.push(c),e=0;e<h.length;e++)"undefined"!=typeof h[e][b]&&f.push(h[e][b]);g.push(f)}var l={columns:g,type:a.type},m=null;a.label&&(m={label:{format:function(b,c,d){return b+" "+a.label}}});var n=c3.generate({data:l,pie:m});this.setChartElement(a,n)}},setChartElement:function(a,b){var c=this.$chartE.clone(!0);this.$chartContainers.push(c),this.$e.append(c),c.find(".js-chart")[0].appendChild(b.element),c.find(".js-title").html(a.displayName?a.displayName:""),this.charts.push(b)},createTestData:function(){var a=[],b=new Date;b.setTime(b.getTime()-864e5);for(var c=0;10>c;c++)a.push({timeStamp:b.getTime(),cpuUsage:Math.floor(Math.random()*(c%4===0?20:10))+1,cpuReady:Math.floor(Math.random()*(c%4===0?10:5))+1,cpuMhz:Math.floor(Math.random()*(c%4===0?150:600))+1,memoryMb:Math.floor(Math.random()*(c%4===0?20:100))+1,memorySwapOut:Math.floor(Math.random()*(c%4===0?1:5))+1,memorySwapIn:Math.floor(Math.random()*(c%4===0?1:3))+1,itemName:"Time-"+c}),b.setTime(b.getTime()+18e5);this.model().data={items:a}}}),Trillo.ContentView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c)},doInternalRouting:function(a,b){var c=a.length-b;0>c&&(c=0);for(var d=this.$e,e=Trillo.findAndSelf(d,'[nm="'+this.name+'"]'),f="",g=0;c>g;g++){var h=d.find('[nm="'+a[b+g].name+'"]');h.length>0&&(e=h),f=f+(g>0?"/":"")+a[b+g].name}if(this.internalRoute=f,d.find(".js-pointed").remove(),e){var i=$("<span></span>");i.addClass(Trillo.CSS.pointed+" js-pointed");var j=e.find(":first-child").filter(":header");if(j.length){j=$(j[0]),j.prepend(i);var k=parseInt(j.css("height"),10)/2;i.css("top",k);var l=this.parentView();l&&l.synchWithRouteState(e.attr("nm"))}this.scrollIntoView(e)}return c},scrollIntoView:function(a){var b=this.$e.offset().top;a.offset().top-b;setTimeout(function(){$(window).scrollTop(a.offset().top-b)},0)}}),Trillo.TocView=Trillo.ViewSelectionView.extend({itemCss:".js-item",initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this),this.mouseOverHandler=$.proxy(this.onMouseOver,this),this.mouseOutHandler=$.proxy(this.onMouseOut,this),this.delayedOnMouseOut=$.proxy(this._onMouseOut,this)},postShow:function(a){this.$e.on("mouseover",this.mouseOverHandler),this.$e.on("mouseout",this.mouseOutHandler),this._super(a)},clear:function(){this.$e.off("mouseover",this.mouseOverHandler),this.$e.off("mouseout",this.mouseOutHandler),this._super()},getNextViewName:function(a){var b=this.$e.find(".js-item");return b.length>0?b.attr("nm"):null},_getNextViewName:function(a){return null},routingToNextView:function(a,b){for(var c=a.length,d=c-1;d>=b&&!this.synchWithRouteState(a[d].name);d--);},viewSelected:function(a){Trillo.contextMenuManager.hideCurrentContextMenu(),a&&a.preventDefault();var b=$(a.target).closest(this.itemCss),c=b.attr("nm");if(this.updateItemSelection(c)){var d=b.parents(this.itemCss);d=d.map(function(){return $(this).attr("nm")}).get();var e;e=d.length?d.join("/")+"/"+c:c,this.postViewSelected(e)}},clearTimeout:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},onMouseOver:function(){this.clearTimeout(),this.$e.find(".js-scrollbar").css("overflow","auto")},onMouseOut:function(){this.clearTimeout(),this.timer=setTimeout(this.delayedOnMouseOut,1e3)},_onMouseOut:function(){this.clearTimeout(),this.$e.find(".js-scrollbar").css("overflow","hidden")}}),Trillo.FileUploadC=Trillo.Controller.extend({allowedFileTypes:["jpg","png","gif"],initialize:function(a){this._super(a),this.allowedFileTypes=a.params.allowedFileTypes||this.allowedFileTypes},postViewShown:function(){var a=this.$elem(),b=this.viewSpec.params||{};this.$fileNameE=a.find('[nm="fileName"]'),this.$file=a.find('[nm="file"]'),this.$file.on("change",$.proxy(this.fileSelected,this)),a.find('[nm="uploadFile"]').on("click",$.proxy(this.uploadFile,this)),a.find("form").attr("action",b.uploadUrl),$.each(b,function(b,c){a.find('[nm="'+b+'"]').val(c)})},fileSelected:function(){var a=this.$file.val(),b=a.split(".").pop(),c=this.allowedFileTypes.indexOf(b.toLowerCase())<0;this.$fileNameE.val(c?"":a),c&&Trillo.alert.showError("Unsupported File Type","Only '"+this.allowedFileTypes.join()+"' files are allowed.")},uploadFile:function(a){return a&&(a.stopPropagation(),a.preventDefault()),""===$.trim(this.$fileNameE.val())?void Trillo.alert.showError("Missing File","Please choose a file from your computer to upload."):(Trillo.fileUploadForm=this,void this.$elem().find("form")[0].submit())},uploadFileCompleted:function(a){this.parent.fileSaved(a,this)},uploadFileFailed:function(a){Trillo.alert.showError("Error",a)},postShow:function(){Trillo.alert.clear()}}),Trillo.BaseActionH=Class.extend({initialize:function(a){this._controller=a.controller},controller:function(){return this._controller},informActionDone:function(a){this._controller&&this._controller.actionDone&&this._controller.actionDone(a)},handleAction:function(a,b,c,d){return!1}});