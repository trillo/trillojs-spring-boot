/*!
 * TrilloJS v0.5.0 (https://github.com/trillo/trillojs#readme)
 * Copyright 2016 Collager Inc.
 * Licensed under the MIT license
 */
Trillo.Controller=Trillo.BaseController.extend({initialize:function(a){this._super(a)},$elem:function(){return this._view.$elem()},$container:function(){return this._view.$container()},refreshAllViews:function(){return Trillo.builder.refresh(this._view)},refreshViews:function(a){return Trillo.builder.refresh(this._view,a)},getInternalRoute:function(){return this._view.internalRoute.length?"/"+this._view.internalRoute:""},selectAndRoute:function(a){return this._view.selectAndRoute(a)},showNamedMessagesAsError:function(a){this._view.showNamedMessagesAsError(a)},updateTitle:function(){this._view.updateTitle()},handleAction:function(a,b,c,d){return"close"===a?(this.close(),!0):"ok"===a?(this.ok(),!0):"upload"===a?(this.doUpload(),!0):"hide"===a?(this._view.hide(),!0):"_home"===a||"_appHome"===a?(Trillo.navHistory.setDisabled(!0),!1):"actionTool"!=this.viewSpec.type&&"menu"!=this.viewSpec.type?this.doTriggerNextView(a,b):!1},actionDone:function(a){this.viewSpec.postRenderer&&this.viewSpec.postRenderer(a.selectedObj._trillo_infoBlock),this.getSelectedObj()===a.selectedObj&&this._view.setTbState()},close:function(){this.closing&&this.closing(this._view),this._view.clear()},closing:function(a){var b=this.parentController();b&&b.closing&&b.closing(a)},ok:function(){this.viewSpec.type===Trillo.ViewType.Form&&this.submitForm()},doTriggerNextView:function(a,b){b||(b={});var c=this.viewSpec.getNextViewSpecByTrigger(a);if(c){if("actionTool"===c.type)return!1;if("page"===c.type)return!1;if(c.dialog)return this.showViewByName(c.name,b),!0;var d;return c.absoluteRoute?(d=c.name+";uid="+b.uid,this.setRoute(d)):(d=c.name,this.updateRoute(d)),!0}var e=this.parentController();if(e&&Trillo.isCollectionView(this.viewSpec.type)&&e.viewSpec.type===Trillo.ViewType.Tree){var f=e.view().tree.getItemByUid(b.uid);if(f)return e.selectAndRoute(b.uid)}return!1},doUpload:function(){this.showView(this.getFileUploadSpec())},getFileUploadSpec:function(){return{name:"FileUpload",type:Trillo.ViewType.Default,dialog:!0,container:"trillo-dialog-container",controller:"Trillo.FileUploadC",modelSpec:{data:{fileName:"a"}},params:{targetViewName:this.viewSpec.name,folder:"",uploadUrl:"/fileUpload"}}},fileUploadSuccessful:function(a){this.viewSpec.dialog&&this.close()},fileUploadFailed:function(a){this.showFileUploadError(a.error)},showFileUploadError:function(a){this.$elem().find(".js-upload-alert").html(a).show()},clearFileUploadError:function(a){this.$elem().find(".js-upload-alert").html("").hide()},submitForm:function(){if(this._view.canSubmit()){var a=this.modelData();if(!this.beforePost(a,this._view))return;var b,c,d=$.proxy(this.submitFormCompleted,this),e=this.viewSpec;b=a,c=e.postUrl,$.ajax({url:c,type:"post",data:Trillo.stringify(b),contentType:"application/json"}).done(d)}},getFormSubmitUrl:function(){return"/submitForm"},submitFormCompleted:function(a){"failed"===a.status?this.showNamedMessagesAsError(a.namedMessages):(this.clear(),this.viewSpec.dialog&&this.close()),this.afterPost(a,this.view())},beforePost:function(a,b){var c=this.parentController();return c?c.beforePost(a,b):!0},afterPost:function(a,b){var c=this.parentController();c?c.afterPost(a,b):("failed"!==a.status&&(b||this.view()).$e.find("form")[0].reset(),this.showResult(a))}}),Trillo.Tools=Class.extend({initialize:function(a){this.mgr=a.mgr,this.$toolsE=a.$toolsE,this.$toolsContainer=a.$toolsContainer,this.toolSelectedMethod=$.proxy(this.toolSelected,this),this.actionablToolElems=[],this.makeActionableToolElemsList(this.$toolsE,this.actionablToolElems)},activate:function(){this.$toolsContainer&&this.$toolsContainer.append(this.$toolsE),this.$toolsE.is(".js-app-managed-visibility")||this.$toolsE.removeClass("hide"),this.$toolsE.css("display",""),this.$toolsE.off("click",this.toolSelectedMethod),this.$toolsE.on("click",this.toolSelectedMethod)},clear:function(){this.$toolsE.off("click",this.toolSelectedMethod),this.$toolsE.addClass("hide"),this.$toolsContainer&&this.$toolsE.remove()},toolSelected:function(a){Trillo.hideCurrentOverlays(!0,!1);var b=Trillo.getActualTarget(a);if(b&&!b.hasClass("dropdown-toggle"))if(a&&a.stopPropagation(),b.closest("."+Trillo.CSS.buttonGroup+"."+Trillo.CSS.buttonGroupOpen).removeClass(Trillo.CSS.buttonGroupOpen),b.closest("."+Trillo.CSS.dropdown+"."+Trillo.CSS.dropdownOpen).removeClass(Trillo.CSS.dropdownOpen),this.mgr.handleClickGeneric(b))$(".js-navbar-toggle").each(function(){$($(this).data("target")).removeClass("in").addClass("collapse")}),a.preventDefault();else{var c=b.prop("tagName").toLowerCase();if("a"===c){var d=b.attr("href");d&&"#"!==d||a.preventDefault()}}},setDisabled:function(a){a?(this.$toolsE.find("button").attr("disabled",!0),this.$toolsE.find("a").attr("disabled",!0)):(this.$toolsE.find("button").removeAttr("disabled"),this.$toolsE.find("a").removeAttr("disabled"))},makeActionableToolElemsList:function(a,b){var c=this;$.each(a.children(),function(a,d){var e=$(d),f=e.prop("tagName").toLowerCase();e.hasClass("js-tool")||"a"===f||"button"===f?b.push(e):c.makeActionableToolElemsList(e,b)})},allHidden:function(){for(var a=this.actionablToolElems,b=0;b<a.length;b++)if(!a[b].hasClass("hide")&&"none"!==a[b].css("display"))return!1;return!0}}),Trillo.ToolManager=Class.extend({initialize:function(a){this._view=a,this._controller=a.controller(),this.toolbarTools=null,this.hoverTools=null,this.contextTools=null,this.tools=[];var b=this,c=a.$elem();if("menu"!=a.viewSpec.type){if(a.$container()){var d=a.getToolBar$Elem();d.length>0&&(this.toolbarTools=this.makeTools(c.find(".js-toolbar-tools"),d,!0))}this.hoverTools=this.makeTools(c.find(".js-hover-tools"),null,!0),this.contextTools=this.makeTools(c.find(".js-context-menu"),null,!0),c.find(".js-tool").each(function(){b.makeTools($(this),null,!1)})}else c.find(".js-menu-item-trigger, .js-menu-item a, .js-menu-item button, .js-menu-item :input[type=button], .js-menu-item :input[type=submit], .js-menu-item :input[type=reset]").each(function(){b.makeTools($(this),null,!1)});c.find(".js-popover-trigger").each(function(){b.makePopover($(this))})},makeTools:function(a,b,c){if(Trillo.belongsToView(a,this._view.name)){a.data("for-view",this._view.name),c&&a.remove();var d=new Trillo.Tools({$toolsE:a,$toolsContainer:b,mgr:this});return this.tools.push(d),d}return null},makePopover:function(a){return Trillo.belongsToView(a,this._view.name)&&(a.data("for-view",this._view.name),Trillo.popoverManager.createPopoverForTrigger(a)),null},activate:function(){for(var a=this.tools,b=0;b<a.length;b++)a[b].activate();this.setTbState(null),this._controller.postToolsActivate()},clear:function(a){for(var b=this.tools,c=0;c<b.length;c++)b[c].clear()},handleClickGeneric:function(a){return this._controller.handleClickGeneric(a)?(Trillo.popoverManager.hideCurrentPopupIfContains(a),!0):!1},setTbState:function(a){var b,c=this.tools,d=a&&a.availabilityState===Trillo.OBJ_LOCKED;for(b=0;b<c.length;b++)Trillo.findAndSelf(c[b].$toolsE,"[data-for-class]").addClass("hide"),c[b].setDisabled(d);if(a){var e=Trillo.uidToClass(a.uid);if(e)for(b=0;b<c.length;b++)Trillo.findAndSelf(c[b].$toolsE,'[data-for-class="'+e+'"]').css("display","").removeClass("hide");for(b=0;b<c.length;b++)!c[b].$toolsE.is(":not([data-for-class])")||c[b].$toolsE.is(".js-context-menu")||c[b].$toolsE.is(".js-app-managed-visibility")||c[b].$toolsE.css("display","").removeClass("hide")}this._controller.updateTbState(a)},setPopoverTriggerState:function(a,b){var c,d,e=this.tools,f=this._view.$elem();if(!b)for(d=0;d<e.length&&!(b=!e[d].allHidden());d++);return f.find(".js-popover-trigger").each(function(){c=$(this),b?c.removeClass("trillo-trigger-has-no-content"):c.addClass("trillo-trigger-has-no-content")}),b},showContextMenu:function(a,b){return this.contextTools&&(this._controller.beforeShowContextMenu(this.contextTools.$toolsE),!this.contextTools.allHidden())?(Trillo.contextMenuManager.showContextMenu(this.contextTools.$toolsE,a,b),!0):!1},setToolVisible:function(a,b){var c='[nm="'+a+'"]';this.setToolVisibleBySelector(c,b)},setToolVisibleBySelector:function(a,b){var c,d=this.tools;if(b)for(c=0;c<d.length;c++)Trillo.findAndSelf(d[c].$toolsE,a).css("display","").removeClass("hide");else for(c=0;c<d.length;c++)Trillo.findAndSelf(d[c].$toolsE,a).addClass("hide")},removeToolsWithInElement:function(){for(var a=this.tools,b=[],c=0;c<a.length;c++)a[c].$toolsE.hasClass(".js-tool")?a[c].clear(this):b.push(a[c]);this.tools=b},addToolsWithInElement:function(a){var b=a.find(".js-tool");if(Trillo.belongsToView(b,this._view.name)){var c=new Trillo.Tools({$toolsE:b,mgr:this});return this.tools.push(c),c}return null},enableTool:function(a,b){var c='[nm="'+a+'"]';this.enableToolBySelector(c,b)},enableToolBySelector:function(a,b){var c,d=this.tools;if(b)for(c=0;c<d.length;c++)Trillo.findAndSelf(d[c].$toolsE,a).removeAttr("disabled");else for(c=0;c<d.length;c++)Trillo.findAndSelf(d[c].$toolsE,a).attr("disabled","disabled")}}),Trillo.InfoElementRepo=Class.extend({initialize:function(){this.table={},this.tableOfList={}},addTemplate:function(a,b){a.show(),this.table[b]=new Trillo.InfoElement(b,a,!0)},getE:function(a,b){var c=this.tableOfList[a];if(c&&c.length>0)return c.pop();var d=this.table[a];return d?d.copyIt(b):null},releaseE:function(a){if(!a.useTemplate){var b=this.tableOfList[a.elemKey];b||(this.tableOfList[a.elemKey]=b=[]),b.push(a),a.clear()}},makeInfoBlockList:function(a,b,c){var d=this.table[a];return d?d.requiresPositioning?this.makePositionedInfoBlockList(d,a,b,c):this.makeAutoInfoBlockList(d,a,b,c):null},makePositionedInfoBlockList:function(a,b,c,d){var e,f=[];a.$rootE.addClass(Trillo.CSS.positionOutside),d.canvasE.appendChild(a.e);var g,h,i,j,k,l,m,n,o=0,p="table"===d.parent.viewSpec.type,q=a.colWidths;for(p&&!q&&d.$headerRow&&(i=d.$headerRow,i.addClass(Trillo.CSS.positionOutside),d.$canvasE.append(i),j=d.$canvasE.width(),k=j,l=d.$headerRow.children(),l.length&&(l.each(function(){m=$(this),k-=m.width()}),q=[],k/=l.length,l.each(function(){m=$(this),n=Math.round((m.width()+k)/j*100),m.css("width",n+"%"),q.push(n)}),l=a.$rootE.children(),h=0,l.each(function(){h<q.length&&(m=$(this),m.css("width",q[h]+"%"),h++)})),i.removeClass(Trillo.CSS.positionOutside)),h=0;h<c.length;h++)c[h]._trillo_infoBlock||(e=new Trillo.InfoBlock(b,c[h],d),a.show(c[h],e),g=e.h=a.$rootE.outerHeight(),e.contentH=a.$rootE.height(),g>o&&(o=g),e.w=a.$rootE.outerWidth(),f.push(e),c[h]._trillo_infoBlock=e,a.clear());if(d.areAllSameSize)for(h=0;h<f.length;h++)f[h].contentH+=o-f[h].h,f[h].h=o;return a.$rootE.removeClass(Trillo.CSS.positionOutside),a.clear(),d.canvasE.removeChild(a.e),f},makeAutoInfoBlockList:function(a,b,c,d){for(var e,f=[],g=0;g<c.length;g++)c[g]._trillo_infoBlock||(e=new Trillo.InfoBlock(b,c[g],d),f.push(e),c[g]._trillo_infoBlock=e);return f},requiresLayout:function(a){var b=this.table[a];return b&&b.requiresPositioning}}),Trillo.InfoElement=Class.extend({initialize:function(a,b,c){if(this.$rootE=b,this.elemKey=a,this.e=b[0],this.elements=[],this.hasTemplateTokens=!1,this.requiresPositioning=!0,c){var d=b[0].outerHTML;if(d.indexOf("{{")>=0){debug.debug("Trillo.InfoElement - parsing using Mustache");var e=Mustache.parse(d);e.length>1?(debug.debug("Trillo.InfoElement - requires template processing while doing copyIt"),this.templateHtml=d,this.useTemplate=!0):debug.debug("Trillo.InfoElement - no template processing needed")}else debug.debug("Trillo.InfoElement - no template parsing done");b.hide(),document.body.appendChild(b[0]);var f=b.css("position");document.body.removeChild(b[0]),b.show(),this.requiresPositioning=f&&"absolute"===f.toLowerCase()}for(var g,h=this.e.getElementsByTagName("*"),i=0;i<h.length;i++)g=h[i],!Trillo.isActionElement($(g))&&g.getAttribute("nm")&&this.elements.push(g);this.$inputs=Trillo.getInputs(b)},show:function(a,b){for(var c,d,e,f,g=this.elements,h=g.length,i=0;h>i;i++)c=$(g[i]),f=c.dataOrAttr("nm"),Trillo.setFieldValue(c,a[f],!1);var j=b.contentH;this.$rootE.hasClass("js-content-row")&&j&&(this.$rootE.height(j),this.$rootE.children().each(function(){d=$(this),d.height(j),e=d.children(),0===e.length?d.css("line-height",j+"px"):1===e.length&&e.css("margin-top",(j-e.outerHeight())/2+"px")}))},clear:function(){for(var a,b=this.elements,c=b.length,d=0;c>d;d++)a=b[d],Trillo.setFieldValue($(a),null,!1)},copyIt:function(a){var b;if(this.useTemplate){var c=Mustache.render(this.templateHtml,a);b=$("<div/>").html(c).contents()}else b=this.$rootE.clone();var d=new Trillo.InfoElement(this.elemKey,b,!1);return d.useTemplate=this.useTemplate,d.requiresPositioning=this.requiresPositioning,d}}),Trillo.InfoBlock=Class.extend({initialize:function(a,b,c){this.elemKey=a,this.obj=b,this.canvas=c,this.x=0,this.y=0,this.h=-1,this.w=-1,this.infoE=null,this.clickHandler=$.proxy(this.clicked,this),this.dblClickHandler=$.proxy(this.dblClicked,this),this.contextMenuHandler=$.proxy(this.onContextMenu,this),c.supportsHoverTools&&(this.mouseOverHandler=$.proxy(this.mouseOver,this),this.mouseLeaveHandler=$.proxy(this.mouseLeave,this)),this.changeHandler=$.proxy(this.fieldChanged,this)},show:function(){var a=this.infoE;a?this.canvas.canvasE.appendChild(a.e):(this.infoE=a=Trillo.infoElementRepo.getE(this.elemKey,this.obj),a.requiresPositioning,this.canvas.canvasE.appendChild(a.e),a.show(this.obj,this)),a.requiresPositioning&&a.$rootE.css({left:this.x,top:this.y}),a.$rootE.off("click",this.clickHandler),a.$rootE.on("click",this.clickHandler),a.$rootE.off("dblclick",this.dblClickHandler),a.$rootE.on("dblclick",this.dblClickHandler),a.$rootE.off("contextmenu",this.contextMenuHandler),a.$rootE.on("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.$rootE.off("mouseover",this.mouseOverHandler),a.$rootE.on("mouseover",this.mouseOverHandler)),a.$inputs.length>0&&(a.$inputs.off("change",this.changeHandler),a.$inputs.on("change",this.changeHandler)),this.canvas.postRenderer&&this.canvas.postRenderer(this)},refresh:function(){this.infoE&&(this.infoE.show(this.obj,this),this.canvas.postRenderer&&this.canvas.postRenderer(this))},hide:function(){var a=this.infoE;a&&(a.$rootE.off("click",this.clickHandler),a.$rootE.off("dblclick",this.dblClickHandler),a.$rootE.off("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.$rootE.off("mouseover",this.mouseOverHandler),a.$rootE.off("mouseleave",this.mouseLeaveHandler)),Trillo.infoElementRepo.releaseE(a),this.canvas.selected===this&&this.canvas.unselectInfoItem(this),a.$inputs.length>0&&a.$inputs.off("change",this.changeHandler),this.infoE=null)},setPosition:function(a,b){this.x=a,this.y=b},move:function(a,b){this.x+=a,this.y+=b},clicked:function(a){Trillo.hideCurrentOverlays(!0,!1);var b=!1;if(a&&!$(a.target).is(":input")){a.stopPropagation();var c=$(a.target);if("a"==c.prop("tagName").toLowerCase()){var d=c.attr("href");d&&"#"!==d||(b=!0)}}(this.canvas.clicked(this,a)||b)&&a.preventDefault()},dblClicked:function(a){Trillo.hideCurrentOverlays(!0,!1),a&&!$(a.target).is(":input")&&a.stopPropagation(),this.canvas.dblClicked(this,a)},onContextMenu:function(a){a.stopPropagation(),this.canvas.doContextMenu(this,a.pageX,a.pageY)&&a.preventDefault()},select:function(){this.infoE&&this.infoE.$rootE.addClass(Trillo.CSS.selected)},unselect:function(){this.infoE&&this.infoE.$rootE.removeClass(Trillo.CSS.selected)},mouseOver:function(a){var b=this.infoE;return b.$rootE.off("mouseover",this.mouseOverHandler),b.$rootE.on("mouseleave",this.mouseLeaveHandler),this.canvas.setHoverInfoItem(this),!0},mouseLeave:function(a,b){var c=this.infoE;c.$rootE.on("mouseover",this.mouseOverHandler),c.$rootE.off("mouseleave",this.mouseLeaveHandler),this.canvas.setHoverInfoItem(null)},fieldChanged:function(a){var b=$(a.target),c=b.dataOrAttr("nm"),d=Trillo.getFieldValue(b);this.canvas.changeAttr(this.obj,c,d)}}),Trillo.infoElementRepo=new Trillo.InfoElementRepo,Trillo.Canvas=Class.extend({initialize:function(a,b){if(this.areAllSameSize=!0,this.parent=a,this.$c=a.$container(),this.$canvasE=a.$e.hasClass("js-grid")?a.$e:a.$e.find(".js-grid"),this.canvasE=this.$canvasE[0],this.virtual=b.virtual,this.elemKey=b.elemKey,this.isListViewMode=b.isListViewMode,this.$headerRow=b.$headerRow,this.dialog=b.dialog,this.postRenderer=b.postRenderer,this.loadingData=!0,this.scrollListener=$.proxy(this.doScrolling,this,!1),this.actualScrollHandler=$.proxy(this._doScrolling,this),this.showListHandler=$.proxy(this.doShowList,this),this.scrollTimer=null,this.actualScrollTimer=null,this.showTimer=null,this.isScrollListenerAdded=!1,this.nonNativeSB=a.$_sb,Trillo.isTouchSurface&&!this.nonNativeSB&&document.addEventListener("touchstart",$.proxy(this.scrollListener,this)),this.$pagination=$(".js-pagination"),this.selected=null,this.supportsHoverTools=!1,b.canvasToolsSelector){var c=$(b.canvasToolsSelector);c.length>0&&(this.canvasTools=new Trillo.Tools({$toolsE:c,mgr:this}),this.canvasTools.actionHandler=this,this.supportsHoverTools=!0)}var d=this.$canvasE;this.sortM=$.proxy(this.doSort,this);var e=d.attr("row-gap");this.rowGap=e?parseInt(e,10):Trillo.Options.V_MARGIN,e=d.attr("top-row-gap"),this.topRowGap=e?parseInt(e,10):Trillo.Options.V_MARGIN_TOP_ROW,e=d.attr("col-gap"),this.colGap=e?parseInt(e,10):Trillo.Options.H_MARGIN,e=d.attr("max-cols"),this.maxCols=e?parseInt(e,10):-1,e=d.attr("h-align"),this.hAlign=e||"auto",e=d.attr("auto-select"),this.autoSelect=e&&"true"===e.toLowerCase()},windowResized:function(){this.layout(),this.showChildren(),this.updatePagination()},clear:function(){this.$canvasE.empty(),this.$headerRow&&this.$headerRow.find("[sortable]").off("click",this.sortM),this.page&&this.page.items&&$.each(this.page.items,function(){this._trillo_infoBlock=void 0}),this.page=null,this.infoBlocks=null,this.clearShowTimer(),this.clearScrollTimer(),this.clearActualScrollTimer(),this.$pagination.hide(),this.removeScrollListener(),this.setScrollBarPos(0)},setScrollBarPos:function(a){this.nonNativeSB?this.parent.setScrollBarPos(0):$(window).scrollTop(0)},getScrollBarPos:function(){return this.nonNativeSB?this.parent.getScrollBarPos():$(document).scrollTop()},objAdded:function(a,b){var c=Trillo.infoElementRepo.makeInfoBlockList(this.elemKey,[a],this);if(this.infoBlocks)if(b)this.infoBlocks=this.infoBlocks.concat(c);else for(var d=c.length-1;d>=0;d--)this.infoBlocks.unshift(c[d]);else this.infoBlocks=c;this.refresh(),b&&this.setScrollBarPos(this.contentH)},objChanged:function(a){a._trillo_infoBlock&&a._trillo_infoBlock.refresh()},setContent:function(a){this.addScrollListener(),this.loadingData=!1;var b=Trillo.infoElementRepo.makeInfoBlockList(this.elemKey,a.items,this);this.infoBlocks?this.infoBlocks=this.infoBlocks.concat(b):this.infoBlocks=b||[],this.page=a,this.refresh()},refresh:function(a){this.$canvasE.empty(),this.showHeader(),this.layout(),this.showChildren(),this.updatePagination(),this.parent.updateScrollBar()},showHeader:function(){var a=this.$headerRow;return a&&a.length>0?(this.canvasE.appendChild(a[0]),a.find("[sortable]").off("click",this.sortM),a.find("[sortable]").on("click",this.sortM),a.outerHeight()):0},layout:function(){Trillo.infoElementRepo.requiresLayout(this.elemKey)&&this._layout()},_layout:function(){var a,b,c,d,e,f=this.infoBlocks,g=f.length,h=0,i=0;this.$headerRow&&this.$headerRow.css("top",this.$canvasE.offset().top),this.isListViewMode?(e=1,d=$(this.$canvasE).width()):(d=(g>0?f[0].w:0)+this.colGap,e=Math.floor(($(this.$canvasE).width()-this.colGap)/d),0>=e&&(e=1),this.maxCols>0&&e>this.maxCols&&(e=this.maxCols),1===e&&(d-=this.colGap));var j=this.showHeader();0===j&&(j=this.isListViewMode?0:this.topRowGap);var k,l=[];for(k=0;e>k;k++)l[k]=j;var m,n=0,o=null,p=null;for(k=0;g>k;k++){p=o,o=f[k],n=0,m=l[0];for(var q=1;q<l.length;q++)l[q]<m&&(0===l[q]||m-l[q]>50)&&(m=l[q],n=q);c=l[n],b=d*n,o.setPosition(b,c),a=b+d,a>h&&(h=a),a=c+o.h+(this.isListViewMode?0:this.rowGap),l[n]=a,a>i&&(i=a)}0===i&&(i=j),this.contentW=this.$canvasE.outerWidth(),this.contentH=i+(this.page.pageNumber<this.page.numberOfPages?Trillo.Options.BOTTOM_SPACE_FOR_INF_SCROLL:0),this.$canvasE.css({height:this.contentH});var r=this.hAlign;if(!this.isListViewMode&&"left"!==this.hAlign){var s=Math.floor((this.contentW-h)/2);if("auto"===r&&s>h/4?s=0:"right"==r&&(s=2*s),s>0)for(k=0;g>k;k++)o=f[k],o.move(s,0)}!this.dialog&&this.$headerRow&&this.$headerRow.css({width:this.contentW}),this.updateContainerGeom()},showChildren:function(){this.virtual&&Trillo.infoElementRepo.requiresLayout(this.elemKey)?this.showSomeChildren():this.showAllChildren()},showSomeChildren:function(){if(!this.loadingData){this.clearShowTimer(),this.showList=[];var a,b,c,d,e,f=$(window).height()-this.$canvasE.offset().top;a=c=this.getScrollBarPos(),b=d=a+f,a-=5*f,0>a&&(a=0),b+=5*f,b>a+this.contentH&&(b=a+this.contentH);var g,h=this.infoBlocks,i=h.length;for(g=0;i>g;g++){var j=h[g];if(j.y>b)j.hide(!0);else{var k=j.y+j.h;a>=k?j.hide(!0):(e=k>=c&&j.y<=d,e?j.show():j.shown||this.showList.push(j))}}$(".js-load-indicator-top").hide(),$(".js-load-indicator-bottom").hide(),d>=this.contentH&&(this.loadingData=this.loadNextPage(),this.loadingData?$(".js-load-indicator-bottom").show():this.noMoreItems=!0),this.showList.length>0&&(this.showTimer=setTimeout(this.showListHandler,200))}},showAllChildren:function(){if(!this.loadingData){this.clearShowTimer();for(var a=this.infoBlocks,b=a.length,c=0;b>c;c++){var d=a[c];d.show()}}},doShowList:function(){for(var a=this.showList,b=a.length,c=0;b>c;c++)a[c].show()},clearShowTimer:function(){this.showTimer&&(clearTimeout(this.showTimer),this.showTimer=null)},loadNextPage:function(){return this.page.pageNumber<this.page.numberOfPages?(this.parent.loadPage(this.page.pageNumber+1),!0):!1},addScrollListener:function(){this.virtual&&(this.isScrollListenerAdded||(this.isScrollListenerAdded=!0,this.nonNativeSB?this.parent.$_sb.bind("scroll",this.scrollListener):$(window).bind("scroll",this.scrollListener)))},removeScrollListener:function(){this.isScrollListenerAdded&&(this.isScrollListenerAdded=!1,this.nonNativeSB?this.parent.$_sb.unbind("scroll",this.scrollListener):$(window).unbind("scroll",this.scrollListener))},doScrolling:function(a){if(this.clearScrollTimer(),this.updatePagination(),this.loadingData)return void(this.scrollTimer=setTimeout(this.scrollListener,200));this.clearActualScrollTimer(),this.clearShowTimer();var b=this.getScrollBarPos(),c=b+$(window).height()-this.$canvasE.offset().top;(Trillo.isTouchSurface||this.nonNativeSB)&&c<this.contentH?this.actualScrollTimer=setTimeout(this.actualScrollHandler,100):this._doScrolling()},updatePagination:function(){if(this.virtual){for(var a,b,c=this.getScrollBarPos(),d=c+$(window).height()-this.$canvasE.offset().top,e=this.infoBlocks,f=e.length,g=-1,h=-1,i=0,j=0;f>j;j++)a=e[j],i++,b=a.y+a.h,b>=c&&a.y<=d-20&&(-1===g&&(g=i),h=i);this.$pagination.show(),this.$pagination.html(g+"-"+h)}else this.$pagination.hide()},_doScrolling:function(){this.showChildren()},clearScrollTimer:function(){this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null)},clearActualScrollTimer:function(){this.actualScrollTimer&&(clearTimeout(this.actualScrollTimer),this.actualScrollTimer=null)},clicked:function(a,b){this.parent.hideOverlaidContainer();var c=$(b.target);return Trillo.isActionElement(c)?(this.selected!==a&&this.selectInfoItem(a),this.parent.controller().handleClickGeneric(c)):(this.selectInfoItem(a),this.parent.clicked(a,b)?!0:!1)},dblClicked:function(a,b){this.parent.hideOverlaidContainer();var c=$(b.target);return Trillo.isActionElement(c)?(this.selected!==a&&this.selectInfoItem(a),this.parent.controller().handleClickGeneric(c)):this.parent.infoItemDblClicked(a,b)?!0:(this.selectInfoItem(a),!1)},doContextMenu:function(a,b,c){return this.selected!==a&&this.selectInfoItem(a),this.parent.showContextMenu(b,c)},handleClickGeneric:function(a){if(this.hoverInfoItem){var b=this.hoverInfoItem;this.selected!==b&&(this.selected&&this.selected.unselect(),this.selected=b,b.select(),this.parent.selectInfoItem(b)),this.parent.controller().handleClickGeneric(a)}},setHoverInfoItem:function(a){if(this.hoverInfoItem=a,a){if(a.obj.availabilityState===Trillo.OBJ_LOCKED)return;a.infoE.$rootE.append(this.canvasTools.$toolsE),this.canvasTools.activate()}else this.canvasTools.clear()},selectInfoItem:function(a){if(this.parent.canSelectionChange(a.obj)){if(this.parent.selectionChanging(a.obj),this.selected===a)return void this.unselectInfoItem(a);this.selected&&this.selected.unselect(),this.selected=a,a.select(),this.parent.selectInfoItem(a)}},unselectInfoItem:function(a){this.selected===a&&(this.parent.unselectInfoItem(a),a.unselect(),this.selected=null)},selectItemByUid:function(a){if(!a)return null;var b=this.parent.model().getObj(a);if(b&&b._trillo_infoBlock){var c=b._trillo_infoBlock;return c!==this.selected&&this.selectInfoItem(c),c}return null},updateContainerGeom:function(){var a=this.$canvasE.parent().css("position");"absolute"===a&&this.$canvasE.parent().height(this.$canvasE.outerHeight())},doSort:function(a){a.stopPropagation(),a.preventDefault(),this.parent.doSort(a)},changeAttr:function(a,b,c){this.parent.changeAttr(a,b,c)}}),Trillo.Tree=Class.extend({DEFAULT_NODE_TEMPLATE:'<div class="tree-node js-tree-node"><div class="trillo-tree-item js-tree-node-inner"><span nm="name"></span></div></div>',initialize:function(a){this.name="TrilloTree",this.parent=a.parent,this.alwaysOpen=a.alwaysOpen,this.scrollPolicy=a.scrollPolicy||Trillo.Options.NO_SCROLL,this.openOnFirstClick=a.openOnFirstClick,this.closeOthers=a.closeOthers,this.toc=a.toc,this.timer=null,this.$e=a.$e,this.$treeE=this.$e.find(".js-tree"),this.$treeNodes=[],this.prepareNodeTemplates(this.$treeE,0),this.lookupTable={},this.clickHandler=$.proxy(this.linkClicked,this),this.contextMenuHandler=$.proxy(this.onContextMenu,this),this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER&&(this.mouseOverHandler=$.proxy(this.onMouseOver,this),this.mouseOutHandler=$.proxy(this.onMouseOut,this),this.delayedOnMouseOut=$.proxy(this._onMouseOut,this))},clear:function(){this.clearTimeout(),this.removeEventHandlers()},prepareNodeTemplates:function(a){var b=a.find(".js-tree-node");if(0===b.length){if(0!==this.$treeNodes.length)return;b=$(this.DEFAULT_NODE_TEMPLATE)}else b=$(b[0]),b.remove();this.$treeNodes.push(b),this.prepareNodeTemplates(b)},newNode:function(a){var b=a>=this.$treeNodes.length?this.$treeNodes.length-1:a;return this.$treeNodes[b].clone(!0)},removeEventHandlers:function(){var a=this.$e;a.off("click",this.clickHandler),a.off("contextmenu",this.contextMenuHandler),this.mouseOverHandler&&(a.off("mouseover",this.mouseOverHandler),a.off("mouseout",this.mouseOutHandler))},addHandlers:function(){var a=this.$e;this.removeEventHandlers(),this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER&&(a.on("mouseover",this.mouseOverHandler),a.on("mouseout",this.mouseOutHandler)),a.on("click",this.clickHandler),a.on("contextmenu",this.contextMenuHandler)},getSelectedItem:function(){return this.selectedItem},getSelectedItemUid:function(){return this.selectedItem?this.selectedItem.uid:null},setTreeData:function(a,b){this.addHandlers(),this.parent.model().__treeSetup||(console.log("Setting tree"),this.parent.model().setupTreeData()),this.lookupTable=this.parent.model().table,this.unselectCurrent(),this.list=a,this.selectedItem=null,this.resetElements(a),this.$treeE.empty(),this.renderList(null,a,this.$treeE),this.alwaysOpen||b===Trillo.Options.OPEN_ALL?this.openAll():b===Trillo.Options.CLOSE_ALL&&this.closeAll()},renderList:function(a,b,c,d){for(var e=0;e<b.length;e++){var f=b[e],g=f._es_;g?(g.e.data("uid",f.uid),g.e.data("nm",f.uid),"undefined"!=typeof f.hideNode&&f.hideNode&&g.e.hide()):f._es_=g=this.renderElement(f),c.append(g.e)}this.parent.updateScrollBar()},renderElement:function(a){var b=a._lvl,c=this.newNode(b),d=c.find(".js-lvl-"+b);d.length&&(c=d),c.addClass(Trillo.CSS.treeNodeLevelPrefix+b),c.data("uid",a.uid),c.data("nm",a.uid);var e=c.find(".js-tree-node-inner");return this.canExpand(a)&&e.addClass(Trillo.CSS.itemClose),this.setFieldsValues(e,a),a.hideNode&&c.hide(),{e:c,e2:e,lvl:b}},setFieldsValues:function(a,b){for(var c,d=a.find("[nm]"),e=d.length,f=0;e>f;f++)c=$(d[f]),Trillo.setFieldValue(c,b[c.dataOrAttr("nm")],!1)},refresh:function(){this._refresh(this.list),this.parent.updateScrollBar()},_refresh:function(a){if(a)for(var b=0;b<a.length;b++){var c=a[b],d=c._es_;d&&(this.setFieldsValues(d.e2,c),this._refresh(c.children))}},resetElements:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b._es_=null,b.children&&this.resetElements(b.children)},linkClicked:function(a,b){var c=$(a.target).closest("."+Trillo.CSS.treeNode).dataOrAttr("uid");if(c){b||Trillo.hideCurrentOverlays(!0,!1),this.parent.hideOverlaidContainer();var d=this.lookupTable[c];if(b){if(d===this.selectedItem)return}else a.stopPropagation();if(d._isAction&&!b)return void this.parent.handleClickGeneric(d._es_.e,d);if(!this.parent.canSelectionChange(d))return;this.parent.selectionChanging(d);var e=d._es_,f=!0;if(!this.alwaysOpen&&this.canExpand(d)){var g=d===this.selectedItem||e.e2[0]===a.target,h=this.openOnFirstClick||g;e.open?g&&(this.closeItem(d),f=!1):h&&this.openItem(d)}d!==this.selectedItem&&this.selectItem(d,f,!b),this.parent.treeItemSelected(d)}},onContextMenu:function(a){a.stopPropagation();var b=$(a.target).closest("."+Trillo.CSS.treeNode).dataOrAttr("uid");if(b){var c=this.lookupTable[b],d=c._es_,e=d.e.offset();this.linkClicked(a,!0);var f=d.e.offset();this.parent.showContextMenu(a.pageX+f.left-e.left,a.pageY+f.top-e.top)?a.preventDefault():Trillo.hideCurrentOverlays(!0,!0)}},openItem:function(a){if(this.canExpand(a,this)){var b=a._es_;b&&b.open||(b||(a._es_=b=this.renderElement(a)),b.open=!0,this.renderList(a,a.children,b.e,b.e2),b.e2.removeClass(Trillo.CSS.itemClose).addClass(Trillo.CSS.itemOpen))}},closeItem:function(a){var b=a._es_;b&&(b.open=!1,b.e.find(".js-tree-node").remove(),this.canExpand(a,this)&&b.e2.removeClass(Trillo.CSS.itemOpen).addClass(Trillo.CSS.itemClose),b.e.append(b.e2))},openItem2:function(a){for(var b=[],c=a;c&&-1!==c._lvl;)b.push(c),c=c.parent;for(var d=b.length-1;d>=0;d--){c=b[d];var e=c._es_;e||(c._es_=e=this.renderElement(c)),this.openItem(c)}},selectItem:function(a,b,c){if(a!==this.selectedItem){var d,e=this.unselectCurrent();if(a&&(b&&this.openItem2(a),this.selectedItem=a,d=a._es_,d.e2.addClass(Trillo.CSS.selected),c&&this.scrollSelectedInView()),this.closeOthers&&c&&e){var f=this.getCloseableParent(e),g=a?this.getCloseableParent(a):{};f!==g&&f!==g.parent&&(this.closeItem(f),a&&this.scrollSelectedInView(!0))}}},unselectCurrent:function(){var a,b=this.selectedItem;return b&&(a=b._es_,a.e2.removeClass(Trillo.CSS.selected),this.selectedItem=null),b},selectItemByUid:function(a){if(!a||0===this.list.length)return!1;var b=this.lookupTable[a];return this.selectItem(b,!0,!0),b},getItemByUid:function(a){return this.lookupTable[a]},scrollSelectedInView:function(a){setTimeout($.proxy(this._scrollSelectedInView,this,a),100)},_scrollSelectedInView:function(a){if(this.selectedItem&&(a||this.scrollPolicy!==Trillo.Options.NO_SCROLL)){var b,c,d,e,f,g,h,i=this.selectedItem._es_,j=i.e,k=this.$e,l=k.offset().top;if(d=j.offset().top,this.scrollPolicy===Trillo.Options.SCROLL_ON_HOVER||this.scrollPolicy===Trillo.Options.AUTO_SCROLL||this.scrollPolicy===Trillo.Options.NON_NATIVE_SCROLLBAR)if(f=k.outerHeight(),b=k.scrollTop(),c=b+f,g=d-l+b,h=g+j.outerHeight(),this.scrollPolicy===Trillo.Options.NON_NATIVE_SCROLLBAR)b=g-parseInt((f-i.e2.outerHeight())/2,10),this.parent.setScrollBarPos(b);else{if(g>b&&c>h)return;e=k.css("overflow"),k.css("overflow","auto"),b=g-parseInt((f-i.e2.outerHeight())/2,10),k.scrollTop(b),"auto"!==e&&k.css("overflow","hidden")}else if(this.scrollPolicy===Trillo.Options.SMOOTH_SCROLL){b=document.viewport.getScrollOffsets().top,f=$(window).height()-l,c=b+f,g=d-l,h=g+j.outerHeight();var m=this.getTopParent(this.selectedItem);if(m!==this.selectedItem&&g>b&&c>h)return;var n=m._es_.e,o=n.offset().top;if(b=d-o+i.e2.outerHeight()<f?o-l-b+parseInt(i.e.css("padding-top"),10):g-parseInt((f-i.e2.outerHeight())/2,10)-b,0===b)return;var p=0>b?1:2;
b=Math.abs(b),this.smoothVScroll(b,p)}}},openAll:function(){this._openAll(this.list),this.parent.updateScrollBar()},_openAll:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.children.length&&(this.closeItem(a[c]),this.openItem(a[c]),this._openAll(b.children))},closeAll:function(){this._closeAll(this.list),this.parent.updateScrollBar()},_closeAll:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.children.length&&(this.closeItem(a[c]),this._closeAll(b.children))},clearTimeout:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},onMouseOver:function(){this.clearTimeout(),this.$e.css("overflow","auto")},onMouseOut:function(){this.clearTimeout(),this.timer=setTimeout(this.delayedOnMouseOut,1e3)},_onMouseOut:function(){this.clearTimeout(),this.$e.css("overflow","hidden")},getTopParent:function(a){if(!a)return null;for(;a.parent&&-1!==a.parent._lvl;)a=a.parent;return a},getCloseableParent:function(a){for(;a.parent&&!a.parent.closeOthers;)a=a.parent;return a},canExpand:function(a){return a?a.children&&a.children.length>0:!0},smoothVScroll:function(a,b){function c(){d=f>a?a:f,window.scrollBy(0,1===b?-d:d),a-=f,a>0&&setTimeout(c,g)}var d,e=100,f=10,g=30;a>e?(d=a-e,window.scrollBy(0,1===b?-d:d),a=e,setTimeout(c,g)):c()}}),Trillo.TitleBar=Class.extend({initialize:function(a){this.titleBar=a.titleBar,this.ownerView=a.ownerView,this.$titleBarE=$(a.titleBar)},setTitle:function(a,b,c){if(0!==this.$titleBarE.length){if(b=b||"",c=c||"",0===b.length)return void this.clearTitle(a);Trillo.HtmlTemplates.titleBarTitlePrefix&&!Trillo.HtmlTemplates.titleBarTemplates__parsed__&&(Mustache.parse(Trillo.HtmlTemplates.titleBarTitlePrefix),Mustache.parse(Trillo.HtmlTemplates.titleBarTitle),Mustache.parse(Trillo.HtmlTemplates.titleBarTitlePrefix2),Mustache.parse(Trillo.HtmlTemplates.titleBarTitle2),Trillo.HtmlTemplates.titleBarTemplates__parsed__=!0);var d,e="ol"===this.$titleBarE.prop("tagName").toLowerCase();d=this.$titleBarE.find('[nm="'+a+'-title-prefix"]'),c.length?d.length?d.html(c):d=this.$titleBarE.append(Mustache.render(e?Trillo.HtmlTemplates.titleBarTitlePrefix:Trillo.HtmlTemplates.titleBarTitlePrefix2,{viewName:a,titlePrefix:c})):d.length&&d.remove(),d=this.$titleBarE.find('[nm="'+a+'-title"]'),d.length?d.html(b):d=this.$titleBarE.append(Mustache.render(e?Trillo.HtmlTemplates.titleBarTitle:Trillo.HtmlTemplates.titleBarTitle2,{viewName:a,title:b}))}},clearTitle:function(a){0!==this.$titleBarE.length&&(this.$titleBarE.find('[nm="'+a+'-title-prefix"]').remove(),this.$titleBarE.find('[nm="'+a+'-title"]').remove())}}),Trillo.TitleBarManager=Class.extend({initialize:function(a){this.options=a,this.table={}},getTitleBar:function(a,b){return this.table[a]||(debug.debug("Adding titleBar: "+a),this.table[a]=new Trillo.TitleBar({titleBar:a,ownerView:b})),this.table[a]},viewCleared:function(a){var b=this,c=null;$.each(b.table,function(){return this.viewOwner===a?(c=this.titleBar,!1):void 0}),c&&(debug.debug("Removing titleBar: "+c),this.table[c].$titleBarE.html(""),this.table[c]=null)}}),Trillo.BaseView=Class.extend({initialize:function(a,b,c){this.$e=a,this.viewSpec=c,this.name=c.name,this._controller=b,this.$c=null,this._nextView=null,this._parentView=null,this._prevView=null,this.selected=null,this.cleared=!0,this.editable=!1,this.internalRoute="",this._embeddedViews=[],this._textNodes=[],this._attrNodes=[],this.mediaMinWidth=-1,b.setView(this),c.embedded||c.autoLoad?(this._parentView=c.prevView,this._parentView._embeddedViews.push(this),this._parentView.controller().addEmbeddedController(b)):(this._prevView=c.prevView,this._prevView&&(this._prevView._nextView=this,this._prevView.controller().setNextController(b)));var d=0;if(Trillo.isPreview?(c.container=c.container||"main-container",this.$c=this._getContainer(this.viewSpec.container),this.$c&&this.$c.css("width",0===d?"auto":d)):c.container?this.$c=this._getContainer(this.viewSpec.container):this.$c=a.parent().length>0?a.parent():null,this.$c){c.draggable=this.$c.hasClass("js-draggable"),c.dialog=c.dialog||this.$c.hasClass("js-dialog-container")||this.$c.hasClass("js-modal-dialog-container")||c.draggable,this.isModal=c.dialog&&this.$c.hasClass("js-modal-dialog-container"),this.viewSpec.draggable&&(this.dragHandleMouseDownM=$.proxy(this.mouseDownOnDragHandle,this),this.dragHandleMouseUpLeaveM=$.proxy(this.mouseUpLeaveDragHandle,this),this.dragHandleMouseMoveM=$.proxy(this.mouseMoveOnDragHandle,this));var e=this.$c.dataOrAttr("media-min-width");this.mediaMinWidth=e?parseFloat(e):-1}this.createEmbeddedViews(),c.layoutSpecs&&(c.layoutSpecs=Trillo.makeDependencyList(c.layoutSpecs))},_getContainer:function(a){var b,c=this.parentView();return c?(b=c.$e.find("[nm='"+a+"']"),b.length?b:c._getContainer(a)):$("[nm='"+a+"']")},createEmbeddedViews:function(){var a=this.viewSpec,b=a.embeddedSpecs;if(b&&b.length)for(var c=0;c<b.length;c++){var d=b[c],e=this.getEmbeddedViewElem(d);e&&e.length>0&&(debug.debug("Creating embedded view: "+d.name),e.data("for-view",d.name),Trillo.builder.createView(e,d,this))}},getEmbeddedViewElem:function(a){var b=null;return a.elementSelector&&(b=this.$e.find(a.elementSelector)),b||(b=this.$e.find('[nm="'+a.name+'"]')),b},init2:function(){debug.debug("init2() "+this.name);var a=this.$e.html(),b=a&&a.indexOf("{{")>=0;b&&this.$e.length&&this.processNode(this.$e[0],this._textNodes,this._attrNodes),this.toolsMgr=new Trillo.ToolManager(this);var c=this.$e.find(".js-multi-view");c.length&&Trillo.multiViewDelegator.manage(c,this),this.$e.find("[data-trigger]").each(function(){Trillo.popoverManager.createPopoverForContent($(this))}),this.$e.find("[trigger]").each(function(){Trillo.popoverManager.createPopoverForContent($(this))}),this.applyExternalElements(Trillo.multiViewDelegator.getByTarget(this.name))},processNode:function(a,b,c){var d,e,f;if(3===a.nodeType)d=a.nodeValue,d&&d.indexOf("{{")>=0&&b.push({textNode:a,text:d});else{if(!a.hasAttribute)return;var g=a.getAttribute("for-view")||a.getAttribute("data-for-view");if(g&&g!==this.name)return;var h=a.attributes;if(h){var i;for(e=0,f=h.length;f>e;++e)i=h[e],d=i.nodeValue,d&&d.indexOf("{{")>=0&&c.push({attrNode:i,text:d})}var j=a.childNodes;for(e=0,f=j.length;f>e;++e)this.processNode(j[e],b,c)}},$elem:function(){return this.$e},$container:function(){return this.$c},controller:function(){return this._controller},model:function(){return this._controller.model()},apiAdapter:function(){return this._controller.apiAdapter()},modelData:function(){return this._controller.modelData()},parentModelData:function(){var a=this.parentView();return a?a.modelData():null},mapModelData:function(a){},embeddedViews:function(){return this._embeddedViews},parentView:function(){return this._parentView||this._prevView},nextView:function(){return this._nextView},show:function(a){var b=$.Deferred();if(a||this.controller().isModelDataChanged()){debug.debug("View.show() - creating new model for: "+this.viewSpec.name);var c=this.viewSpec.modelSpec;this.updateModelSpec&&this.updateModelSpec(c),this.controller().updateModelSpec&&this.controller().updateModelSpec(c);var d=this.viewSpec.apiSpec;d&&this.controller().updateApiSpec&&this.controller().updateApiSpec(d);var e=this._controller.createModel(c,d);e.done($.proxy(this.showUsingModel,this,b)),e.fail(function(a){b.reject(a)})}else this.postShow(b),debug.debug("View.show() - no changes");return b.promise()},showUsingModel:function(a){this.mapModelData(this.model()),this._showUsingModel(a)},_showUsingModel:function(a){this.model();if(!this.cleared)return this.render(),void this.postShow(a);if(Trillo.router.showingView(this),!this.viewSpec.isAppView&&this.$c&&this.$c.removeClass("trillo-cleared"),this.setContainerVisibility(),this.viewSpec.container&&this.$c){var b=$('[data-container-target="'+this.viewSpec.container+'"]');b.length&&(this.showHideContainerMethod=this.showHideContainer.bind(this),b.removeClass("hide"),b.on("click",this.showHideContainerMethod))}this.$c&&(0===this.$e.parent().length&&this.$c.empty(),(this.$e.parent()[0]!==this.$c[0]||0===this.$e.parent().length)&&this.$c.append(this.$e)),this.viewSpec.dialog&&(this.$c.removeClass("hide"),this.isModal&&(this.$backdropE=$("<div></div>").addClass("trillo-dialog-backdrop"),$("body").append(this.$backdropE))),this.$e.show(),this.render(),this.toolsMgr.activate(),this.setPopoverTriggerState(this.getToolBar$Elem(),!1),this.cleared=!1,this.postShow(a)},repeatShowUsingModel:function(){var a=$.Deferred();return this._showUsingModel(a),a.promise()},render:function(){var a;this.renderTemplateNode(this._textNodes,this._attrNodes);var b=this.$e.find("select");for(a=0;a<b.length;a++)Trillo.setSelectOptionsFromEnum($(b[a]));this.renderExterns()},renderTemplateNode:function(a,b){var c,d;if(a.length||b.length){var e;for(c=0;c<a.length;c++)e=a[c],d=Mustache.render(e.text,this.modelData()),d||(d=Mustache.render(e.text,Trillo.appContext)),e.textNode.nodeValue=d;for(c=0;c<b.length;c++)e=b[c],d=Mustache.render(e.text,this.modelData()),d||(d=Mustache.render(e.text,Trillo.appContext)),e.attrNode.nodeValue=d}},renderData:function(a){},postShow:function(a){if(this._controller.postViewShown(this),a.resolve(this),this.viewSpec.dialog&&!this.viewSpec.draggable&&"absolute"===this.$c.css("position")&&(this.updateDialogSize(),this.centerIt()),this.viewSpec.draggable){var b=this.$c.find(".js-drag-handle");b.length>0&&(b.off("mousedown",this.dragHandleMouseDownM),b.on("mousedown",this.dragHandleMouseDownM))}if(this.$c&&Trillo.popoverManager.contentShown(this.$c),this.layoutContainers(),Trillo.page.layoutContainers2(),this.$c&&this.$c.hasClass("js-non-native-scrollbar")){var c=this;setTimeout(function(){var a={minScrollbarLength:100};a.suppressScrollX=c.$c.width()>c.$e.width(),c.setNonNativeScrollBar(c.$c,a)},0)}},postSetup:function(a){this._nextView&&this._nextView.postSetup(a);for(var b=0;b<this._embeddedViews.length;b++)this._embeddedViews[b].postSetup(a);this._controller.postSetup(a)},markForClearing:function(){this.viewSpec.isAppView||(this.viewSpec.embedded||Trillo.router.markForClearing(this),this.model()&&this.model().clearObserver()),this._nextView&&this._nextView.markForClearing();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].markForClearing()},clear:function(){if(!this.cleared){if(this.toolsMgr.clear(),this.destroyScrollBar(),this.model()&&this.model().clear(),this.viewSpec.draggable&&this.dragHandleMouseDownM){var a=this.$c.find(".js-drag-handle");a.off("mousedown",this.dragHandleMouseDownM),a.off("mouseup mouseleave",this.dragHandleMouseUpLeaveM),a.off("mousemove",this.dragHandleMouseMoveM)}if(this.$c&&(this.$c.addClass("trillo-cleared"),Trillo.popoverManager.contentCleared(this.$c)),this.$backdropE&&(this.$backdropE.remove(),this.$backdropE=null),this.viewSpec.container&&($("body").removeClass(this.viewSpec.container+"-shown"),this.$c)){var b=$('[data-container-target="'+this.viewSpec.container+'"]');b.length&&(b.addClass("hide"),b.off("click",this.showHideContainerMethod))}this.$e.hasClass("js-on-clean-no-remove")||this.$e.remove(),this.viewSpec.dialog&&this.$c.addClass("hide"),this._prevView?this._prevView._nextView===this&&(this._prevView._nextView=null):this._parentView&&(this._parentView.embeddedViews().splice(this._parentView.embeddedViews().indexOf(this),1),this._parentView._controller.removeEmbeddedController(this._controller));for(var c=0;c<this._embeddedViews.length;c++)this._embeddedViews[c].clear();this.cleared=!0}},canSelectionChange:function(a){var b=this._controller.canSelectionChange();b&&this._nextView&&(b=this._nextView.canSelectionChange(a));for(var c=0;c<this._embeddedViews.length&&b;c++)b=this._embeddedViews[c].canSelectionChange(a);return b},selectionChanging:function(a){this._controller.selectionChanging(),this._nextView&&this._nextView.selectionChanging(a);for(var b=0;b<this._embeddedViews.length;b++)this._embeddedViews[b].selectionChanging(a)},getSelectedObj:function(){return this.selectedObj},setSelectedObj:function(a){this.selectedObj=a,this._controller.selectedObjChanged(a),this._controller.updateTitle(),this.setTbState()},selectAndRoute:function(a){},getToolBar$Elem:function(){if(this.viewSpec.toolBar)return this.$c.find(this.viewSpec.toolBar);var a=this.parentView();return a?a.getToolBar$Elem():$(".js-toolbar")},setTbState:function(){this.toolsMgr.setTbState(this.selectedObj),this.setPopoverTriggerState(this.getToolBar$Elem(),!1)},setPopoverTriggerState:function(a,b){var c=this.toolsMgr.setPopoverTriggerState(a,b);b=c||b;var d=this.parentView();d&&d.setPopoverTriggerState(a,b)},showContextMenu:function(a,b){return this.toolsMgr.showContextMenu(a,b)},getNextViewName:function(a){return null},doInternalRouting:function(a,b){return 0},routingToNextView:function(a,b){},objChanged:function(a){},objAdded:function(a,b){},objDeleted:function(a){},modelDataChanged:function(a){a===this.model()&&this.repeatShowUsingModel()},validate:function(){for(var a=!0,b=0;b<this._embeddedViews.length;b++)a=this._embeddedViews[b].validate()&&a;return a},refresh:function(){if(this._nextView)return this._nextView.refresh();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].refresh()},windowResized:function(){if(!this.cleared){this.viewSpec.dialog&&!this.viewSpec.draggable&&"fixed"!==this.$c.css("position")&&this.centerIt(),-1!==this.mediaMinWidth&&this.setContainerVisibility(),this._nextView&&this._nextView.windowResized();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].windowResized();this.viewSpec.layoutSpecs&&Trillo.positionContainers(this.viewSpec.layoutSpecs),this.updateScrollBar()}},updateDialogSize:function(){var a=this.$e,b=this.$c;if(b){var c=a.dataOrAttr("width");c||(c="auto");var d=a.dataOrAttr("height");d||(d="auto");var e=a.dataOrAttr("max-width");e||(e=Trillo.Options.DIALOG_MAX_WIDTH),b.css({width:c,height:d,maxWidth:e})}},centerIt:function(){var a=$(window),b=this.$c;if(b){var c=a.width(),d=a.height(),e=a.scrollTop(),f=b.outerWidth(),g=b.outerHeight(),h=parseInt(d/2-g/2,10);h>100?h=100:10>h&&(h=10),b.css("top",e+h+"px"),b.css("left",parseInt(c/2-f/2,10)+"px")}},mouseDownOnDragHandle:function(a){var b=$(a.target);if(!b.hasClass("js-drag-handle"))return!1;var c=$(document.body);c.off("mouseup",this.dragHandleMouseUpLeaveM),c.on("mouseup",this.dragHandleMouseUpLeaveM),c.off("mousemove",this.dragHandleMouseMoveM),c.on("mousemove",this.dragHandleMouseMoveM);var d=this.$c.offset();this.dragData={top:a.clientY-d.top,left:a.clientX-d.left}},mouseUpLeaveDragHandle:function(a){var b=$(document.body);b.off("mouseup",this.dragHandleMouseUpLeaveM),b.off("mousemove",this.dragHandleMouseMoveM)},mouseMoveOnDragHandle:function(a){a.preventDefault(),this.$c.offset({top:a.clientY-this.dragData.top,left:a.clientX-this.dragData.left})},hide:function(){this.viewSpec.dialog?this.$c.addClass("hide"):this.$e.addClass("hide")},unhide:function(){this.viewSpec.dialog?this.$c.removeClass("hide"):this.$e.removeClass("hide")},isHidden:function(){return this.viewSpec.dialog?this.$c.hasClass("hide"):this.$e.hasClass("hide")},showPageLoadIndicator:function(){$(".js-page-load-indicator").removeClass("hide")},hidePageLoadIndicator:function(){$(".js-page-load-indicator").addClass("hide")},setContainerVisibility:function(){if(-1!==this.mediaMinWidth&&(this.$c&&this.canContainerBeShown()?(this.$c.removeClass("js-overlaid"),this.$c.removeClass("trillo-container-overlaid"),this.$c.removeClass("hide")):(this.$c.addClass("js-overlaid"),this.$c.addClass("trillo-container-overlaid"),this.$c.addClass("hide"))),this.viewSpec.container&&!this.viewSpec.isAppView){var a=this.viewSpec.container+"-shown";this.canContainerBeShown()?$("body").addClass(a):$("body").removeClass(a)}},canContainerBeShown:function(){return-1===this.mediaMinWidth||this.getViewportWidth()>this.mediaMinWidth},getViewportWidth:function(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)},getViewportHeight:function(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)},hideOverlaidContainer:function(){this.$c&&(this.canContainerBeShown()||this.$c.addClass("hide"),Trillo.popoverManager.hideCurrentPopupIfContains(this.$c))},showHideContainer:function(a){a&&(a.stopPropagation(),a.preventDefault()),this.$c.toggleClass("hide"),this.$c.is(":visible")&&this.repeatShowUsingModel()},layoutContainers:function(){if(this.viewSpec.layoutSpecs)Trillo.positionContainers(this.viewSpec.layoutSpecs);else{var a=this.parentView();a&&a.layoutContainers()}},layoutContainers2:function(){this._nextView&&this._nextView.layoutContainers2();for(var a=0;a<this._embeddedViews.length;a++)this._embeddedViews[a].layoutContainers2()},setNonNativeScrollBar:function(a,b){this.destroyScrollBar(),b=b||{suppressScrollX:!0,minScrollbarLength:100},this.$_sb=a,a.perfectScrollbar(b)},updateScrollBar:function(){this.$_sb&&this.$_sb.perfectScrollbar("update")},destroyScrollBar:function(){this.$_sb&&this.$_sb.perfectScrollbar("destroy")},setScrollBarPos:function(a,b){this.$_sb&&("left"==b?this.$_sb.scrollLeft(a):this.$_sb.scrollTop(a),this.updateScrollBar())},getScrollBarPos:function(a){return this.$_sb?"left"==a?this.$_sb.scrollLeft():this.$_sb.scrollTop():-1},applyExternalElements:function(a){var b;if(this._externs=a,a){for(var c=0;c<a.length;c++)b=a[c],b._textNodes=[],b._attrNodes=[],this.processNode(b.e,b._textNodes,b._attrNodes);this.cleared||this.renderExterns()}},renderExterns:function(){var a,b=this._externs;if(b)for(var c=0;c<b.length;c++)a=b[c],this.renderTemplateNode(a._textNodes,a._attrNodes)},getExternBySelector:function(a){var b,c,d=this._externs;if(!d)return null;for(var e=0;e<d.length;e++)if(c=d[e],b=Trillo.findAndSelf($(c.e),a),b.length)return b;return null}}),Trillo.View=Trillo.BaseView.extend({initialize:function(a,b,c){this._super(a,b,c)},markForClearing:function(){this._super(),this.viewSpec.isAppView||this.ownsGlobalProgress&&this.hideGlobalProgress()},clear:function(){this.cleared||(this._super(),Trillo.searchHandler&&Trillo.searchHandler.context===this&&Trillo.searchHandler.setContext(null),this.clearTitle(),Trillo.titleBarManager.viewCleared(this),this._super())},showGlobalProgress:function(a,b){console.debug("showing .... "+this.viewSpec.name),this.ownsGlobalProgress=!0;var c=$(".js-global-progress-bar");c.show();var d=c.find(".js-title");d.html(a),d=c.find(".js-message"),d.html(b),c.find(".js-progress-bar").css("width",(b||4)+"%")},hideGlobalProgress:function(){this.ownsGlobalProgress=!1,console.debug("hiding .... "+this.viewSpec.name);var a=$(".js-global-progress-bar");a.hide()},updateProgress:function(a){this._updateProgress(a)},_updateProgress:function(a){var b=this.parentView();if(b&&b._updateProgress&&b._updateProgress(a))return!0;var c=this._controller.getSelectionUidOrContextUid();return a&&(this.selectedObj&&this.selectedObj.uid===a.uid||c===a.uid)?(a.availabilityState===Trillo.OBJ_LOCKED&&"undefined"!=typeof a.percentComplete?this.showGlobalProgress(a.actionName,a.percentComplete):this.hideGlobalProgress(),!0):!1},getTitleBar:function(){if(this.viewSpec.titleBar)return Trillo.titleBarManager.getTitleBar(this.viewSpec.titleBar,this);var a=this.parentView();return a&&a.getTitleBar?a.getTitleBar():Trillo.titleBarManager.getTitleBar(".js-heading",this)},updateTitle:function(){var a,b="";if(this.viewSpec.type===Trillo.ViewType.Selector||this.viewSpec.type===Trillo.ViewType.List||this.viewSpec.type===Trillo.ViewType.Nav||this.viewSpec.embedded);else if(Trillo.isCollectionView(this.viewSpec.type)||this.viewSpec.type===Trillo.ViewType.Chart)a=this.viewSpec.displayName||"";else{this.viewSpec.type===Trillo.ViewType.Tree&&(b=this.viewSpec.displayName||"");var c=this.selectedObj;a=c?c.displayName||c.name||"":""}this.setTitle(a,b)},setTitle:function(a,b){if(this.title=a,this.titlePrefix=b,""!==b&&b||this.getPrevViewTitle()!==a){var c=this.getTitleBar();c&&c.setTitle(this.name,a,b)}},clearTitle:function(){this.title=null,this.titlePrefix=null;var a=this.getTitleBar();a&&a.clearTitle(this.name)},getPrevViewTitle:function(){return this._prevView?this._prevView.title:null},searchPhraseAvailable:function(a,b,c,d){},getNextViewName:function(a){if(this._nextView&&(!a||a===this._nextView.viewSpec.parentPath))return this._nextView.viewSpec.getMyPath();if(a){var b=Trillo.navHistory.get(a);if(b)return b;var c=this.viewSpec.getViewSpecByParentPath(a);if(c)return c.getMyPath()}return this.viewSpec.nextView?this.viewSpec.getDefaultNextPath():this._getNextViewName()},_getNextViewName:function(){var a=this.getNextViewSpecByContextUidClass();return a?a.name:null},getNextViewSpecByContextUidClass:function(){var a=this._controller.getContextUid();return this.getNextViewSpecByUidClass(a)},getNextViewSpecByUidClass:function(a){var b=this.viewSpec.nextViewSpecs,c=null;if(b&&a){var d=Trillo.uidToClass(a);d&&$.each(b,function(a,b){return b.trigger===d?(c=b,!1):void 0})}return c},getNextViewSpecNameByUidClass:function(a){var b=this.getNextViewSpecByUidClass(a);return b?b.getMyPath():null},routingToNextView:function(a,b){for(var c=a.length,d="",e=b;c>e&&(d=d+(d.length>0?"/":"")+Trillo.getTriggerFromPath(a[e].name),!this.synchWithRouteState(d));e++);},synchWithRouteState:function(a){for(var b=0;b<this._embeddedViews.length;b++)this._embeddedViews[b].synchWithRouteState(a);return!0},viewSelected:function(a){Trillo.hideCurrentOverlays(!0,!1);var b=Trillo.getActualTarget(a);if(b){Trillo.popoverManager.hideCurrentPopupIfContains(b);var c=b.prop("tagName").toLowerCase();if("a"===c){var d=b.attr("href");if(d&&"#"!==d)return}}a&&a.preventDefault();var e=$(a.target).closest(this.itemCss),f=e.dataOrAttr("nm");this.canSelectionChange(f)&&(this.selectionChanging(f),this.updateItemSelection(f)&&this.postViewSelected(f),$(".js-navbar-toggle").each(function(){$($(this).data("target")).removeClass("in").addClass("collapse")}))},updateItemSelection:function(a){$(":focus").blur();var b=this.$e,c=b.find(this.itemCss+"[selected]"),d=!1;return c.dataOrAttr("nm")!==a&&(c.removeClass(Trillo.CSS.selected),c.removeAttr("selected"),c=b.find("[nm='"+a+"']"),c.addClass(Trillo.CSS.selected),c.attr("selected","selected"),d=!0),c=this.getExternBySelector("[selected]"),(null===c||c.dataOrAttr("nm")!==a)&&(c&&(c.removeClass(Trillo.CSS.selected),c.removeAttr("selected")),c=this.getExternBySelector("[nm='"+a+"']"),c&&(c.addClass(Trillo.CSS.selected),c.attr("selected","selected")),d=!0),d},getSelected$Elem:function(){return this.$e.find(this.itemCss+"[selected]")},getSelectedItem:function(){var a=this.$e.find(this.itemCss+"[selected]");return a.length?a.dataOrAttr("nm"):null},selectedItemChanged:function(a){this._controller.selectedItemChanged(a)},postViewSelected:function(a){this._controller.routeToSelectedView(this.viewSpec.getNextPath(a))},updateLabel:function(){},addContainerMarks:function(){var a,b,c=this.$e.find(".js-container");$.each(c,function(){b=$(this),b.empty(),b.addClass(Trillo.CSS.containerPreviewMode),a=$("<span></span>"),b.append(a),a.addClass(Trillo.CSS.containerMark),a.html(b.dataOrAttr("nm")),$("body").addClass(b.attr("nm")+"-shown")})}}),Trillo.EditableView=Trillo.View.extend({messageHtml:'<span class="js-field-message '+Trillo.CSS.fieldMsg+' text-info"></span>',errorHtml:'<span class="js-field-error '+Trillo.CSS.fieldMsg+' text-danger"></span>',initialize:function(a,b,c){this._super(a,b,c),this.editable=c.editable!==!1},updateElements:function(a,b){$.each(a,function(){var a=$(this),c=a.dataOrAttr("nm"),d=Trillo.getObjectValue(b,c);null===d&&(d=""),Trillo.setFieldValue(a,d)})},updateReadonlyElements:function(a,b){$.each(a,function(){var a=$(this),c=a.dataOrAttr("nm"),d=Trillo.getObjectValue(b,c);null===d&&(d=""),Trillo.setReadonlyFieldValue(a,d)})},retrieveData:function(a){var b={};return $.each(a,function(){var a=$(this),c=a.dataOrAttr("nm"),d=Trillo.getFieldValue(a);null!==d&&void 0!==d&&Trillo.setObjectValue(b,c,d)}),b},_validateOne:function(a){if(!a.is(":visible"))return!0;this.clearInlineError(a);var b=!0,c=Trillo.getFieldValue(a),d=""===c||void 0===c;return a.hasClass("js-required")&&d&&(this.inlineError(a,"Required"),b=!1),!a.hasClass("number")||d||Trillo.isNumeric(c)||(this.inlineError(a,"Numeric value required"),b=!1),b||a.parent().addClass(Trillo.CSS.hasErrorCss),b},validateOne:function(a){var b=$(a.target);if(!b.is(":visible"))return!0;var c=this._validateOne(b);if(c&&this.controller().validateOne&&(c=this.controller().validateOne(b)),c&&this.controller().validateAndGetMsg){var d=this.controller().validateAndGetMsg(b);d&&(this.inlineError(b,d),b.parent().addClass(Trillo.CSS.hasErrorCss),c=!1)}return c},_validate:function(a){for(var b=!0,c=0;c<a.length;c++){var d=$(a[c]);b=this._validateOne(d)&&b}return b},showNamedMessages:function(a){var b;if(a)for(var c=0;c<a.length;c++)b=a[c],this.inlineMessage(this.$e.find('[nm="'+b.name+'"]'),b.message)},showNamedMessagesAsError:function(a){var b;if(a)for(var c=0;c<a.length;c++)b=a[c],this.inlineError(this.$e.find('[nm="'+b.name+'"]'),b.message)},inlineMsg:function(a,b){var c=a.siblings(".js-field-message");return 0===c.length&&(a.after(this.messageHtml),c=a.siblings(".js-field-message")),c.html(b),c.parent().addClass(Trillo.CSS.hasMessageCss),c},inlineError:function(a,b){var c=a.siblings(".js-field-error");return 0===c.length&&(a.after(this.errorHtml),c=a.siblings(".js-field-error")),c.html(b),c.parent().addClass(Trillo.CSS.hasErrorCss),c},clearInlineMessage:function(a){var b=a.siblings(".js-field-message");b.length&&(b.html(""),b.parent().removeClass(Trillo.CSS.hasMessageCss))},clearInlineError:function(a){var b=a.siblings(".js-field-error");b.length&&(b.html(""),b.parent().removeClass(Trillo.CSS.hasErrorCss))},fieldChanged:function(a){var b=this.validateOne(a);if(b){var c=$(a.target),d=c.dataOrAttr("nm"),e=Trillo.getFieldValue(c);this.getObjForField(c);return this.updateModelData(d,e,c),b}},getFieldValue:function(a){var b=this.$e.find('[nm="'+a+'"]');return b.length?Trillo.getFieldValue(b):void 0},setFieldValue:function(a,b){var c=this.$e.find('[nm="'+a+'"]');c.length&&(Trillo.setFieldValue(c,b),this._validateOne(c)&&this.updateModelData(a,b,c))},getInputs:function(){return Trillo.getInputs(this.$e)},getReadonlyFields:function(){return Trillo.getReadonlyFields(this.$e)},postShow:function(a){var b=this.$e.find("textarea");b.length&&(autosize(b),autosize.update(b)),$(".js-default-focus",this.$e).focus(),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find("textarea");a.length&&autosize.destroy(a)}this._super()},setAllInputsDisabled:function(a){Trillo.setDisabled(this.getInputs(),a)},setInputDisabled:function(a,b){Trillo.setDisabled(this.$e.find('[nm="'+a+'"]'),b)}}),Trillo.EditableObjView=Trillo.EditableView.extend({initialize:function(a,b,c){this._super(a,b,c),this.changeHandler=$.proxy(this.fieldChanged,this)},mapModelData:function(a){a.data=a.data||{}},render:function(){this._super(),this.setSelectedObj(this.modelData()),this.updateProgress(this.modelData()),this.setChangeHandler(!0),this.renderData(this.modelData())},renderData:function(a){this.updateElements(this.getInputs(),a),this.updateReadonlyElements(this.getReadonlyFields(),a)},setChangeHandler:function(a){var b=this.getInputs();b.off("change",this.changeHandler),a&&b.on("change",this.changeHandler)},validate:function(){var a=this.getInputs(),b=this._validate(a);return b&=this._super()},clear:function(){this.cleared||this.setChangeHandler(!1),this._super()},canSubmit:function(){return this.validate()},updateModelData:function(a,b,c){this.model().setValue(a,b)},getObjForField:function(a){return this.modelData()},objChanged:function(a){a===this.modelData()&&(this.renderData(a),this.updateProgress(a))}}),Trillo.ViewSelectionView=Trillo.View.extend({containerCss:null,itemCss:null,initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this)},postShow:function(a){var b=this.$e.find(this.itemCss);b.off("click",this.viewSelectedMethod),b.on("click",this.viewSelectedMethod),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find(this.itemCss);a.off("click",this.viewSelectedMethod)}this._super()},synchWithRouteState:function(a){var b=this.$e,c=b.find("[nm='"+a+"']");return c.length>0?(this.updateItemSelection(a),this.updateLabel(),this.controller().updateTitle(),!0):!1},_getNextViewName:function(){var a=this.$e.find(this.itemCss+"[selected]");return a.length>0?a.dataOrAttr("nm"):null},applyExternalElements:function(a){if(this._super(a),a)for(var b,c,d=0;d<a.length;d++)c=a[d],b=Trillo.findAndSelf($(c.e),this.itemCss),b.off("click",this.viewSelectedMethod),b.on("click",this.viewSelectedMethod)}}),Trillo.TreeView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c);var d=this.$e.find(".js-tree-container"),e=Trillo.findAndSelf(this.$e,".js-non-native-scrollbar");e.length&&this.setNonNativeScrollBar(e),this.tree=new Trillo.Tree({$e:d,parent:this,scrollPolicy:e.length?Trillo.Options.NON_NATIVE_SCROLLBAR:Trillo.isTouchSurface?Trillo.Options.AUTO_SCROLL:Trillo.Options.SCROLL_ON_HOVER,openOnFirstClick:!0,closeOthers:!0}),this.toggleDisplayHandler=$.proxy(this.toggleDisplay,this)},clear:function(){this.cleared||(this.removeEventHandlers(),this.renderData([]),this.tree.clear()),this._super()},mapModelData:function(a){a.data=a.data||{},a.data.children=a.data.children||[]},render:function(){this._super(),this.renderData(this.modelData().children)},renderData:function(a){this.addHandlers(),this.tree.setTreeData(a)},postShow:function(a){this.selectTreeItem(this.controller().getParam("sel")),this._super(a)},selectTreeItem:function(a){var b=this.tree.selectItemByUid(a),c=this.modelData().children;!b&&c&&c.length>0&&(a=c[0].uid,this.controller().setParam("sel",a),this.tree.selectItemByUid(a)),this.setSelectedObj(this.tree.selectedItem)},selectAndRoute:function(a){var b=this.tree.selectItemByUid(a);return b?(this.treeItemSelected(this.tree.selectedItem),!0):!1},synchWithRouteState:function(a){var b=this.tree.getItemByUid(a);return b&&b!==this.selectedObj?(this.tree.selectItemByUid(a),this.setSelectedObj(this.tree.selectedItem),!0):!1},treeItemSelected:function(a){this.setSelectedObj(a),this.controller().setParam("sel",a.uid)},addHandlers:function(){this.viewSpec.viewToggle&&(this.removeEventHandlers(),$(this.viewSpec.viewToggle).on("click",this.toggleDisplayHandler))},removeEventHandlers:function(){this.viewSpec.viewToggle&&$(this.viewSpec.viewToggle).off("click",this.toggleDisplayHandler)},toggleDisplay:function(){var a=this.$container().offset().left<0;this.$container().css("left",a?"0px":"-1000px")},outOfView:function(){this.$container().css("left","-1000px")},withInView:function(){this.$container().css("left","0px")},getNextViewName:function(a){var b=this.selectedObj;return b?Trillo.isUid(b.uid)?this.getNextViewSpecNameByUidClass(b.uid):this.viewSpec.getNextPath(b.uid):this._super(a)},refresh:function(){this.tree.refresh(),this._super()}}),Trillo.NavTreeView=Trillo.TreeView.extend({initialize:function(a,b,c){this._super(a,b,c)},updateModelSpec:function(a){a.data={children:this.viewSpec.nextViewSpecs||[]}}}),Trillo.SelectorView=Trillo.ViewSelectionView.extend({labelSelector:".js-label",containerCss:".js-menu",itemCss:".js-menu-item",initialize:function(a,b,c){this._super(a,b,c)},updateLabel:function(){var a=this.$e,b=a.find(this.itemCss+"[selected]");a.find(this.labelSelector).html(b.html())}}),Trillo.TabView=Trillo.EditableObjView.extend({containerCss:".js-tab-list",itemCss:".js-tab",tabPanelCSS:".js-tab-panel",initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this),this.$inputs=Trillo.getInputs(a),this.changeHandler=$.proxy(this.fieldChanged,this)},getInputs:function(){return this.$inputs},postShow:function(a){var b,c,d=null,e=Trillo.navHistory.get("tab://"+this.controller().getRouteUpTo(!1));b=this.$e.find(this.itemCss+"[selected]"),b.length>0&&(d=b.dataOrAttr("nm")),e&&e!==d&&(d=e,this.synchWithRouteState(d)),d&&(c=this.$e.find(this.tabPanelCSS+"[for='"+d+"']"),c.length>0&&this.updateTabPanelVisibility(d));var f=this.$e.find(this.itemCss);
f.off("click",this.viewSelectedMethod),f.on("click",this.viewSelectedMethod),this.makeResponsive(),this._super(a)},clear:function(){if(!this.cleared){var a=this.$e.find(this.itemCss);a.off("click",this.viewSelectedMethod)}this._super()},updateLabel:function(){var a=this.$e,b=a.find(this.itemCss+"[selected]");a.find("."+Trillo.CSS.tabActive).removeClass(Trillo.CSS.tabActive),b.parent().addClass(Trillo.CSS.tabActive)},updateTabPanelVisibility:function(a){var b=this.$e;b.find(this.tabPanelCSS+"[for]").hide();var c=b.find(this.tabPanelCSS+"[for='"+a+"']");c.show(),Trillo.resizeAllTextArea(b),this.refresh()},postViewSelected:function(a){var b=this.$e.find(this.tabPanelCSS+"[for='"+a+"']");b.length>0?(this.updateTabPanelVisibility(a),this.updateLabel(),this.selectedItemChanged(a),Trillo.navHistory.add("tab://"+this.controller().getRouteUpTo(!1),a)):this._super(a)},_getNextViewName:function(){var a,b,c=Trillo.navHistory.get("tab://"+this.controller().getRouteUpTo(!1));return c&&(b=this.$e.find(this.tabPanelCSS+"[for='"+c+"']"),b.length>0),a=this.$e.find(this.itemCss+"[selected]"),a.length>0?(c=a.dataOrAttr("nm"),b=this.$e.find(this.tabPanelCSS+"[for='"+c+"']"),b.length>0?null:c):null},synchWithRouteState:function(a){var b=this.$e,c=b.find("[nm='"+a+"']");return c.length>0?(this.updateItemSelection(a),this.updateLabel(),this.controller().updateTitle(),!0):!1},objChanged:function(a){this._super(a),a===this.modelData()&&this.setTbState()},makeResponsive:function(){var a,b=this.$e,c=b.find("li"),d=0;$.each(c,function(){$(this).is(":visible")&&d++}),d>0&&c.css("width",100/d+"%"),$.each(c,function(){a=$(this),a.attr("title")||a.attr("title",$.trim(a.text()))})},showHideTab:function(a,b){var c=this.$e.find("[nm='"+a+"']");c.length>0&&(b?c.parent().removeClass("hide"):c.parent().addClass("hide"),this.makeResponsive())},showTab:function(a){this.showHideTab(a,!0)},hideTab:function(a){this.showHideTab(a,!1)}}),Trillo.NavView=Trillo.ViewSelectionView.extend({containerCss:".js-navigation",itemCss:".js-nav-item",initialize:function(a,b,c){this._super(a,b,c)},init2:function(){this._super()}}),Trillo.sortDescTemplate='<span class="order"><span class="caret"></span></span>',Trillo.sortAscTemplate='<span class="order dropup"><span class="caret"></span></span>',Trillo.CollectionView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c),this.setupView(),this.sortSpec={}},setupView:function(){var a={},b=this.viewSpec,c=this.$e,d=c.find(".js-grid-cell");d.length>0?(a.elemKey=b.name+"-info-block",Trillo.infoElementRepo.addTemplate(d,a.elemKey)):(d=c.find(".js-content-row"),d.length>0&&(a.elemKey=b.name+"-row",Trillo.infoElementRepo.addTemplate(d,a.elemKey),a.isListViewMode=!0)),d=c.find(".js-heading-row"),d.length>0&&(d.show(),a.$headerRow=d),a.postRenderer=b.postRenderer,a.dialog=b.dialog,a.virtual=b.virtual||"undefined"==typeof b.virtual?!0:!1,this.$asc=$(Trillo.sortAscTemplate),this.$desc=$(Trillo.sortDescTemplate),this.$e.hasClass("js-non-native-scrollbar")&&this.setNonNativeScrollBar(this.$e),this.canvas=new Trillo.Canvas(this,a)},mapModelData:function(a){a.data=a.data||[]},render:function(){var a=this.model().getPaginationInfo();a&&1!==a.numberOfPages||(this.viewSpec.virtual=!1,this.canvas.virtual=!1),this.controller().updateTitle(),this._super(),this.renderData(this._modelDataWithPagination())},renderData:function(a){this.canvas.clear(),this.canvas.setContent(a)},clear:function(){this.cleared||(this.unselectInfoItem(),this.canvas.clear()),this._super()},windowResized:function(){this.cleared||(this.canvas.windowResized(),this._super())},layoutContainers2:function(){this.cleared||(this.canvas.windowResized(),this._super())},loadPage:function(a,b){$.when(this.apiAdapter().loadData(a,b)).done($.proxy(this.pageLoaded,this,b))},pageLoaded:function(a,b){a&&this.canvas.clear(),this.canvas.setContent(this._modelDataWithPagination())},postShow:function(a){this.selectCollectionItem(this.controller().getParam("sel")),this._super(a)},selectCollectionItem:function(a){var b=this.canvas.selectItemByUid(a);if(!b&&this.hasSelectionTrigger()){var c=this.modelData();c&&c.length>0&&(a=c[0].uid,this.controller().setParam("sel",a),b=this.canvas.selectItemByUid(a))}},selectInfoItem:function(a){this.selectedInfoItem=a,a&&(this.setSelectedObj(a.obj),this.hasSelectionTrigger()&&a.obj&&this.controller().setParam("sel",a.obj.uid))},unselectInfoItem:function(a){this.selectedInfoItem=null,this.setSelectedObj(null)},clicked:function(a,b){return a&&a.obj&&a.obj.name?this.controller()._handleClickGeneric(a.obj.name,a.$rootE,a.obj,b):void 0},infoItemDblClicked:function(a,b){return a&&a.obj&&!this.hasSelectionTrigger()?this.controller().doTriggerNextView("detail",a.obj):!1},hasSelectionTrigger:function(){return this.viewSpec.getNextViewSpecByTrigger("selection")},objChanged:function(a){this.canvas.objChanged(a),this.selectedObj===a&&this.setTbState(),this._super(a)},objAdded:function(a,b){this.canvas.objAdded(a,b),this._super(a,b)},doSort:function(a){var b=$(a.target);if(b=Trillo.getClosestLabelElem(b),!b)return void Trillo.alert.showError("Error","Missing 'for' attribute in the header, pl. specify in the HTML temlpate");var c=b.dataOrAttr("for"),d=this.sortSpec[c];if(d="asc"===d?"desc":"asc",this.$asc.remove(),this.$desc.remove(),"asc"===d?b.append(this.$asc):b.append(this.$desc),this.sortSpec={},this.sortSpec[c]=d,this.model().setOrderBy){var e=c+" "+d;this.model().setOrderBy(e),this.canvas.loadingData=!0,this.loadPage(1,!0)}else this.model().doSort(c,d),this.canvas.clear(),this.canvas.setContent(this._modelDataWithPagination())},refresh:function(){this.canvas.refresh(),this._super()},changeAttr:function(a,b,c){this.model().setObjAttr(a,b,c)},_modelDataWithPagination:function(){var a=this.modelData(),b=this.model().getPaginationInfo();return b||(b=Trillo.makePaginationInfo(a)),b.items=a,b}}),Trillo.DropdownView=Trillo.ViewSelectionView.extend({labelSelector:".js-label",containerCss:".js-navigation",listCss:".js-list",itemCss:".js-list-item",initialize:function(a,b,c){this._super(a,b,c),this.itemSelectedMethod=$.proxy(this.itemSelected,this)},mapModelData:function(a){a.data=a.data||[]},render:function(){this.controller().updateTitle(),this._super(),this.renderList()},renderList:function(){var a=this.$e.find(this.listCss),b=this.modelData();Trillo.HtmlTemplates.dropdownListItem&&!Trillo.HtmlTemplates.dropdownListItem__parsed__&&(Mustache.parse(Trillo.HtmlTemplates.dropdownListItem),Trillo.HtmlTemplates.dropdownListItem__parsed__=!0);for(var c="",d=0;d<b.length;d++){var e=b[d];c+=Mustache.render(Trillo.HtmlTemplates.dropdownListItem,e)}a.html(c)},postShow:function(a){this.selectItem(),this._super(a)},selectItem:function(){var a=this.controller().getParam("sel"),b=null;a&&(b=this.model().getObj(a));var c=this.modelData();!b&&c.length>0&&(b=c[0],a=b.uid,this.controller().setParam("sel",a)),this.setSelectedObj(b)},synchWithRouteState:function(a){this._super(a);var b=this.model().getObj(a);b&&b!==this.selectedObj&&this.setSelectedObj(b)},setSelectedObj:function(a){this._super(a),this.updateLabel()},postViewSelected:function(a){var b=this.model().getObj(a);this.setSelectedObj(b);var c=b?b.uid:null;this.controller().setParam("sel",c)},updateLabel:function(){var a=this.selectedObj,b=a?a.name:"";this.$e.find(this.labelSelector).html(b)},_getNextViewName:function(){var a=this.selectedObj;return a?Trillo.isUid(a.uid)?null:a.uid:void 0},objChanged:function(a){this.renderList(),this.selectedObj===a&&this.setTbState(),this._super(a)},objAdded:function(a,b){this.renderList(),this.selectedObj||this.selectItem(),this._super(a,b)}}),Trillo.DetailView=Trillo.EditableObjView.extend({initialize:function(a,b,c){this._super(a,b,c)}}),Trillo.FormView=Trillo.EditableObjView.extend({initialize:function(a,b,c){this._super(a,b,c)}}),Trillo.EditableTableView=Trillo.EditableView.extend({initialize:function(a,b,c){this._super(a,b,c),this.allowsNewRow="undefined"==typeof c.allowsNewRow||c.allowsNewRow,this.setupView()},setupView:function(){this.$templateE=this.$e.find(".js-content-row"),this.$templateE.remove(),this.changeHandler=$.proxy(this.rowFieldChanged,this),this.rowActionHandler=$.proxy(this.handleRowAction,this),this.keydownHandler=$.proxy(this.keydownAction,this),this.isStringArray=!1},mapModelData:function(a){a.data=a.data?Trillo.convertToArray(a.data):[]},render:function(){this._super(),this.$tableE=Trillo.findAndSelf(this.$e,"table");var a=this.modelData();if(a.length&&"string"==typeof a[0]){this.isStringArray=!0;var b=[];$.each(a,function(){b.push({name:this})}),a=b}this.renderData(a)},renderData:function(a){this.clearRows(),this.makeEmptyData(),this.clearRows(),this.setRowsData(a),this.addLastEmptyRow()},clearRows:function(){this.$e.find(".js-content-row").remove()},setRowsData:function(a){for(var b=0;b<a.length;b++){var c=this.appendNewRow(b);c.data("_row_data_",a[b]),this.updateElements(Trillo.getInputs(c),a[b]),this.updateReadonlyElements(Trillo.getReadonlyFields(c),a[b])}},refreshRowsView:function(){for(var a=this.$e.find(".js-content-row"),b=0;b<a.length;b++){var c=$(a[b]),d=c.data("_row_data_");d&&(this.updateElements(Trillo.getInputs(c),d),this.updateReadonlyElements(Trillo.getReadonlyFields(c),d))}},appendNewRow:function(a){var b=this.$templateE.clone(!0);return b.attr("row",""+a),this.$tableE.append(b),b.data("_row_data_",{}),this.addRowEventHandler(b),b},makeEmptyData:function(){this.appendNewRow();var a=[];this._viewToData(a,!0,!0),this.emptyData=a[0]},_viewToData:function(a,b,c){var d=null;c||(d=this.model().cloneData()),a.length=0;var e,f=this.$e.find(".js-content-row"),g=this;$.each(f,function(){e=$(this);var c=Trillo.getInputs(e);if(b||!g.isEmpty(c)){var d=g.retrieveData(c);if(g.isStringArray)a.push(d.name);else{var f=e.data("_row_data_");Trillo.clearObj(f),d=$.extend(f,d),a.push(d)}}}),c||this.model().saveModelData(d,{obj:this.parentModelData(),viewName:this.name})},addRowEventHandler:function(a){var b=Trillo.getInputs(a);b.on("change",this.changeHandler),b.on("keydown",this.keydownHandler),b=a.find(".js-row-tool"),b.on("click",this.rowActionHandler)},validate:function(){var a,b=this.$e.find(".js-content-row"),c=!0,d=this;return $.each(b,function(){a=$(this);var b=Trillo.getInputs(a);d.isEmpty(b)||(c=d._validate(b)&&c)}),c&=this._super()},isEmpty:function(a){var b=!0,c=this.emptyData||{};return $.each(a,function(){var a=$(this),d=Trillo.getFieldValue(a),e=c[a.attr("nm")];return d!==e?(b=!1,!1):void 0}),b},rowFieldChanged:function(a){if(this.fieldChanged(a)){var b=$(a.target);this.isLastRow(b)&&this.addLastEmptyRow()}},isLastRow:function(a){var b=this.getNumberOfRows(),c=this.getRowIndex(a);return c===b-1},getNumberOfRows:function(){return this.$e.find(".js-content-row").length},handleRowAction:function(a){var b=$(a.target);switch(b.attr("nm")){case"up":this.moveRow(b,-1);break;case"down":this.moveRow(b,1);break;case"add":this.addRowBefore(b);break;case"delete":this.deleteRow(b);break;default:this.controller().handleAction(b.attr("nm"),this.getObjForField(b),b)}},moveRow:function(a,b){var c=this.getRowIndex(a)+b;if(!(0>c)){var d=this.getNumberOfRows();c>=d||(0>b?this.$e.find('[row="'+c+'"]').before(a.closest("tr")):this.$e.find('[row="'+c+'"]').after(a.closest("tr")),this.reorder(),this._viewToData(this.modelData(),!0))}},addRowBefore:function(a){var b=this.$templateE.clone(!0);a.closest("tr").before(b),this.addRowEventHandler(b),this.reorder(),this._viewToData(this.modelData(),!0)},deleteRow:function(a){a.closest("tr").remove(),0===this.getNumberOfRows()?this.appendNewRow(0):this.reorder(),this._viewToData(this.modelData(),!0)},reorder:function(){var a=this.$e.find(".js-content-row"),b=0;$.each(a,function(){$(this).attr("row",b++)})},getRowIndex:function(a){return parseInt(a.closest("tr").attr("row"),10)},removeLastRowIfEmpty:function(){var a=this.$e.find(".js-content-row").last();this.isEmpty(a)&&a.remove()},addLastEmptyRow:function(){!this.editable||!this.allowsNewRow||0!==this.modelData().length&&this.isEmpty(Trillo.getInputs(this.$e.find(".js-content-row").last()))||(this.appendNewRow(this.getNumberOfRows()),this._viewToData(this.modelData(),!0,!0))},setAllowsNewRow:function(a){a!==this.allowsNewRow&&(this.allowsNewRow=a,a?this.addLastEmptyRow():this.removeLastRowIfEmpty())},updateModelData:function(a,b,c){var d=this.model().cloneData();this.model().setObjAttrNoRecording(this.getObjForField(c),a,b),this.refreshRowsView(),this.model().saveModelData(d,{obj:this.parentModelData(),viewName:this.name})},getObjForField:function(a){var b=this.getRowIndex(a);return this.modelData()[b]},keydownAction:function(a){var b=a.which;if(38===b||40===b||13===b){var c=$(a.target);if(c.is("select")&&13!=b)return;var d=this.getRowIndex(c);if(d+=38===b?-1:1,0>d||d>=this.getNumberOfRows())return;var e=c.closest(".js-content-row"),f=Trillo.getInputs(e),g=f.index(c);e=this.$e.find('[row="'+d+'"]'),f=Trillo.getInputs(e),c=$(f.get(g)),c.focus()}},getRowElemForObj:function(a){var b,c=this.$e.find(".js-content-row"),d=null;return $.each(c,function(){return b=$(this).data("_row_data_"),b===a?(d=$(this),!1):void 0}),d}}),Trillo.ChartView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c),this.charts=[]},mapModelData:function(a){a.data=a.data||[]},render:function(){this.controller().updateTitle(),this._super(),this.renderCharts()},clear:function(){this._super(),this.chart=null},windowResized:function(){if(!this.cleared){this._super();for(var a=0;a<this.charts.length;a++)this.charts[a].resize()}},loadPage:function(a){$.when(this.apiAdapter().loadData(a)).done($.proxy(this.pageLoaded,this))},pageLoaded:function(a){},renderCharts:function(){var a=this.viewSpec;a.chartSpecs&&this._renderCharts(a.chartSpecs)},_renderCharts:function(a){var b;for(this.charts.length=0,b=0;b<a.length;b++)this.renderChart(a[b])},renderChart:function(a){if(debug.debug("Rendering chart: "+a.name),a.axis&&a.axis.x&&"timeseries"===a.axis.x.type&&a.axis.x.tick){var b=Trillo.getRefByQualifiedName(a.axis.x.tick);b&&(a.axis.x.tick=b)}"pie"===a.type||"donut"===a.type||"gauge"===a.type?this.renderSliceChart(a):this.renderXYChart(a)},renderXYChart:function(a){var b,c,d,e,f=[],g=[],h=Trillo.chartDataFromModelData(a.name,this.modelData()),i=a.xAttr,j=a.yAttrs;for(f.push(i),e=0;e<h.length;e++)h[e][i]&&f.push(h[e][i]);for(g.push(f),e=0;e<j.length;e++){c=j[e],d=c,b=[],b.push(d);for(var k=0;k<h.length;k++)"undefined"!=typeof h[k][c]&&b.push(h[k][c]);g.push(b)}var l={x:i,columns:g,type:a.type,groups:a.groups},m={bindto:"#"+this.viewSpec.elemId+" .chart",data:l,axis:a.axis};this.updateOptions(m,a),m.legend=m.legend||{show:!0},m.transition=m.transition||{duration:0};var n=c3.generate(m);this.setChartElement(a,n)},renderSliceChart:function(a){var b,c,d,e,f,g=[],h=Trillo.chartDataFromModelData(a.name,this.modelData()),i=a.xAttr,j=a.yAttrs;if(j&&0!==j.length){if(i){var k=j[0];for(e=0;e<h.length;e++)f=[],f.push(h[e][i]),f.push(h[e][k]),g.push(f)}else for(d=0;d<j.length;d++){for(b=j[d],c=b,f=[],f.push(c),e=0;e<h.length;e++)"undefined"!=typeof h[e][b]&&f.push(h[e][b]);g.push(f)}var l,m={columns:g,type:a.type};a.label&&(l={label:{format:function(b,c,d){return b+" "+a.label}}});var n={data:m};l&&("pie"===a.type?n.pie=l:"donut"===a.type?n.donut=l:"gauge"===a.type&&(n.gauge=l)),this.updateOptions(n,a);var o=c3.generate(n);this.setChartElement(a,o)}},updateOptions:function(a,b){var c={xAttr:!0,yAttrs:!0,type:!0,displayName:!0,label:!0,groups:!0};$.each(b,function(b,d){c[b]||(a[b]=d)})},setChartElement:function(a,b){var c=$("[nm='"+a.name+"']",this.$e);0===c.length&&(c=$(".js-chart-cell-preview",this.$e)),c.find(".js-chart")[0].appendChild(b.element),a.displayName&&c.find(".js-title").html(a.displayName?a.displayName:""),this.charts.push(b)},createTestData:function(){var a=[],b=new Date;b.setTime(b.getTime()-864e5);for(var c=0;10>c;c++)a.push({timeStamp:b.getTime(),cpuUsage:Math.floor(Math.random()*(c%4===0?20:10))+1,cpuReady:Math.floor(Math.random()*(c%4===0?10:5))+1,cpuMhz:Math.floor(Math.random()*(c%4===0?150:600))+1,memoryMb:Math.floor(Math.random()*(c%4===0?20:100))+1,memorySwapOut:Math.floor(Math.random()*(c%4===0?1:5))+1,memorySwapIn:Math.floor(Math.random()*(c%4===0?1:3))+1,itemName:"Time-"+c}),b.setTime(b.getTime()+18e5);this.model().data={items:a}}}),Trillo.ContentView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c)},doInternalRouting:function(a,b){var c=a.length-b;0>c&&(c=0);for(var d=this.$e,e=Trillo.findAndSelf(d,'[nm="'+this.name+'"]'),f="",g=0;c>g;g++){var h=d.find('[nm="'+a[b+g].name+'"]');h.length>0&&(e=h),f=f+(g>0?"/":"")+a[b+g].name}this.internalRoute=f;var i=this.parentView();if(i&&"toc"===i.viewSpec.type){d.find(".js-pointed").remove();var j=$("<span></span>");j.addClass(Trillo.CSS.pointed+" js-pointed");var k=e.find(":first-child").filter(":header");if(k.length){k=$(k[0]),k.prepend(j);var l=parseInt(k.css("height"),10)/2;j.css("top",l),i.synchWithRouteState(e.dataOrAttr("nm"))}this.scrollIntoView(e)}else c=0;return c},scrollIntoView:function(a){var b=this.$e.offset().top,c=a.offset().top-b;setTimeout(function(){$(window).scrollTop(c)},0)},getNextViewName:function(a){return null}}),Trillo.TocView=Trillo.ViewSelectionView.extend({itemCss:".js-item",initialize:function(a,b,c){this._super(a,b,c),this.viewSelectedMethod=$.proxy(this.viewSelected,this);var d=Trillo.findAndSelf(this.$e,".js-non-native-scrollbar");d.length?this.setNonNativeScrollBar(d):(this.mouseOverHandler=$.proxy(this.onMouseOver,this),this.mouseOutHandler=$.proxy(this.onMouseOut,this),this.delayedOnMouseOut=$.proxy(this._onMouseOut,this))},postShow:function(a){this.mouseOverHandler&&(this.$e.on("mouseover",this.mouseOverHandler),this.$e.on("mouseout",this.mouseOutHandler)),this.updateScrollBar(),this._super(a)},clear:function(){this.mouseOverHandler&&(this.$e.off("mouseover",this.mouseOverHandler),this.$e.off("mouseout",this.mouseOutHandler)),this._super()},getNextViewName:function(a){var b=this.$e.find(".js-item");return b.length>0?this.viewSpec.getNextPath(b.dataOrAttr("nm")):this._super(a)},_getNextViewName:function(){return null},routingToNextView:function(a,b){for(var c=a.length,d=c-1;d>=b&&!this.synchWithRouteState(Trillo.getTriggerFromPath(a[d].name));d--);},viewSelected:function(a){Trillo.hideCurrentOverlays(!0,!0),a&&(a.stopPropagation(),a.preventDefault());var b=$(a.target).closest(this.itemCss),c=b.dataOrAttr("nm");if(this.updateItemSelection(c)){var d=b.parents(this.itemCss);d=d.map(function(){return $(this).dataOrAttr("nm")}).get();var e;d.length?(d=d.reverse(),e=d.join("/")+"/"+c):e=c,this.postViewSelected(e)}this.setContainerVisibility()},clearTimeout:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},onMouseOver:function(){this.clearTimeout(),this.$e.find(".js-toc-container").css("overflow","auto")},onMouseOut:function(){this.clearTimeout(),this.timer=setTimeout(this.delayedOnMouseOut,1e3)},_onMouseOut:function(){this.clearTimeout(),this.$e.find(".js-toc-container").css("overflow","hidden")}}),Trillo.FlexGridView=Trillo.View.extend({initialize:function(a,b,c){this._super(a,b,c)},init2:function(){this.setupView(),this._super()},setupView:function(){var a=this.$e.find(".js-flex-grid");0===a.length?a=this.$e:a.length>1&&(a=$(a[0])),this.$gridElem=a,this.gridSpec={$e:a,id:this.name},this.specs=[],this.$c&&this.$c.append(this.$e),this.lastId=0,this.updateRowSpecs(a,this.specs),this.$iconBar=this.$e.find(".js-flex-grid-iconbar"),this.$minifyIcon=this.$e.find(".js-flex-minified-icon"),this.$minifyIcon.remove(),0===this.$iconBar.children().length&&this.$iconBar.addClass("hide"),this.showHideSpecs=[],this.makeShowHideSpecs(this.specs)},updateRowSpecs:function(a,b){var c,d,e=(this.name,this),f=a.children();f.each(function(){c=$(this),c.hasClass("js-flex-row")&&(d=e.makeRowSpec(c,e.gridSpec,"row"),b.push(d),e.updateRowChildrenSpecs(d))})},updateRowChildrenSpecs:function(a){var b,c,d,e,f=[],g=a.$e.children();if(1!=g.length||(e=$(g[0]),e.hasClass("js-flex-col")||e.hasClass("js-flex-cell"))){var h=this;g.each(function(){b=$(this),c=b.hasClass("js-flex-col")?"col":"cell","col"===c?(d=h.makeColSpec(b,a,c),h.updateColChildrenSpecs(d)):d=h.makeCellSpec(b,a,c),f.push(d)}),a.children=f}},updateColChildrenSpecs:function(a){var b,c,d,e,f=[],g=a.$e.children();if(1!=g.length||(e=$(g[0]),e.hasClass("js-flex-row")||e.hasClass("js-flex-cell"))){var h=this;g.each(function(){b=$(this),d=b.hasClass("js-flex-row")?"row":"cell","row"===d?(c=h.makeRowSpec(b,a,d),h.updateRowChildrenSpecs(c)):c=h.makeCellSpec(b,a,"cell"),f.push(c)}),a.children=f}},makeBaseSpec:function(a,b,c){var d;d=a.dataOrAttr("id"),d||(d=b.id+"."+ ++this.lastId,a.attr("id",d));var e={$e:a,id:d,type:c,flexWidth:!0,flexHeight:!0,parent:b};return e},makeRowSpec:function(a,b,c){var d=this.makeBaseSpec(a,b,c);return this.updateCommonAttributes(d),d},makeColSpec:function(a,b,c){var d=this.makeBaseSpec(a,b,c);return this.updateCommonAttributes(d),d},makeCellSpec:function(a,b,c){var d=this.makeBaseSpec(a,b,c);return this.updateCommonAttributes(d),d},makeShowHideSpecs:function(a){var b,c,d,e=this,f=function(){var a=$(this),b={},c=a.dataOrAttr("show-exp");c&&(b.showExp=e.parseExp(c)),c=a.dataOrAttr("hide-exp"),c&&(b.hideExp=e.parseExp(c)),(b.hideExp||b.showSpec)&&(b.$e=a,e.showHideSpecs.push(b))};for(c=0;c<a.length;c++)b=a[c],b.children&&0!==b.children.length?this.makeShowHideSpecs(b.children):(d=$("[show-exp], [hide-exp]",b.$e),d.each(f))},updateCommonAttributes:function(a){var b,c,d,e=a.$e;this.setMargins(a,e),this.setPaddings(a,e),this.setBordersWidth(a,e),this.setNonContentExtra(a),d=e.dataOrAttr("min-width"),b=d?parseInt(d,10):void 0,Trillo.isNumeric(b)||(b=-1),d=e.dataOrAttr("min-height"),c=d?parseInt(d,10):void 0,Trillo.isNumeric(c)||(c=-1),a.inputMinW=b,a.inputMinH=c,d=e.dataOrAttr("max-width"),b=d?parseInt(d,10):void 0,Trillo.isNumeric(b)||(b=-1),d=e.dataOrAttr("max-height"),c=d?parseInt(d,10):void 0,Trillo.isNumeric(c)||(c=-1),a.inputMaxW=b,a.inputMaxH=c,d=e.dataOrAttr("flex-width"),d&&(d=d.toLowerCase(),a.flexWidth=!("false"===d||"no"===d)),d=e.dataOrAttr("flex-height"),d&&(d=d.toLowerCase(),a.flexHeight=!("false"===d||"no"===d)),d=e.dataOrAttr("show-exp"),d&&(a.showExp=this.parseExp(d)),d=e.dataOrAttr("hide-exp"),d&&(a.hideExp=this.parseExp(d));var f=e.css("position");f=f?f.toLowerCase():"","fixed"!==f&&"absolute"!==f&&(e.width(e.width()),e.height(e.height()),e.css("position","absolute"))},parseExp:function(a){if(!a)return null;var b=a.replace(new RegExp("[0-9]","g"),""),c=a.replace(new RegExp("\\D","g"),"");return{op:$.trim(b),val:parseInt(c,10)}},processShowHideSpecs:function(){for(var a,b,c=Math.max(document.documentElement.clientWidth,window.innerWidth||0),d=0;d<this.showHideSpecs.length;d++)a=this.showHideSpecs[d],b=a.$e.css("display"),a.showExp?this.isTrue(a.showExp,c)?"none"===b&&(a.display="none",a.$e.css("display","")):"none"===a.display&&(a.$e.css("display","none"),a.display=""):a.hideExp&&(this.isTrue(a.hideExp,c)?"none"!==b&&(a.display=a.$e.css("display"),a.$e.css("display","none")):a.display&&(a.$e.css("display",a.display),a.display=null))},makeVisibleList:function(a){var b,c,d=[];for(c=0;c<a.length;c++)b=a[c],this.isDetached(b)||(this.isHidden(b)?b.$e.css("left","-10000px"):((b.showExp||b.hideExp)&&("none"===b.$e.css("display")&&b.$e.css("display",""),"hidden"===b.$e.css("visibility")&&b.$e.css("visibility","visible")),"cell"!==b.type&&b.children&&0!==b.children.length||(b.$e.css({height:""}),b.$e.css({width:""})),b.children?(b.vcl=this.makeVisibleList(b.children),d.push(b)):d.push(b)));return d},isDetached:function(a){return a.parent.$e[0]!==a.$e.parent()[0]},isHidden:function(a){var b=Math.max(document.documentElement.clientWidth,window.innerWidth||0);return a.$e.hasClass("js-container")&&0===a.$e.children().length?!0:(a.showExp?this.isTrue(a.showExp,b)?a.$e.removeClass("trillo-hidden"):a.$e.addClass("trillo-hidden"):a.hideExp&&(this.isTrue(a.hideExp,b)?a.$e.addClass("trillo-hidden"):a.$e.removeClass("trillo-hidden")),a.hidden||"none"===a.$e.css("display")||"hidden"===a.$e.css("visibility")?!0:!1)},isTrue:function(a,b){var c=a.val;switch(a.op){case"<=":return c>=b;case"<":return c>b;case">=":return b>=c;case">":return b>c}return!1},updateWidths:function(a){var b,c;for(c=0;c<a.length;c++)b=a[c],"row"===b.type?this.updateRowWidths(b):"col"===b.type?this.updateColWidths(b):this.updateCellWidths(b)},updateRowWidths:function(a){var b,c,d=a.vcl,e=0,f=0;if(d&&d.length>0)for(this.updateWidths(d),c=0;c<d.length;c++)b=d[c],b.minW>e&&(e=b.minW),f+=b.prefW;else 1===a.$e.children().length&&(e=f=this.getMinWidthFormChild(a));a.inputMinW>=0&&(e=a.inputMinW,e>f&&(f=e)),a.inputMaxW>-0&&f>a.inputMaxW&&(f=a.inputMaxW),a.minW=e+a.hex,a.prefW=f+a.hex},updateColWidths:function(a){var b,c,d=a.vcl,e=0;if(d&&d.length>0)for(this.updateWidths(d),c=0;c<d.length;c++)b=d[c],b.minW>e&&(e=b.minW);else 1===a.$e.children().length&&(e=this.getMinWidthFormChild(a));a.inputMinW>=0&&(e=a.inputMinW),a.minW=a.prefW=e+a.hex},updateCellWidths:function(a){a.inputMinW<0?a.prefW=a.minW=Math.ceil(a.$e[0].getBoundingClientRect().width)+a.lm+a.rm:a.prefW=a.minW=a.inputMinW},updateHeights:function(a){var b,c;for(c=0;c<a.length;c++)b=a[c],"cell"===b.type?b.inputMinH<0?1===b.$e.children().length?b.minH=this.getMinHeightFormChild(b):b.minH=b.$e[0].getBoundingClientRect().height+b.tm+b.bm:b.minH=b.inputMinH:(b.minH=b.inputMinH,(!b.children||0===b.children.length)&&b.inputMinH<0&&1===b.$e.children().length&&(b.minH=this.getMinHeightFormChild(b)),b.vcl&&this.updateHeights(b.vcl))},getMinWidthFormChild:function(a){var b={};return this.setMargins(b,a.$e),Math.ceil(a.$e.children()[0].getBoundingClientRect().width+a.hex+b.lm+b.rm)},getMinHeightFormChild:function(a){var b={};return this.setMargins(b,a.$e),Math.ceil(a.$e.children()[0].getBoundingClientRect().height+a.vex+b.tm+b.bm)},computeRowsWidth:function(a,b){var c,d,e;for(d=0;d<a.length;d++)c=a[d],"row"===c.type&&(e=c.inputMaxW>=0?c.inputMaxW:b,c.w=e,this.computeRowChildrenWidth(c,e-c.hex))},computeRowChildrenWidth:function(a,b){var c,d,e,f=a.vcl,g=[],h={w:0,l:[]},i=0;if(a.subRows=g,f&&0!==a.minW){for(d=0;d<f.length;d++)c=f[d],c.w=c.minW,e=i+c.minW,this.rowLimit(c,i,b)&&h.l.length&&(h.w=i,g.push(h),h={w:0,l:[]},i=0),i+=c.minW,h.l.push(c);for(h.l.length&&(g.push(h),h.w=i),this.distRowExtraToPref(g,b),this.updateOccupancy(g,b)&&this.distRowExtraToPref(g,b),this.distRowExtraToAll(g,b),d=0;d<f.length;d++)c=f[d],"col"===c.type&&this.computeColChildrenWidth(c)}},rowLimit:function(a,b,c){var d=b+a.minW;return d>c},computeColChildrenWidth:function(a){var b,c,d=a.vcl;if(d){var e=a.w-a.hex;for(c=0;c<d.length;c++)b=d[c],b.w=e,"row"===b.type&&(b.vsl?this.computeRowsWidth(b.vcl,e):(b.subRows={w:0,l:[]},b.w=e))}},updateOccupancy:function(a,b){for(var c,d,e,f,g,h,i=!1,j=a.length-1;j>=1;j--)d=a[j-1],d.l.length<=1||(c=a[j],g=b-c.w,h=b-d.w,f=g-h,e=d.l[d.l.length-1],f>e.w&&(d.l.pop(),d.w-=e.w,c.l.unshift(e),c.w+=e.w));return i&&this.updateOccupancy(a,b),i},distRowExtraToPref:function(a,b){for(var c=0;c<a.length;c++)this._distRowExtraToPref(a[c],b)},_distRowExtraToPref:function(a,b){var c,d,e,f=b-a.w,g=0,h=a.l;if(!(0>=f)){for(d=0;d<h.length;d++)c=h[d],c.w<c.prefW&&(g+=c.prefW-c.w);if(0!==g)for(d=0;d<h.length;d++)c=h[d],c.w<c.prefW&&(e=f*(c.prefW-c.w)/g,e>c.prefW-c.w&&(e=c.prefW-c.w),c.w+=e,a.w+=e)}},distRowExtraToAll:function(a,b){for(var c=0;c<a.length;c++)this._distRowExtraToAll(a[c],b)},_distRowExtraToAll:function(a,b){var c,d,e,f=b-a.w,g=0,h=a.l;if(!(0>=f||0===h.length)){for(d=0;d<h.length;d++)c=h[d],this.updateWidthWeight(c),g+=c.ww;if(0!==g){var i=f;for(d=0;d<h.length;d++)c=h[d],e=f*c.ww/g,c.inputMaxW>=0&&c.w+e>c.inputMaxW&&(e=c.inputMaxW-c.w),c.w+=e,a.w+=e,i-=e;Math.floor(i)>1&&i!==f&&this._distRowExtraToAll(a,b)}}},updateWidthWeight:function(a){!a.flexWidth||a.inputMaxW>=0&&a.w>=a.inputMaxW?a.ww=0:a.ww=a.w},setNewWidth:function(a){var b,c;for(c=0;c<a.length;c++)b=a[c],b.$e.outerWidth(Math.round(b.w)-b.lm-b.rm),b.vcl&&this.setNewWidth(b.vcl)},computeRowsHeight:function(a){var b;for(b=0;b<a.length;b++)this.computeRowHeight(a[b])},computeRowHeight:function(a){var b,c;for(c=0,b=0;b<a.subRows.length;b++)this._computeRowHeight(a.subRows[b]),c+=a.subRows[b].h;a.inputMinH>c&&(c=a.inputMinH),a.h=c+a.vex},_computeRowHeight:function(a){var b,c,d=a.l,e=0;for(c=0;c<d.length;c++)b=d[c],"col"===b.type?this.computeColHeight(b):b.h=b.minH,e<b.h&&(e=b.h);for(c=0;c<d.length;c++)b=d[c],"col"===b.type&&b.h<e&&this.distColExtraToAll(b.vcl,b.h-b.vex,e),b.h=e;a.h=e},incrRowHeight:function(a,b){var c,d;for(d=0,c=0;c<a.subRows.length;c++)d+=a.subRows[c].h;for(c=0;c<a.subRows.length;c++)this._incrRowHeight(a.subRows[c],a.subRows[c].h*b/d);a.h+=b},_incrRowHeight:function(a,b){var c,d,e=a.l;for(d=0;d<e.length;d++)c=e[d],"col"===c.type?this.incrColHeight(c,b):c.h+=b;a.h+=b},incrColHeight:function(a,b){this.distColExtraToAll(a.vcl,a.h-a.vex,a.h+b),a.h+=b},computeColHeight:function(a){var b,c,d=a.vcl,e=0;if(!d||0===d.length)return void(a.h=a.minH>=0?a.minH:0);for(c=0;c<d.length;c++)b=d[c],"row"===b.type?this.computeRowHeight(b):b.h=b.minH,e+=b.h;a.inputMinH>e&&(e=a.inputMinH),a.h=e+a.vex},distColExtraToAll:function(a,b,c){var d,e,f,g=c-b;if(!(0>=g)&&a&&0!==a.length){for(e=0;e<a.length;e++)this.updateHeightWeight(a[e]);var h=b,i=g;for(e=0;e<a.length;e++)d=a[e],f=g*d.wh/h,d.inputMaxH>=0&&d.h+f>d.inputMaxH&&(f=d.inputMaxH-d.h),f>0&&(b+=f,i-=f,"row"==d.type?this.incrRowHeight(d,f):"col"==d.type?this.incrColHeight(d,f):d.h+=f);Math.floor(i)>1&&i!==g&&this.distColExtraToAll(a,b,c)}},updateHeightWeight:function(a){!a.flexHeight||a.inputMaxH>=0&&a.h>=a.inputMaxH?a.wh=0:a.wh=a.h},positionRows:function(a){var b,c,d=this.gridSpec,e=d.lp+d.lbw,f=d.tp+d.tbw;for(b=0;b<a.length;b++)c=a[b],c.left=e,c.top=f,this.positionRow(c),f+=c.h},positionRow:function(a){var b,c,d,e,f,g,h=a.subRows,i=a.tp+a.tbw;for(b=0;b<h.length;b++){for(d=h[b],f=d.l,e=a.lp+a.lbw,c=0;c<f.length;c++)g=f[c],g.top=i,g.left=e,e+=g.w,g.vcl&&this.positionChildren(g);i+=d.h}},positionCol:function(a){var b,c,d=a.vcl,e=a.tp+a.tbw;if(d)for(c=0;c<d.length;c++)b=d[c],b.left=a.lp+a.lbw,b.top=e,e+=b.h,b.vcl&&this.positionChildren(b)},positionChildren:function(a){"row"===a.type?this.positionRow(a):"col"===a.type&&this.positionCol(a)},computeGeometry:function(){this.processShowHideSpecs();var a=this.$gridElem,b=this.makeVisibleList(this.specs),c=this.gridSpec;this.setPaddings(c,a),this.setMargins(c,a),this.setBordersWidth(c,a),this.setNonContentExtra(c),this.updateWidths(b),this.computeRowsWidth(b,a.width()),this.setNewWidth(b),this.updateHeights(b),this.computeRowsHeight(b);for(var d=0,e=0;e<b.length;e++)d+=b[e].h;if(d=Math.floor(d),"page"===this.viewSpec.type){var f=$(window).height()-a.offset().top,g=a.parent().height()-c.vex;g>f&&(g=f),g>d&&(this.distColExtraToAll(b,d,g),d=g)}return a.height(d),this.positionRows(b),b},_renderFromSpecs:function(a){var b,c,d,e,f,g,h,i;for(d=0;d<a.length;d++)b=a[d],c=b.$e,e=Math.round(b.left),f=Math.round(b.top),g=Math.round(b.w),h=Math.round(b.h),"fixed"===c.css("position")?(i=c.parent().offset(),e+=i.left,f+=i.top):c.css({position:"absolute"}),c.css({left:e+"px",top:f+"px"}),c.outerWidth(g-b.lm-b.rm),c.outerHeight(h-b.tm-b.bm),b.vcl&&this._renderFromSpecs(b.vcl)},_clipFixedElementHeight:function(a){var b,c,d,e,f,g;for(d=0;d<a.length;d++)b=a[d],c=b.$e,"fixed"===c.css("position")&&(f=Math.round(b.h),g=c.parent().offset(),e=Math.round(b.top)+g.top,e+f>$(window).height()&&(f=$(window).height()-e,c.outerHeight(f-b.tm-b.bm))),b.vcl&&this._clipFixedElementHeight(b.vcl)},render:function(){var a=(new Date).getTime(),b=this.$gridElem,c=this.computeGeometry();"static"===b.css("position")&&b.css({position:"relative"}),this._renderFromSpecs(c),this._clipFixedElementHeight(c);var d=(new Date).getTime();this._super(),console.log("Total rendering time: "+(d-a))},renderData:function(a){},minifyContent:function(a){var b=this.specById(a);b&&(b.hidden=!0,b.top=0,b.left=0,b.w=0,b.h=0,b.$e.addClass("hide"),this.addMinifyIcon(b),this.windowResized())},specById:function(a){return this._specById(this.specs,a);
},_specById:function(a,b){for(var c,d=0;d<a.length;d++){if(c=a[d],c.id===b)return c;if(c.children&&(c=this._specById(c.children,b)))return c}return null},addMinifyIcon:function(a){this.$iconBar.removeClass("hide");var b=this.$minifyIcon.clone(!0);b.attr("id",a.id),b.attr("title",a.id),this.$iconBar.append(b),b.on("click",$.proxy(this.unminifyContent,this))},unminifyContent:function(a){a.stopPropagation(),a.preventDefault();var b=$(a.target),c=b.dataOrAttr("id"),d=this.specById(c);d&&(d.hidden=!1,d.$e.removeClass("hide"),b.remove(),this.windowResized()),0===this.$iconBar.children().length&&this.$iconBar.addClass("hide")},windowResized:function(){this.cleared||(this.render(),this._super())},setMargins:function(a,b){a.lm=parseInt(b.css("margin-left"),10),a.rm=parseInt(b.css("margin-right"),10),a.tm=parseInt(b.css("margin-top"),10),a.bm=parseInt(b.css("margin-bottom"),10)},setPaddings:function(a,b){a.lp=parseInt(b.css("padding-left"),10),a.rp=parseInt(b.css("padding-right"),10),a.tp=parseInt(b.css("padding-top"),10),a.bp=parseInt(b.css("padding-bottom"),10)},setBordersWidth:function(a,b){a.lbw=parseInt(b.css("border-left-width"),10),a.rbw=parseInt(b.css("border-right-width"),10),a.tbw=parseInt(b.css("border-top-width"),10),a.bbw=parseInt(b.css("border-bottom-width"),10)},setNonContentExtra:function(a){a.hex=a.lm+a.lp+a.lbw+a.rm+a.rp+a.rbw,a.vex=a.tm+a.tp+a.tbw+a.bm+a.bp+a.bbw},layoutContainers2:function(){this.cleared||(this.render(),this._super())}}),Trillo.DashboardView=Trillo.FlexGridView.extend({initialize:function(a,b,c){this._super(a,b,c)}}),Trillo.DashboardController=Trillo.Controller.extend({initialize:function(a){this._super(a)},handleAction:function(a,b,c,d){return"minify"===a?(this.minifyView(c),!0):this._super(a,b)},minifyView:function(a){var b=a.closest(".js-flex-cell");this._view.minifyContent&&this._view.minifyContent(b.attr("id"))}}),Trillo.FileUploadC=Trillo.Controller.extend({allowedFileTypes:["jpg","png","gif"],initialize:function(a){this._super(a),this.allowedFileTypes=a.params.allowedFileTypes||this.allowedFileTypes},postViewShown:function(){var a=this.$elem(),b=this.viewSpec.params||{};this.$fileNameE=a.find('[nm="fileName"]'),this.$file=a.find('[nm="file"]'),this.$file.on("change",$.proxy(this.fileSelected,this)),a.find('[nm="uploadFile"]').on("click",$.proxy(this.uploadFile,this)),a.find("form").attr("action",b.uploadUrl),$.each(b,function(b,c){a.find('[nm="'+b+'"]').val(c)}),this.fileDDH||(this.fileDDH=new Trillo.FileDragDropHandler({parent:this,$dde:a.find(".js-file-drag-drop"),$pb:a.find(".js-progress-bar"),folder:a.find('[nm="folder"]').val(),className:a.find('[nm="className"]').val(),targetViewName:a.find('[nm="targetViewName"]').val(),url:this.viewSpec.params.uploadUrl}))},fileSelected:function(){var a=this.$file.val(),b=a.split(".").pop(),c=this.allowedFileTypes.indexOf(b.toLowerCase())<0;this.$fileNameE.val(c?"":a),c?this.showFileUploadError("Unsupported File Type","Only '"+this.allowedFileTypes.join()+"' files are allowed."):this.clearFileUploadError()},uploadFile:function(a){return a&&(a.stopPropagation(),a.preventDefault()),""===$.trim(this.$fileNameE.val())?void this.showFileUploadError("Missing File","Please choose a file from your computer to upload."):(this.clearFileUploadError(),Trillo.fileUploadForm=this,void this.$elem().find("form")[0].submit())},uploadFileCompletedViaXHR:function(a){var b=this.viewByName(a.targetViewName);a.__viaxhr=!0,b&&b.controller().fileUploadSuccessful(a)},postShow:function(){Trillo.alert.clear()}}),Trillo.FileDragDropHandler=Class.extend({initialize:function(a){this.parent=a.parent,this.url=a.url,this.$pb=a.$pb,this.folder=a.folder,this.className=a.className,this.targetViewName=a.targetViewName;var b=this.$dde=a.$dde,c=$.proxy(this.noop,this);b.on("dragenter",c,!1),b.on("dragexit",c,!1),b.on("dragover",c,!1),b.on("drop",$.proxy(this.dropUpload,this))},noop:function(a){a.stopPropagation(),a.preventDefault()},dropUpload:function(a){this.noop(a),this.$pb.addClass("trillo-upload-pb-notransition"),this.$pb.width("0%");var b=a.originalEvent.dataTransfer.files,c=this;setTimeout(function(){c.$pb.removeClass("trillo-upload-pb-notransition");for(var a=0;a<b.length;a++)c.upload(b[a])},100)},upload:function(a){var b={"image/png":!0,"image/jpeg":!0,"image/gif":!0};if(!b[a.type])return void this.parent.showFileUploadError("Unsupported File Type","Only '"+this.parent.allowedFileTypes.join()+"' files are allowed.");this.parent.clearFileUploadError(),this.$pb.parent().css("visibility","visible"),this.$pb.css("visibility","visible");var c=new FormData;c.append("xhr","1"),c.append("file",a),c.append("folder",this.folder),c.append("className",this.className),c.append("targetViewName",this.targetViewName);var d=new XMLHttpRequest;d.upload.addEventListener("progress",$.proxy(this.uploadProgress,this),!1),d.addEventListener("load",$.proxy(this.uploadComplete,this),!1),d.open("POST",this.url,!0),d.send(c)},uploadProgress:function(a){var b=Math.round(a.loaded/a.total*100);this.$pb.width(b+"%")},uploadComplete:function(a){var b=$.parseJSON(a.target.responseText);b.error?(this.$pb.width("0%"),this.parent.fileUploadFailed(b)):(this.$pb.width("100%"),this.parent.uploadFileCompletedViaXHR(b))}}),Trillo.makeDependencyList=function(a){function b(a){for(var b=a.slice(0),c=[],e=0;;){for(var f,g=b[e],h=!1,i=0;i<b.length;i++)if(f=b[i],g!==f&&d(g.id,f)){h=!0;break}if(h){if(h&&e===b.length-1)return c;e++}else if(c.push(g),b.splice(e,1),e=0,0===b.length)return c}}function c(a){return a?(a=a.replace(/\s/g,""),a.split(",")):[]}function d(a,b){return b.top.indexOf(a)>=0?!0:b.bottom.indexOf(a)>=0?!0:b.left.indexOf(a)>=0?!0:b.right.indexOf(a)>=0?!0:void 0}if(a){for(var e=0;e<a.length;e++){var f=a[e];f.top=c(f.top),f.bottom=c(f.bottom),f.left=c(f.left),f.right=c(f.right),f.pTop=0,f.pLeft=0}return b(a)}},Trillo.positionContainers=function(a){function b(a){for(var b,c,d=0;d<a.length;d++)c=a[d],b=$("#"+c.id),0!==b.length&&(g(b,c,a),h(b,c,a),i(b,c,a),j(b,c,a))}function c(a){return"hidden"===a.css("visibility")||"none"===a.css("display")||a.hasClass("js-overlaid")?0:a.outerHeight(!0)}function d(a){return"hidden"===a.css("visibility")||"none"===a.css("display")||a.hasClass("js-overlaid")?0:a.outerWidth(!0)}function e(a,b,c){for(var d,e=0;e<c.length;e++)d=c[e],d.id===a&&(d.pTop=b)}function f(a,b,c){for(var d,e=0;e<c.length;e++)d=c[e],d.id===a&&(d.pLeft=b)}function g(a,b,d){if(b.top.length)for(var f,g=(a.position(),b.pTop+c(a)),h=0;h<b.top.length;h++)e(b.top[h],g,d),f=$("#"+b.top[h]),f.css("fixed"==f.css("position")?"top":"padding-top",g+"px")}function h(a,b,c){if(b.bottom.length)for(var d,e=a.height(),f=0;f<b.bottom.length;f++)d=$("#"+b.bottom[f]),d.css("fixed"==d.css("position")?"bottom":"padding-bottom",e+"px")}function i(a,b,c){if(b.left.length)for(var e,g=(a.position(),b.pLeft+d(a)),h=0;h<b.left.length;h++)f(b.left[h],g,c),e=$("#"+b.left[h]),e.css("fixed"==e.css("position")?"left":"padding-left",g+"px")}function j(a,b,c){if(b.right.length)for(var d,e=a.width(),f=0;f<b.right.length;f++)d=$("#"+b.right[f]),d.css("fixed"==d.css("position")?"right":"padding-right",e+"px")}null!==a&&b(a)},Trillo.Popover=Class.extend({initialize:function(a){this.options=a,this.clickM=$.proxy(this.clicked,this),this.clickOutsideM=$.proxy(this.clickedOutside,this),this.setup(a),this.targetInfo={},this.contentInfo={}},setup:function(a){var b,c,d;c=this.$target=a.$target&&a.$target.length?a.$target:null,d=this.$content=a.$content&&a.$content.length?a.$content:null,this.$target||(c=this.$target=this.$content,d=this.$content=null),c&&(b=this.$trigger=a.$trigger,b.on("click",this.clickM),this.contentClass=this._getAttr(b,c,d,"popover-class"),this.hOffset=this._getNumericAttr(b,c,d,"h-offset"),this.vOffset=this._getNumericAttr(b,c,d,"v-offset"),this.alignment=this.getAlignment(this._getAttr(b,c,d,"alignment")),this.$anchor=c.find(".js-popover-anchor"),0===this.$anchor.length&&(this.$anchor=null),this.anchorHOffset=this._getNumericAttr(b,c,d,"anchor-h-offset"),this.anchorVOffset=this._getNumericAttr(b,c,d,"anchor-v-offset"),this.$close=c.find(".js-popover-close"),this.$close.length&&(this.closeClickM=$.proxy(this.closeClicked,this),this.$close.on("click",this.closeClickM)),this.$contentNext=null)},clear:function(){this.$trigger.off("click",this.clickM),this.closeClickM&&this.$close.off("click",this.closeClickM),$(document).off("click",this.clickOutsideM)},clicked:function(){this.isHidden()?this._show():this._hide()},clickedOutside:function(a){$.contains(this.$target[0],a.target)||this.hide()},closeClicked:function(){this.hide()},show:function(){this.isHidden()&&this._show()},hide:function(){this.isHidden()||this._hide()},_show:function(){if(this.$target){Trillo.popoverManager.hideCurrentPopup(),Trillo.popoverManager.currentPopup=this;var a=this.$trigger,b=this.$target,c=this.$content,d=this.$anchor,e=this.alignment;if(c&&(this.$oldParent=c.parent(),this.$contentNext=c.next(),this.contentClass&&c.addClass(this.contentClass),b.append(c)),this.saveStylesInfo(b,this.targetInfo),this.targetInfo.hasHideClass?b.removeClass("hide"):"none"===this.targetInfo.displayStyle&&b.show(),"hidden"===this.targetInfo.visibilityStyle&&b.css("visibility","visible"),this.targetInfo.hasTrilloHiddenClass&&b.removeClass("trillo-hidden"),c&&(this.saveStylesInfo(c,this.contentInfo),this.contentInfo.hasTrilloHiddenClass&&c.removeClass("trillo-hidden")),e){var f=this.getPosition(a,b,e,this.hOffset,this.vOffset);if(b.offset(f),d){var g=this.getPosition(a,d,e,this.anchorHOffset,this.anchorVOffset);this.adjustPos(b,d,f,g,e),d.css({left:g.left+"px",top:g.top+"px"}),b.offset(f)}}var h=this;setTimeout(function(){$(document).on("click",h.clickOutsideM)},0)}},adjustPos:function(a,b,c,d,e){var f=(a.outerWidth(),a.outerHeight()),g=(b.outerWidth(),b.outerHeight());"t"===e.v?(c.top-=g,d.top=f+g,d.left-=c.left):("b"===e.v||"m"===e.v)&&(c.top+=g,d.top=-g,d.left-=c.left)},_hide:function(){if(this.$target){var a=this.$content;if(this.$oldParent){var b=this.$contentNext;b&&b.length?a.insertBefore(b):this.$oldParent.append(a)}a&&this.contentClass&&a.removeClass(this.contentClass),this.restoreStylesInfo(this.$target,this.targetInfo),a&&this.contentInfo.hasTrilloHiddenClass&&a.addClass("trillo-hidden"),$(document).off("click",this.clickOutsideM)}},getPosition:function(a,b,c,d,e){var f=a.offset(),g=a.outerWidth(),h=a.outerHeight(),i=b.outerWidth(),j=b.outerHeight(),k=$(window).width();$(window).height();console.log(f,g,h,i,j);var l=f.top,m=f.left;return"r"===c.h?m+=g-i:"c"===c.h?m+=(g-i)/2:"r"===c.v?m+=g:"l"===c.v&&(m-=i),"t"===c.v?l-=b.outerHeight():"b"===c.v?l+=h:"m"===c.v?l+=h/2:"b"===c.h?l+=h:"m"===c.h&&(l+=(h-j)/2),("r"===c.h||"l"===c.h||"c"===c.h)&&(m+i>k&&(m-=k-(m-i)),0>m&&(m=0)),m+=d,l+=e,{left:m,top:l}},getAlignment:function(a){if(a=a?a.toLowerCase():"b-c","none"===a)return null;var b=a.split("-");return{v:b[0]?b[0]:"b",h:b[1]?b[1]:"c"}},isHidden:function(){var a=this.$target;if(!a.is(":visible"))return!0;var b=a.offset();return b.left+a.outerWidth()<0||b.top+a.outerHeight()<0},saveStylesInfo:function(a,b){b.hasHideClass=a.hasClass("hide"),b.displayStyle=a.css("display"),b.visibilityStyle=a.css("visibility"),b.hasTrilloHiddenClass=a.hasClass("trillo-hidden"),b.offset=a.offset()},restoreStylesInfo:function(a,b){b.hasHideClass?a.addClass("hide"):"none"===b.displayStyle&&a.css("display","none"),"hidden"===b.visibilityStyle&&a.css("visibility","hidden"),b.hasTrilloHiddenClass&&a.addClass("trillo-hidden"),this.alignment&&b.offset&&a.css({left:b.offset.left+"px",top:b.offset.top+"px"})},_getAttr:function(a,b,c,d){var e;return c&&(e=c.dataOrAttr(d))?e:(e=b.dataOrAttr(d),e?e:a.dataOrAttr(d))},_getNumericAttr:function(a,b,c,d){var e=parseInt(this._getAttr(a,b,c,d),10);return Trillo.isNumeric(e)||(e=0),e}}),Trillo.PopoverManager=Class.extend({initialize:function(){this.currentPopup=null,this.popovers=[]},createPopoverForContent:function(a){var b=a.dataOrAttr("trigger");return b?this.createPopoverForTrigger($(b),a):null},createPopoverForTrigger:function(a,b){var c=a.dataOrAttr("target"),d=c?$(c):null;if(!b){var e=a.dataOrAttr("content");b=e?$(e):null}return!d&&b&&(c=b.dataOrAttr("target"),d=c?$(c):null),d||b?this._createPopover(a,d,b):null},_createPopover:function(a,b,c){var d=new Trillo.Popover({$trigger:a,$target:b,$content:c});return this.popovers.push(d),d},showPopup:function(a){this.currentPopup=a,a.show()},hideCurrentPopup:function(){this.currentPopup&&this.currentPopup.hide()},getPopoverForTrigger:function(a){for(var b=0;b<this.popovers.length;b++)if(this.popovers[b].$trigger[0]===a[0])return this.popovers[b]},getPopoverForContent:function(a){for(var b=0;b<this.popovers.length;b++)if(this.popovers[b].$content){if(this.popovers[b].$content[0]===a[0])return this.popovers[b]}else if(this.popovers[b].$target&&this.popovers[b].$target[0]===a[0])return this.popovers[b];return null},hasContent:function(a){var b=this.getPopoverForTrigger(a);if(b){var c=b.$content||b.$target;if(c&&c.children(":visible").length>0)return!0}return!1},contentCleared:function(a){var b=this.getPopoverForContent(a);b&&b.$trigger.addClass("trillo-trigger-has-no-content")},contentShown:function(a){var b=this.getPopoverForContent(a);b&&b.$trigger.removeClass("trillo-trigger-has-no-content")},hideCurrentPopupIfContains:function(a){this.currentPopup&&$.contains(this.currentPopup.$target[0],a[0])&&this.hideCurrentPopup()}}),Trillo.MultiViewDelegator=Class.extend({initialize:function(a){this.options=a,this.tblByTarget={},this.sourceViews={}},manage:function(a,b){var c,d,e,f=this,g=this.tblByTarget,h={},i=b.name;this.unManage(i),Trillo.belongsToView(a,i)&&(a.data("for-view",i),this.sourceViews[i]=a,a.find("[target-view], [data-target-view]").each(function(){c=$(this).dataOrAttr("target-view"),d=g[c],d||(g[c]=d=[]),d.push({e:this,source:i}),h[c]||(h[c]=!0)}),$.each(h,function(a,c){e=b.controller().viewByName(a),e&&e.applyExternalElements(f.getByTarget(a))}))},unManage:function(a){if(this.sourceViews[a]){var b,c,d=this.tblByTarget;$.each(d,function(e,f){for(b=[],c=0;c<f.length;c++)f[c].source!==a&&b.push(f[c]);d[e]=b})}},getByTarget:function(a){return this.tblByTarget[a]}});