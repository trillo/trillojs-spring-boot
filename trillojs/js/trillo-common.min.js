/*!
 * TrilloJS v0.5.0 (https://github.com/trillo/trillojs#readme)
 * Copyright 2016 Collager Inc.
 * Licensed under the MIT license
 */
Trillo.EntityModel=Trillo.Model.extend({initialize:function(a,b){this._super(a,b),this.table={}},getObserverOptions:function(){return this.data&&this.data.uid?{cls:Trillo.uidToClass(this.data.uid)}:null},loadData:function(){var a,b=$.Deferred();if(this.data)return b.resolve(this),b.promise();var c=this.modelSpec.params.uid;if(!c)return Trillo.log.warning("Entity model does not specify object uid which is required to retrieve uid, returning empty data"),this.data={},b.resolve(this),b.promise();if(this.modelSpec.detailClass){a=$.Deferred(),$.ajax({url:"/service/entity?uid="+c,type:"get"}).done(function(b){a.resolve(b)});var d=$.Deferred();$.ajax({url:"/service/entityDetail?uid="+this.modelSpec.detailClass+"."+Trillo.uidToId(c),type:"get"}).done(function(a){d.resolve(a)}),$.when(a.promise(),d.promise()).done($.proxy(this.dataLoaded,this,b))}else a=$.Deferred(),$.ajax({url:"/service/entity?uid="+c,type:"get"}).done(function(b){a.resolve(b)}),a.promise().done($.proxy(this.dataLoaded,this,b));return b.promise()},dataLoaded:function(a,b,c){this.createObserver(),this.table[b.uid]=b,this.data=$.extend(b,c),this.controller().modelLoaded(this),a.resolve(this)}}),Trillo.CollectionModel=Trillo.Model.extend({initialize:function(a,b){this._super(a,b),this.setPageRquest(a)},setPageRquest:function(a){this.table={};var b={};b.cls=this.modelSpec.cls,b.filter=a.filter||"",b.searchFilter=a.searchFilter,b.searchPhrase=a.searchPhrase||"",b.orderBy=a.orderBy||"",b.pageSize=a.pageSize||32,b.assocName=a.assocName,this.pageRequest=b},getObserverOptions:function(){return{cls:this.pageRequest.cls}},loadData:function(a){var b=$.Deferred();return this.data&&"undefined"==typeof a?(b.resolve(this),b.promise()):(a="undefined"==typeof a?1:a,this.pageRequest.pageNumber=a,this.pageRequest.assocUid=this.modelSpec.params.assocUid,$.ajax({url:"/service/page",type:"post",data:Trillo.stringify(this.pageRequest),contentType:"application/json",datatype:"application/json"}).done($.proxy(this.dataLoaded,this,b)).fail(function(){b.reject({errorMsg:"Failed to load model"})}),b.promise())},dataLoaded:function(a,b){return this.createObserver(),b.items?void this.paginatedDataLoaded(a,b):(this.data=b,this.updateTable(b),this.controller().modelLoaded(this),void a.resolve(this))},paginatedDataLoaded:function(a,b){if(this.updateTable(b.items),this.data){var c=this.data;c.items=c.items.concat(b.items),c.pageSize=b.pageSize,c.numberOfPages=b.numberOfPages,c.totalNumberOfItems=b.totalNumberOfItems,c.pageNumber=b.pageNumber}else this.data=b;this.controller().modelLoaded(this),a.resolve(this)},updateTable:function(a){if(a&&"undefined"!=typeof a.length)for(var b,c=a,d=c.length,e=this.table,f=0;d>f;f++)b=c[f],e[b.uid]=b},processObjAdded:function(a){this.table[a.uid]=a;var b=this.data,c=b.items||b;c&&(this.newItemsAtEnd?c.push(a):c.unshift(a),b.items&&"undefined"!=typeof b.totalNumberOfItems&&(b.totalNumberOfItems+=1,b.numberOfPages=Math.ceil(b.totalNumberOfItems/b.pageSize)))},getObj:function(a){return this.table[a]},setOrderBy:function(a){this.pageRequest.orderBy=a}}),Trillo.TreeModel=Trillo.Model.extend({initialize:function(a,b){this._super(a,b)},loadData:function(){var a=$.Deferred();if(this.data)return a.resolve(this),a.promise();var b=this.modelSpec.params.uid,c=this.modelSpec.params.assocUid;return $.ajax({url:"/service/tree?"+(b?"uid="+b:"name="+this.modelSpec.viewName+(c?"&assocUid="+c:"")),type:"get"}).done($.proxy(this.dataLoaded,this,a)),a.promise()},getObserverOptions:function(){return this.data&&this.data.uid?{uid:this.data.uid}:{cls:"Tree"}},dataLoaded:function(a,b){this._treeLoaded(b),a.resolve(this)},treeLoaded2:function(a){this._treeLoaded(a),this.view().objChanged(a)},_treeLoaded:function(a){this.data=a,this.controller().modelLoaded(this),this.createObserver()},receivedNotifications:function(a){if(this.data.uid===a.uid)this.data=a,this.view().objChanged(a);else if(this.data.name===a.name){this.clearObserver();var b=this.modelSpec.params.assocUid;$.ajax({url:"/service/tree?name="+this.modelSpec.viewName+(b?"&assocUid="+b:""),type:"get"}).done($.proxy(this.treeLoaded2,this))}}}),Trillo.ServiceModel=Trillo.Model.extend({initialize:function(a,b){if(this._super(a,b),this.serviceUrl=a.serviceUrl,a.paramNames){for(var c=a.paramNames.split(","),d=0;d<c.length;d++)c[d]=$.trim(c[d]);this.paramNames=c}else this.paramNames=[];this.params=a.params},isModelChanged:function(a){return this.getFullUrl(this.params)!==this.getFullUrl(a.params)||a.data&&a.data!==this.data||a._newData},loadData:function(){var a=$.Deferred();return this.data?(a.resolve(this),a.promise()):($.ajax({url:this.getFullUrl(this.params),type:"get"}).done($.proxy(this.dataLoaded,this,a)),a.promise())},dataLoaded:function(a,b){this.data=b,this.createObserver(),this.controller().modelLoaded(this),a.resolve(this)},getFullUrl:function(a){var b=this.serviceUrl;if(this.paramNames.length&&a){for(var c="",d=0;d<this.paramNames.length;d++){var e=this.paramNames[d];"undefined"!=typeof a[e]&&(c=(c.length>0?"&":"?")+e+"="+a[e])}b+=c}return b}});